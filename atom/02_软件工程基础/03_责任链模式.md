# è´£ä»»é“¾æ¨¡å¼ (Chain of Responsibility Pattern)

> åŸå­åŒ–çŸ¥è¯†ç‚¹ | è½¯ä»¶å·¥ç¨‹åŸºç¡€ | LangChain æºç å­¦ä¹ å‰ç½®çŸ¥è¯†

---

## 1. ã€30å­—æ ¸å¿ƒã€‘

**è´£ä»»é“¾æ¨¡å¼å°†è¯·æ±‚æ²¿å¤„ç†é“¾ä¼ é€’ï¼Œç›´åˆ°æœ‰å¤„ç†è€…å“åº”ï¼Œæ˜¯ LangChain Callback å›è°ƒç³»ç»Ÿå’Œä¸­é—´ä»¶æ¶æ„çš„æ ¸å¿ƒæœºåˆ¶ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### è´£ä»»é“¾æ¨¡å¼çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**è´£ä»»é“¾æ¨¡å¼ = è¯·æ±‚ä¼ é€’ + é“¾å¼å¤„ç†**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

- **è¯·æ±‚ä¼ é€’**ï¼šè¯·æ±‚ä»ä¸€ä¸ªå¤„ç†è€…ä¼ åˆ°ä¸‹ä¸€ä¸ªå¤„ç†è€…
- **é“¾å¼å¤„ç†**ï¼šå¤„ç†è€…å½¢æˆä¸€æ¡é“¾ï¼Œä¾æ¬¡æœ‰æœºä¼šå¤„ç†è¯·æ±‚
- **è§£è€¦å‘é€è€…**ï¼šå‘é€è€…ä¸éœ€è¦çŸ¥é“è°ä¼šå¤„ç†è¯·æ±‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦è´£ä»»é“¾æ¨¡å¼ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•è®©å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œè€Œä¸éœ€è¦å‘é€è€…æ˜¾å¼æŒ‡å®šæ¥æ”¶è€…ï¼Ÿ**

```python
# æ²¡æœ‰è´£ä»»é“¾æ¨¡å¼ï¼šå‘é€è€…å¿…é¡»çŸ¥é“æ‰€æœ‰æ¥æ”¶è€…
class RequestProcessor:
    def process(self, request: dict) -> str:
        request_type = request.get("type")

        if request_type == "auth":
            return self._handle_auth(request)
        elif request_type == "validation":
            return self._handle_validation(request)
        elif request_type == "logging":
            return self._handle_logging(request)
        elif request_type == "business":
            return self._handle_business(request)
        else:
            return "Unknown request type"

    def _handle_auth(self, request):
        # è®¤è¯é€»è¾‘
        pass

    def _handle_validation(self, request):
        # éªŒè¯é€»è¾‘
        pass

    # ... æ›´å¤šå¤„ç†æ–¹æ³•

# é—®é¢˜ï¼š
# 1. å‘é€è€…å¿…é¡»çŸ¥é“æ‰€æœ‰å¯èƒ½çš„å¤„ç†è€…
# 2. æ–°å¢å¤„ç†ç±»å‹è¦ä¿®æ”¹ä¸»ç±»
# 3. å¤„ç†é¡ºåºç¡¬ç¼–ç ï¼Œæ— æ³•åŠ¨æ€è°ƒæ•´
# 4. è¿åå•ä¸€èŒè´£åŸåˆ™ï¼ˆä¸€ä¸ªç±»æ‰¿æ‹…å¤ªå¤šå¤„ç†é€»è¾‘ï¼‰
# 5. æ— æ³•è®©è¯·æ±‚"æµè¿‡"å¤šä¸ªå¤„ç†è€…
```

```python
# ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ï¼šè¯·æ±‚æ²¿é“¾ä¼ é€’ï¼Œå¤„ç†è€…è§£è€¦
from abc import ABC, abstractmethod
from typing import Optional, Any

# å¤„ç†è€…æŠ½è±¡
class Handler(ABC):
    def __init__(self):
        self._next_handler: Optional[Handler] = None

    def set_next(self, handler: "Handler") -> "Handler":
        """è®¾ç½®ä¸‹ä¸€ä¸ªå¤„ç†è€…ï¼Œè¿”å›ä¸‹ä¸€ä¸ªå¤„ç†è€…ä»¥æ”¯æŒé“¾å¼è°ƒç”¨"""
        self._next_handler = handler
        return handler

    def handle(self, request: dict) -> Optional[str]:
        """å¤„ç†è¯·æ±‚ï¼Œå¯ä»¥å¤„ç†æˆ–ä¼ é€’ç»™ä¸‹ä¸€ä¸ª"""
        result = self._do_handle(request)
        if result is not None:
            return result
        if self._next_handler:
            return self._next_handler.handle(request)
        return None

    @abstractmethod
    def _do_handle(self, request: dict) -> Optional[str]:
        """å­ç±»å®ç°å…·ä½“å¤„ç†é€»è¾‘"""
        pass

# å…·ä½“å¤„ç†è€…
class AuthHandler(Handler):
    def _do_handle(self, request: dict) -> Optional[str]:
        if request.get("type") == "auth":
            return f"AuthHandler processed: {request}"
        return None  # æ— æ³•å¤„ç†ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ª

class ValidationHandler(Handler):
    def _do_handle(self, request: dict) -> Optional[str]:
        if request.get("type") == "validation":
            return f"ValidationHandler processed: {request}"
        return None

class BusinessHandler(Handler):
    def _do_handle(self, request: dict) -> Optional[str]:
        if request.get("type") == "business":
            return f"BusinessHandler processed: {request}"
        return None

# ç»„è£…é“¾
auth = AuthHandler()
validation = ValidationHandler()
business = BusinessHandler()

auth.set_next(validation).set_next(business)

# å‘é€è¯·æ±‚ - å‘é€è€…ä¸éœ€è¦çŸ¥é“è°ä¼šå¤„ç†
print(auth.handle({"type": "business", "data": "order"}))
# è¾“å‡º: BusinessHandler processed: {'type': 'business', 'data': 'order'}

# ä¼˜åŠ¿ï¼š
# 1. å‘é€è€…åªéœ€è¦çŸ¥é“é“¾çš„å…¥å£
# 2. æ–°å¢å¤„ç†è€…åªéœ€æ–°å¢ç±»ï¼Œä¸æ”¹å·²æœ‰ä»£ç 
# 3. å¤„ç†é¡ºåºå¯ä»¥åŠ¨æ€è°ƒæ•´
# 4. æ¯ä¸ªå¤„ç†è€…èŒè´£å•ä¸€
# 5. è¯·æ±‚å¯ä»¥è¢«å¤šä¸ªå¤„ç†è€…ä¾æ¬¡å¤„ç†ï¼ˆå˜ä½“ï¼‰
```

#### 3. è´£ä»»é“¾æ¨¡å¼çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šè§£è€¦ - å‘é€è€…å’Œæ¥æ”¶è€…åˆ†ç¦»

```python
# å‘é€è€…å®Œå…¨ä¸çŸ¥é“è°ä¼šå¤„ç†è¯·æ±‚
class Client:
    def __init__(self, handler: Handler):
        self._handler = handler  # åªçŸ¥é“é“¾çš„å…¥å£

    def make_request(self, request: dict):
        # ä¸å…³å¿ƒå…·ä½“æ˜¯å“ªä¸ª Handler å¤„ç†
        return self._handler.handle(request)

# å¯ä»¥éšæ—¶æ›´æ¢é“¾ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸å˜
client = Client(auth)  # ç”¨ auth å¼€å¤´çš„é“¾
client = Client(validation)  # æ¢æˆ validation å¼€å¤´çš„é“¾
```

##### ä»·å€¼2ï¼šçµæ´»æ€§ - åŠ¨æ€ç»„è£…å¤„ç†é“¾

```python
# æ ¹æ®é…ç½®åŠ¨æ€æ„å»ºé“¾
def build_chain(config: list[str]) -> Handler:
    handlers = {
        "auth": AuthHandler,
        "validation": ValidationHandler,
        "business": BusinessHandler,
    }

    chain = None
    current = None

    for handler_name in config:
        handler_class = handlers.get(handler_name)
        if handler_class:
            handler = handler_class()
            if chain is None:
                chain = handler
                current = handler
            else:
                current.set_next(handler)
                current = handler

    return chain

# ä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒçš„é“¾
dev_chain = build_chain(["business"])  # å¼€å‘ç¯å¢ƒï¼šåªæœ‰ä¸šåŠ¡å¤„ç†
prod_chain = build_chain(["auth", "validation", "business"])  # ç”Ÿäº§ç¯å¢ƒï¼šå®Œæ•´é“¾
```

##### ä»·å€¼3ï¼šå•ä¸€èŒè´£ - æ¯ä¸ªå¤„ç†è€…åªå…³æ³¨è‡ªå·±çš„é€»è¾‘

```python
# æ¯ä¸ª Handler åªåšä¸€ä»¶äº‹
class LoggingHandler(Handler):
    """åªè´Ÿè´£æ—¥å¿—è®°å½•"""
    def _do_handle(self, request: dict) -> Optional[str]:
        print(f"[LOG] Request received: {request}")
        return None  # æ€»æ˜¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ª

class RateLimitHandler(Handler):
    """åªè´Ÿè´£é™æµ"""
    def __init__(self, max_requests: int = 100):
        super().__init__()
        self._count = 0
        self._max = max_requests

    def _do_handle(self, request: dict) -> Optional[str]:
        self._count += 1
        if self._count > self._max:
            return "Rate limit exceeded"  # ä¸­æ–­é“¾
        return None  # ç»§ç»­ä¼ é€’

class CacheHandler(Handler):
    """åªè´Ÿè´£ç¼“å­˜"""
    def __init__(self):
        super().__init__()
        self._cache = {}

    def _do_handle(self, request: dict) -> Optional[str]:
        key = str(request)
        if key in self._cache:
            return self._cache[key]  # å‘½ä¸­ç¼“å­˜ï¼Œä¸­æ–­é“¾
        return None  # æœªå‘½ä¸­ï¼Œç»§ç»­ä¼ é€’
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ LangChain æºç åº”ç”¨

**æ¨ç†é“¾ï¼š**

```
1. LLM åº”ç”¨éœ€è¦ç›‘å¬å’Œå“åº”å¤šç§äº‹ä»¶ï¼ˆå¼€å§‹ã€ç»“æŸã€é”™è¯¯ã€tokenç”Ÿæˆç­‰ï¼‰
   â†“
2. ä¸åŒåœºæ™¯éœ€è¦ä¸åŒçš„å¤„ç†ï¼šæ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§ã€æµå¼è¾“å‡ºã€é”™è¯¯è¿½è¸ª...
   â†“
3. è¿™äº›å¤„ç†é€»è¾‘åº”è¯¥å¯ä»¥è‡ªç”±ç»„åˆï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç 
   â†“
4. äº‹ä»¶åº”è¯¥èƒ½å¤Ÿ"æµè¿‡"å¤šä¸ªå¤„ç†è€…ï¼ˆæ—¥å¿—+ç›‘æ§+æµå¼è¾“å‡ºï¼‰
   â†“
5. è´£ä»»é“¾æ¨¡å¼å®Œç¾åŒ¹é…è¿™ä¸ªéœ€æ±‚
   â†“
6. å®šä¹‰ BaseCallbackHandler ä½œä¸ºå¤„ç†è€…æ¥å£
   â†“
7. æ¯ä¸ªå…·ä½“ Handlerï¼ˆStreamingHandlerã€LoggingHandlerï¼‰å®ç°æ¥å£
   â†“
8. CallbackManager ç®¡ç† Handler é“¾ï¼Œäº‹ä»¶ä¾æ¬¡ä¼ é€’ç»™æ‰€æœ‰ Handler
   â†“
9. ç”¨æˆ·å¯ä»¥è‡ªç”±ç»„åˆ Handlerï¼Œå®ç°å®šåˆ¶åŒ–çš„äº‹ä»¶å¤„ç†
```

```python
# LangChain Callback ç³»ç»Ÿçš„è´£ä»»é“¾æ€æƒ³
from typing import Any, Dict, List
from abc import ABC

# å¤„ç†è€…æ¥å£ï¼ˆç®€åŒ–ç‰ˆï¼‰
class BaseCallbackHandler(ABC):
    """
    LangChain çš„ Callback å¤„ç†è€…åŸºç±»

    æ¯ä¸ªæ–¹æ³•å¯¹åº”ä¸€ç§äº‹ä»¶ï¼ŒHandler å¯ä»¥é€‰æ‹©æ€§å®ç°
    """

    def on_llm_start(self, prompts: List[str], **kwargs) -> None:
        """LLM å¼€å§‹è°ƒç”¨æ—¶è§¦å‘"""
        pass

    def on_llm_end(self, response: str, **kwargs) -> None:
        """LLM è°ƒç”¨ç»“æŸæ—¶è§¦å‘"""
        pass

    def on_llm_error(self, error: Exception, **kwargs) -> None:
        """LLM è°ƒç”¨å‡ºé”™æ—¶è§¦å‘"""
        pass

    def on_chain_start(self, inputs: Dict[str, Any], **kwargs) -> None:
        """Chain å¼€å§‹æ‰§è¡Œæ—¶è§¦å‘"""
        pass

    def on_chain_end(self, outputs: Dict[str, Any], **kwargs) -> None:
        """Chain æ‰§è¡Œç»“æŸæ—¶è§¦å‘"""
        pass

# å…·ä½“å¤„ç†è€…
class LoggingCallbackHandler(BaseCallbackHandler):
    """æ—¥å¿—è®°å½• Handler"""

    def on_llm_start(self, prompts: List[str], **kwargs) -> None:
        print(f"[LOG] LLM Start with {len(prompts)} prompts")

    def on_llm_end(self, response: str, **kwargs) -> None:
        print(f"[LOG] LLM End, response length: {len(response)}")

class MetricsCallbackHandler(BaseCallbackHandler):
    """æ€§èƒ½ç›‘æ§ Handler"""

    def __init__(self):
        self._start_time = None

    def on_llm_start(self, prompts: List[str], **kwargs) -> None:
        import time
        self._start_time = time.time()

    def on_llm_end(self, response: str, **kwargs) -> None:
        import time
        duration = time.time() - self._start_time
        print(f"[METRICS] LLM call took {duration:.2f}s")

# CallbackManager ç®¡ç† Handler é“¾
class CallbackManager:
    """ç®¡ç†å¤šä¸ª Handlerï¼Œäº‹ä»¶ä¼ é€’ç»™æ‰€æœ‰ Handler"""

    def __init__(self, handlers: List[BaseCallbackHandler] = None):
        self._handlers = handlers or []

    def add_handler(self, handler: BaseCallbackHandler) -> None:
        self._handlers.append(handler)

    def on_llm_start(self, prompts: List[str], **kwargs) -> None:
        for handler in self._handlers:
            handler.on_llm_start(prompts, **kwargs)

    def on_llm_end(self, response: str, **kwargs) -> None:
        for handler in self._handlers:
            handler.on_llm_end(response, **kwargs)

# ä½¿ç”¨
manager = CallbackManager()
manager.add_handler(LoggingCallbackHandler())
manager.add_handler(MetricsCallbackHandler())

# äº‹ä»¶ä¼šä¼ é€’ç»™æ‰€æœ‰ Handler
manager.on_llm_start(["Hello, AI!"])
# [LOG] LLM Start with 1 prompts
manager.on_llm_end("Hi there!")
# [LOG] LLM End, response length: 9
# [METRICS] LLM call took 0.00s
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**è´£ä»»é“¾æ¨¡å¼é€šè¿‡"é“¾å¼ä¼ é€’+ä¾æ¬¡å¤„ç†"çš„æ–¹å¼ï¼Œå®ç°äº†è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…çš„å®Œå…¨è§£è€¦ï¼Œæ˜¯ LangChain Callback ç³»ç»Ÿå®ç°äº‹ä»¶å¤šæ’­å’Œå¯æ’æ‹”ç›‘å¬çš„æ ¸å¿ƒè®¾è®¡ã€‚**

---

## 3. ã€æ ¸å¿ƒæ¦‚å¿µï¼ˆå…¨é¢è¦†ç›–ï¼‰ã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šHandler å¤„ç†è€…æ¥å£ ğŸ“‹

**å¤„ç†è€…æ¥å£å®šä¹‰äº†å¤„ç†è¯·æ±‚å’Œä¼ é€’é“¾çš„æŠ½è±¡å¥‘çº¦ï¼Œæ‰€æœ‰å…·ä½“å¤„ç†è€…éƒ½å¿…é¡»å®ç°è¿™ä¸ªæ¥å£**

```python
from abc import ABC, abstractmethod
from typing import Optional, Any, TypeVar, Generic

T = TypeVar("T")  # è¯·æ±‚ç±»å‹
R = TypeVar("R")  # å“åº”ç±»å‹

# ===== åŸºç¡€ Handler æ¥å£ =====
class Handler(ABC, Generic[T, R]):
    """
    å¤„ç†è€…æŠ½è±¡åŸºç±» - è´£ä»»é“¾çš„æ ¸å¿ƒ

    å®šä¹‰äº†ä¸¤ä¸ªå…³é”®èƒ½åŠ›ï¼š
    1. set_next(): è®¾ç½®ä¸‹ä¸€ä¸ªå¤„ç†è€…
    2. handle(): å¤„ç†è¯·æ±‚æˆ–ä¼ é€’ç»™ä¸‹ä¸€ä¸ª
    """

    def __init__(self):
        self._next_handler: Optional["Handler[T, R]"] = None

    def set_next(self, handler: "Handler[T, R]") -> "Handler[T, R]":
        """
        è®¾ç½®ä¸‹ä¸€ä¸ªå¤„ç†è€…

        è¿”å›ä¸‹ä¸€ä¸ªå¤„ç†è€…ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼š
        handler1.set_next(handler2).set_next(handler3)
        """
        self._next_handler = handler
        return handler

    @abstractmethod
    def handle(self, request: T) -> Optional[R]:
        """
        å¤„ç†è¯·æ±‚

        å­ç±»å®ç°å…·ä½“é€»è¾‘ï¼š
        - å¦‚æœèƒ½å¤„ç†ï¼Œè¿”å›ç»“æœ
        - å¦‚æœä¸èƒ½å¤„ç†ï¼Œè°ƒç”¨ self._next_handler.handle(request)
        """
        pass

# ===== å¸¦é»˜è®¤ä¼ é€’çš„ Handler =====
class BaseHandler(Handler[T, R]):
    """
    æä¾›é»˜è®¤ä¼ é€’å®ç°çš„ Handler åŸºç±»

    å­ç±»åªéœ€è¦å®ç° _do_handle() æ–¹æ³•
    """

    def handle(self, request: T) -> Optional[R]:
        """æ¨¡æ¿æ–¹æ³•ï¼šå…ˆå°è¯•å¤„ç†ï¼Œå¤„ç†ä¸äº†å°±ä¼ é€’"""
        result = self._do_handle(request)
        if result is not None:
            return result
        if self._next_handler:
            return self._next_handler.handle(request)
        return None

    @abstractmethod
    def _do_handle(self, request: T) -> Optional[R]:
        """å­ç±»å®ç°ï¼šå…·ä½“å¤„ç†é€»è¾‘"""
        pass

# ===== ä¸­é—´ä»¶é£æ ¼ Handlerï¼ˆæ¯ä¸ªéƒ½ä¼šæ‰§è¡Œï¼‰=====
class MiddlewareHandler(Handler[T, T]):
    """
    ä¸­é—´ä»¶é£æ ¼çš„ Handler

    ä¸ä¼ ç»Ÿè´£ä»»é“¾ä¸åŒï¼Œæ¯ä¸ª Handler éƒ½ä¼šæ‰§è¡Œï¼Œ
    è¯·æ±‚ä¼š"æµè¿‡"æ•´ä¸ªé“¾ï¼ˆç±»ä¼¼ Express.js ä¸­é—´ä»¶ï¼‰
    """

    def handle(self, request: T) -> T:
        """å¤„ç†è¯·æ±‚å¹¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ª"""
        # å‰ç½®å¤„ç†
        request = self._before(request)

        # ä¼ é€’ç»™ä¸‹ä¸€ä¸ª
        if self._next_handler:
            request = self._next_handler.handle(request)

        # åç½®å¤„ç†
        request = self._after(request)

        return request

    def _before(self, request: T) -> T:
        """å‰ç½®å¤„ç†ï¼ˆå­ç±»å¯è¦†ç›–ï¼‰"""
        return request

    def _after(self, request: T) -> T:
        """åç½®å¤„ç†ï¼ˆå­ç±»å¯è¦†ç›–ï¼‰"""
        return request
```

**Handler æ¥å£çš„è®¾è®¡åŸåˆ™ï¼š**

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| é“¾å¼è°ƒç”¨ | `set_next()` è¿”å›ä¸‹ä¸€ä¸ª Handler | `h1.set_next(h2).set_next(h3)` |
| å•ä¸€èŒè´£ | æ¯ä¸ª Handler åªå¤„ç†ä¸€ç±»è¯·æ±‚ | AuthHandler åªå¤„ç†è®¤è¯ |
| å¯é€‰å¤„ç† | Handler å¯ä»¥é€‰æ‹©å¤„ç†æˆ–è·³è¿‡ | è¿”å› None è¡¨ç¤ºè·³è¿‡ |
| æ³›å‹æ”¯æŒ | æ”¯æŒä¸åŒç±»å‹çš„è¯·æ±‚å’Œå“åº” | `Handler[Request, Response]` |

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# langchain_core/callbacks/base.py ç®€åŒ–ç‰ˆ
class BaseCallbackHandler:
    """
    LangChain çš„ Callback Handler åŸºç±»

    ä¸ä¼ ç»Ÿè´£ä»»é“¾çš„åŒºåˆ«ï¼š
    - ä¸æ˜¯"ä¸€ä¸ªå¤„ç†å°±åœæ­¢"ï¼Œè€Œæ˜¯"æ‰€æœ‰éƒ½å¤„ç†"
    - æ›´åƒ"è§‚å¯Ÿè€…+è´£ä»»é“¾"çš„æ··åˆæ¨¡å¼
    """

    # æ¯ä¸ªæ–¹æ³•å¯¹åº”ä¸€ç§äº‹ä»¶
    def on_llm_start(self, serialized, prompts, **kwargs):
        """LLM å¼€å§‹æ—¶è°ƒç”¨"""
        pass

    def on_llm_new_token(self, token: str, **kwargs):
        """æ”¶åˆ°æ–° token æ—¶è°ƒç”¨ï¼ˆæµå¼ï¼‰"""
        pass

    def on_llm_end(self, response, **kwargs):
        """LLM ç»“æŸæ—¶è°ƒç”¨"""
        pass

    def on_llm_error(self, error, **kwargs):
        """LLM å‡ºé”™æ—¶è°ƒç”¨"""
        pass

    def on_chain_start(self, serialized, inputs, **kwargs):
        """Chain å¼€å§‹æ—¶è°ƒç”¨"""
        pass

    def on_chain_end(self, outputs, **kwargs):
        """Chain ç»“æŸæ—¶è°ƒç”¨"""
        pass

    def on_tool_start(self, serialized, input_str, **kwargs):
        """Tool å¼€å§‹æ—¶è°ƒç”¨"""
        pass

    def on_tool_end(self, output, **kwargs):
        """Tool ç»“æŸæ—¶è°ƒç”¨"""
        pass
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šConcreteHandler å…·ä½“å¤„ç†è€… ğŸ”§

**å…·ä½“å¤„ç†è€…å®ç° Handler æ¥å£ï¼Œå°è£…å…·ä½“çš„å¤„ç†é€»è¾‘**

```python
from typing import Optional, Dict, Any
from dataclasses import dataclass
from enum import Enum, auto

# ===== è¯·æ±‚æ•°æ®ç»“æ„ =====
class RequestType(Enum):
    AUTH = auto()
    VALIDATION = auto()
    RATE_LIMIT = auto()
    LOGGING = auto()
    BUSINESS = auto()

@dataclass
class Request:
    """è¯·æ±‚å¯¹è±¡"""
    type: RequestType
    data: Dict[str, Any]
    metadata: Dict[str, Any] = None

    def __post_init__(self):
        if self.metadata is None:
            self.metadata = {}

# ===== å…·ä½“å¤„ç†è€…1ï¼šè®¤è¯å¤„ç†å™¨ =====
class AuthHandler(BaseHandler[Request, str]):
    """
    è®¤è¯å¤„ç†å™¨

    æ£€æŸ¥è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„è®¤è¯ä¿¡æ¯
    """

    def __init__(self, valid_tokens: set = None):
        super().__init__()
        self._valid_tokens = valid_tokens or {"token123", "admin_token"}

    def _do_handle(self, request: Request) -> Optional[str]:
        token = request.data.get("auth_token")

        # æ²¡æœ‰ tokenï¼Œéœ€è¦è®¤è¯
        if token is None:
            return "Error: Missing authentication token"

        # token æ— æ•ˆ
        if token not in self._valid_tokens:
            return f"Error: Invalid token '{token}'"

        # è®¤è¯é€šè¿‡ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†è€…
        print(f"[Auth] Token '{token}' validated")
        return None

# ===== å…·ä½“å¤„ç†è€…2ï¼šå‚æ•°éªŒè¯å¤„ç†å™¨ =====
class ValidationHandler(BaseHandler[Request, str]):
    """
    å‚æ•°éªŒè¯å¤„ç†å™¨

    æ£€æŸ¥è¯·æ±‚å‚æ•°æ˜¯å¦ç¬¦åˆè¦æ±‚
    """

    def __init__(self, required_fields: list = None):
        super().__init__()
        self._required_fields = required_fields or ["user_id", "action"]

    def _do_handle(self, request: Request) -> Optional[str]:
        missing_fields = []

        for field in self._required_fields:
            if field not in request.data:
                missing_fields.append(field)

        if missing_fields:
            return f"Error: Missing required fields: {missing_fields}"

        # éªŒè¯é€šè¿‡
        print(f"[Validation] All required fields present")
        return None

# ===== å…·ä½“å¤„ç†è€…3ï¼šé™æµå¤„ç†å™¨ =====
class RateLimitHandler(BaseHandler[Request, str]):
    """
    é™æµå¤„ç†å™¨

    åŸºäºæ»‘åŠ¨çª—å£çš„ç®€å•é™æµ
    """

    def __init__(self, max_requests: int = 10, window_seconds: int = 60):
        super().__init__()
        self._max_requests = max_requests
        self._window_seconds = window_seconds
        self._requests: Dict[str, list] = {}  # user_id -> [timestamps]

    def _do_handle(self, request: Request) -> Optional[str]:
        import time

        user_id = request.data.get("user_id", "anonymous")
        current_time = time.time()

        # è·å–ç”¨æˆ·çš„è¯·æ±‚å†å²
        if user_id not in self._requests:
            self._requests[user_id] = []

        # æ¸…ç†è¿‡æœŸçš„è¯·æ±‚è®°å½•
        self._requests[user_id] = [
            t for t in self._requests[user_id]
            if current_time - t < self._window_seconds
        ]

        # æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
        if len(self._requests[user_id]) >= self._max_requests:
            return f"Error: Rate limit exceeded for user '{user_id}'"

        # è®°å½•æœ¬æ¬¡è¯·æ±‚
        self._requests[user_id].append(current_time)
        print(f"[RateLimit] User '{user_id}' request count: {len(self._requests[user_id])}")
        return None

# ===== å…·ä½“å¤„ç†è€…4ï¼šæ—¥å¿—å¤„ç†å™¨ =====
class LoggingHandler(BaseHandler[Request, str]):
    """
    æ—¥å¿—å¤„ç†å™¨

    è®°å½•è¯·æ±‚æ—¥å¿—ï¼Œæ€»æ˜¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ªï¼ˆä¸ä¼šä¸­æ–­é“¾ï¼‰
    """

    def _do_handle(self, request: Request) -> Optional[str]:
        import json
        from datetime import datetime

        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "type": request.type.name,
            "data_keys": list(request.data.keys()),
        }
        print(f"[Log] {json.dumps(log_entry)}")

        # æ€»æ˜¯è¿”å› Noneï¼Œè®©è¯·æ±‚ç»§ç»­ä¼ é€’
        return None

# ===== å…·ä½“å¤„ç†è€…5ï¼šä¸šåŠ¡å¤„ç†å™¨ =====
class BusinessHandler(BaseHandler[Request, str]):
    """
    ä¸šåŠ¡å¤„ç†å™¨

    æ‰§è¡Œå®é™…çš„ä¸šåŠ¡é€»è¾‘ï¼ˆé“¾çš„ç»ˆç‚¹ï¼‰
    """

    def _do_handle(self, request: Request) -> Optional[str]:
        action = request.data.get("action")
        user_id = request.data.get("user_id")

        # æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
        result = f"Successfully executed '{action}' for user '{user_id}'"
        print(f"[Business] {result}")
        return result

# ===== ä½¿ç”¨ç¤ºä¾‹ =====
def demo_concrete_handlers():
    """æ¼”ç¤ºå…·ä½“å¤„ç†è€…çš„ä½¿ç”¨"""

    # æ„å»ºå¤„ç†é“¾
    auth = AuthHandler()
    validation = ValidationHandler(required_fields=["user_id", "action"])
    rate_limit = RateLimitHandler(max_requests=5)
    logging = LoggingHandler()
    business = BusinessHandler()

    # ç»„è£…é“¾
    auth.set_next(validation).set_next(rate_limit).set_next(logging).set_next(business)

    # æµ‹è¯•è¯·æ±‚
    print("=== Test 1: Valid Request ===")
    request1 = Request(
        type=RequestType.BUSINESS,
        data={"auth_token": "token123", "user_id": "user1", "action": "create_order"}
    )
    result1 = auth.handle(request1)
    print(f"Result: {result1}\n")

    print("=== Test 2: Missing Token ===")
    request2 = Request(
        type=RequestType.BUSINESS,
        data={"user_id": "user1", "action": "create_order"}
    )
    result2 = auth.handle(request2)
    print(f"Result: {result2}\n")

    print("=== Test 3: Missing Fields ===")
    request3 = Request(
        type=RequestType.BUSINESS,
        data={"auth_token": "token123", "user_id": "user1"}  # ç¼ºå°‘ action
    )
    result3 = auth.handle(request3)
    print(f"Result: {result3}\n")

if __name__ == "__main__":
    demo_concrete_handlers()
```

**è¿è¡Œè¾“å‡ºï¼š**
```
=== Test 1: Valid Request ===
[Auth] Token 'token123' validated
[Validation] All required fields present
[RateLimit] User 'user1' request count: 1
[Log] {"timestamp": "2024-01-15T10:30:00.000000", "type": "BUSINESS", "data_keys": ["auth_token", "user_id", "action"]}
[Business] Successfully executed 'create_order' for user 'user1'
Result: Successfully executed 'create_order' for user 'user1'

=== Test 2: Missing Token ===
Result: Error: Missing authentication token

=== Test 3: Missing Fields ===
[Auth] Token 'token123' validated
Result: Error: Missing required fields: ['action']
```

**å…·ä½“å¤„ç†è€…çš„ç‰¹ç‚¹ï¼š**

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| å°è£…ç‹¬ç«‹ | æ¯ä¸ªå¤„ç†è€…æ˜¯ç‹¬ç«‹çš„ç±»ï¼Œå¯å•ç‹¬æµ‹è¯• |
| å®ç°æ¥å£ | å¿…é¡»å®ç° `_do_handle()` æ–¹æ³• |
| å†³å®šä¼ é€’ | è¿”å› `None` è¡¨ç¤ºä¼ é€’ï¼Œè¿”å›ç»“æœè¡¨ç¤ºå¤„ç†å®Œæˆ |
| å¯ç»„åˆ | ä»»æ„é¡ºåºç»„è£…æˆä¸åŒçš„é“¾ |

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šChain Assembly é“¾çš„ç»„è£… ğŸ”—

**é“¾çš„ç»„è£…æ–¹å¼å†³å®šäº†è¯·æ±‚çš„å¤„ç†æµç¨‹ï¼Œå¯ä»¥é™æ€æˆ–åŠ¨æ€æ„å»º**

```python
from typing import List, Type, Dict, Callable
from abc import ABC

# ===== æ–¹å¼1ï¼šæ‰‹åŠ¨é“¾å¼ç»„è£… =====
def manual_chain_assembly():
    """æ‰‹åŠ¨ç»„è£… - æœ€ç›´è§‚çš„æ–¹å¼"""

    auth = AuthHandler()
    validation = ValidationHandler()
    business = BusinessHandler()

    # é“¾å¼è°ƒç”¨
    auth.set_next(validation).set_next(business)

    return auth

# ===== æ–¹å¼2ï¼šåˆ—è¡¨ç»„è£… =====
def list_chain_assembly(handlers: List[BaseHandler]) -> BaseHandler:
    """ä»åˆ—è¡¨ç»„è£…é“¾"""

    if not handlers:
        raise ValueError("Handler list cannot be empty")

    for i in range(len(handlers) - 1):
        handlers[i].set_next(handlers[i + 1])

    return handlers[0]

# ä½¿ç”¨
handlers = [AuthHandler(), ValidationHandler(), BusinessHandler()]
chain = list_chain_assembly(handlers)

# ===== æ–¹å¼3ï¼šé…ç½®é©±åŠ¨ç»„è£… =====
class ChainBuilder:
    """
    é“¾æ„å»ºå™¨ - æ ¹æ®é…ç½®åŠ¨æ€æ„å»ºé“¾

    æ”¯æŒï¼š
    - æ³¨å†Œå¤„ç†è€…ç±»å‹
    - æ ¹æ®é…ç½®æ„å»ºé“¾
    - æ¡ä»¶è¿‡æ»¤å¤„ç†è€…
    """

    # å¤„ç†è€…æ³¨å†Œè¡¨
    _registry: Dict[str, Type[BaseHandler]] = {}

    @classmethod
    def register(cls, name: str) -> Callable:
        """è£…é¥°å™¨ï¼šæ³¨å†Œå¤„ç†è€…ç±»å‹"""
        def decorator(handler_class: Type[BaseHandler]) -> Type[BaseHandler]:
            cls._registry[name] = handler_class
            return handler_class
        return decorator

    @classmethod
    def build(cls, config: List[str]) -> BaseHandler:
        """æ ¹æ®é…ç½®æ„å»ºé“¾"""
        handlers = []

        for name in config:
            handler_class = cls._registry.get(name)
            if handler_class:
                handlers.append(handler_class())
            else:
                print(f"Warning: Unknown handler '{name}'")

        if not handlers:
            raise ValueError("No valid handlers in config")

        return list_chain_assembly(handlers)

    @classmethod
    def build_conditional(
        cls,
        config: List[str],
        condition: Callable[[str], bool]
    ) -> BaseHandler:
        """æ ¹æ®æ¡ä»¶è¿‡æ»¤åæ„å»ºé“¾"""
        filtered_config = [name for name in config if condition(name)]
        return cls.build(filtered_config)

# æ³¨å†Œå¤„ç†è€…
@ChainBuilder.register("auth")
class RegisteredAuthHandler(AuthHandler):
    pass

@ChainBuilder.register("validation")
class RegisteredValidationHandler(ValidationHandler):
    pass

@ChainBuilder.register("rate_limit")
class RegisteredRateLimitHandler(RateLimitHandler):
    pass

@ChainBuilder.register("logging")
class RegisteredLoggingHandler(LoggingHandler):
    pass

@ChainBuilder.register("business")
class RegisteredBusinessHandler(BusinessHandler):
    pass

# æ ¹æ®é…ç½®æ„å»ºä¸åŒçš„é“¾
dev_chain = ChainBuilder.build(["logging", "business"])  # å¼€å‘ç¯å¢ƒ
prod_chain = ChainBuilder.build(["auth", "validation", "rate_limit", "logging", "business"])  # ç”Ÿäº§ç¯å¢ƒ

# æ¡ä»¶æ„å»º
lightweight_chain = ChainBuilder.build_conditional(
    ["auth", "validation", "rate_limit", "logging", "business"],
    condition=lambda name: name not in ["rate_limit", "logging"]  # æ’é™¤é™æµå’Œæ—¥å¿—
)

# ===== æ–¹å¼4ï¼šæµå¼æ„å»ºå™¨ =====
class FluentChainBuilder:
    """
    æµå¼æ„å»ºå™¨ - é“¾å¼ API
    """

    def __init__(self):
        self._handlers: List[BaseHandler] = []

    def add(self, handler: BaseHandler) -> "FluentChainBuilder":
        """æ·»åŠ å¤„ç†è€…"""
        self._handlers.append(handler)
        return self

    def add_if(self, condition: bool, handler: BaseHandler) -> "FluentChainBuilder":
        """æ¡ä»¶æ·»åŠ """
        if condition:
            self._handlers.append(handler)
        return self

    def build(self) -> BaseHandler:
        """æ„å»ºé“¾"""
        if not self._handlers:
            raise ValueError("No handlers added")
        return list_chain_assembly(self._handlers)

# ä½¿ç”¨æµå¼æ„å»ºå™¨
is_production = True
enable_rate_limit = True

chain = (
    FluentChainBuilder()
    .add(AuthHandler())
    .add(ValidationHandler())
    .add_if(enable_rate_limit, RateLimitHandler())
    .add_if(is_production, LoggingHandler())
    .add(BusinessHandler())
    .build()
)

# ===== æ–¹å¼5ï¼šè£…é¥°å™¨ç»„è£…ï¼ˆå‡½æ•°å¼é£æ ¼ï¼‰=====
from functools import wraps

def chain(*handlers: BaseHandler):
    """è£…é¥°å™¨ï¼šå°†å‡½æ•°åŒ…è£…åœ¨å¤„ç†é“¾ä¸­"""
    def decorator(func: Callable):
        @wraps(func)
        def wrapper(request: Request) -> str:
            # å…ˆç»è¿‡å¤„ç†é“¾
            chain_head = list_chain_assembly(list(handlers))
            result = chain_head.handle(request)

            if result and result.startswith("Error"):
                return result  # é“¾ä¸­æŸä¸ªå¤„ç†è€…è¿”å›äº†é”™è¯¯

            # é“¾é€šè¿‡åæ‰§è¡ŒåŸå‡½æ•°
            return func(request)
        return wrapper
    return decorator

@chain(AuthHandler(), ValidationHandler())
def process_order(request: Request) -> str:
    """è®¢å•å¤„ç†å‡½æ•°ï¼ˆå·²è¢«å¤„ç†é“¾ä¿æŠ¤ï¼‰"""
    return f"Order processed: {request.data}"
```

**é“¾ç»„è£…æ–¹å¼å¯¹æ¯”ï¼š**

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| æ‰‹åŠ¨ç»„è£… | ç®€å•ç›´è§‚ | ä¸å¤Ÿçµæ´» | ç®€å•åœºæ™¯ |
| åˆ—è¡¨ç»„è£… | ä»£ç å¤ç”¨ | ä»éœ€æ‰‹åŠ¨åˆ›å»ºå®ä¾‹ | åŠ¨æ€é¡ºåº |
| é…ç½®é©±åŠ¨ | é«˜åº¦çµæ´» | éœ€è¦æ³¨å†Œæœºåˆ¶ | ç”Ÿäº§ç¯å¢ƒ |
| æµå¼æ„å»º | API å‹å¥½ | ç•¥æ˜¾ç¹ç | å¤æ‚æ¡ä»¶ |
| è£…é¥°å™¨ | å£°æ˜å¼ | è€¦åˆå‡½æ•° | AOP åœºæ™¯ |

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# langchain_core/callbacks/manager.py ç®€åŒ–ç‰ˆ
class CallbackManager:
    """
    Callback ç®¡ç†å™¨ - ç®¡ç† Handler é“¾

    ä¸ä¼ ç»Ÿè´£ä»»é“¾çš„åŒºåˆ«ï¼š
    ä½¿ç”¨åˆ—è¡¨è€Œä¸æ˜¯é“¾è¡¨ï¼Œäº‹ä»¶å¹¿æ’­ç»™æ‰€æœ‰ Handler
    """

    def __init__(
        self,
        handlers: List[BaseCallbackHandler] = None,
        inheritable_handlers: List[BaseCallbackHandler] = None,
    ):
        self.handlers = handlers or []
        self.inheritable_handlers = inheritable_handlers or []

    @classmethod
    def configure(
        cls,
        inheritable_callbacks: List[BaseCallbackHandler] = None,
        local_callbacks: List[BaseCallbackHandler] = None,
    ) -> "CallbackManager":
        """å·¥å‚æ–¹æ³•ï¼šæ ¹æ®é…ç½®åˆ›å»º Manager"""
        return cls(
            handlers=local_callbacks or [],
            inheritable_handlers=inheritable_callbacks or [],
        )

    def on_llm_start(self, prompts: List[str], **kwargs):
        """å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰ Handler"""
        for handler in self.handlers + self.inheritable_handlers:
            handler.on_llm_start(prompts, **kwargs)
```

---

### æ‰©å±•æ¦‚å¿µ1ï¼šä¸­æ–­é“¾ï¼ˆçŸ­è·¯å¤„ç†ï¼‰âš¡

**ä¸­æ–­é“¾å…è®¸å¤„ç†è€…æå‰ç»ˆæ­¢é“¾çš„ä¼ é€’ï¼Œä¸å†ç»§ç»­å‘ä¸‹ä¼ é€’è¯·æ±‚**

```python
from typing import Optional
from enum import Enum, auto

class ChainAction(Enum):
    """é“¾çš„æ§åˆ¶åŠ¨ä½œ"""
    CONTINUE = auto()  # ç»§ç»­ä¼ é€’
    STOP = auto()      # åœæ­¢ä¼ é€’
    ABORT = auto()     # ä¸­æ­¢å¹¶è¿”å›é”™è¯¯

class InterruptibleHandler(ABC):
    """
    å¯ä¸­æ–­çš„å¤„ç†è€…

    å¤„ç†è€…å¯ä»¥è¿”å›æ§åˆ¶ä¿¡å·ï¼Œå†³å®šé“¾çš„è¡Œä¸º
    """

    def __init__(self):
        self._next_handler: Optional["InterruptibleHandler"] = None

    def set_next(self, handler: "InterruptibleHandler") -> "InterruptibleHandler":
        self._next_handler = handler
        return handler

    def handle(self, request: dict) -> tuple[ChainAction, Optional[str]]:
        """
        å¤„ç†è¯·æ±‚

        è¿”å›ï¼š(åŠ¨ä½œ, ç»“æœ)
        - CONTINUE: ç»§ç»­ä¼ é€’ï¼Œç»“æœå¯é€‰
        - STOP: åœæ­¢ä¼ é€’ï¼Œè¿”å›ç»“æœ
        - ABORT: ä¸­æ­¢é“¾ï¼Œè¿”å›é”™è¯¯
        """
        action, result = self._do_handle(request)

        if action == ChainAction.CONTINUE and self._next_handler:
            return self._next_handler.handle(request)

        return action, result

    @abstractmethod
    def _do_handle(self, request: dict) -> tuple[ChainAction, Optional[str]]:
        pass

# å…·ä½“å®ç°
class AuthInterruptHandler(InterruptibleHandler):
    def _do_handle(self, request: dict) -> tuple[ChainAction, Optional[str]]:
        if "token" not in request:
            return ChainAction.ABORT, "Authentication required"  # ä¸­æ­¢é“¾
        return ChainAction.CONTINUE, None  # ç»§ç»­ä¼ é€’

class CacheInterruptHandler(InterruptibleHandler):
    def __init__(self):
        super().__init__()
        self._cache = {"user:1": "cached_data"}

    def _do_handle(self, request: dict) -> tuple[ChainAction, Optional[str]]:
        cache_key = request.get("cache_key")
        if cache_key and cache_key in self._cache:
            return ChainAction.STOP, self._cache[cache_key]  # å‘½ä¸­ç¼“å­˜ï¼Œåœæ­¢ä¼ é€’
        return ChainAction.CONTINUE, None  # æœªå‘½ä¸­ï¼Œç»§ç»­ä¼ é€’

class ProcessInterruptHandler(InterruptibleHandler):
    def _do_handle(self, request: dict) -> tuple[ChainAction, Optional[str]]:
        # å¤„ç†ä¸šåŠ¡é€»è¾‘
        return ChainAction.STOP, f"Processed: {request}"

# ä½¿ç”¨
auth = AuthInterruptHandler()
cache = CacheInterruptHandler()
process = ProcessInterruptHandler()

auth.set_next(cache).set_next(process)

# æµ‹è¯•1ï¼šç¼“å­˜å‘½ä¸­ï¼ŒçŸ­è·¯
action, result = auth.handle({"token": "xxx", "cache_key": "user:1"})
print(f"Cache hit: {result}")  # Cache hit: cached_data

# æµ‹è¯•2ï¼šç¼“å­˜æœªå‘½ä¸­ï¼Œå®Œæ•´é“¾
action, result = auth.handle({"token": "xxx", "cache_key": "user:2"})
print(f"Full chain: {result}")  # Full chain: Processed: {...}

# æµ‹è¯•3ï¼šè®¤è¯å¤±è´¥ï¼Œä¸­æ­¢
action, result = auth.handle({"cache_key": "user:1"})
print(f"Aborted: {result}")  # Aborted: Authentication required
```

---

### æ‰©å±•æ¦‚å¿µ2ï¼šåŒå‘é“¾ï¼ˆè¯·æ±‚-å“åº”é“¾ï¼‰ğŸ”„

**åŒå‘é“¾åœ¨è¯·æ±‚ä¼ é€’å’Œå“åº”è¿”å›æ—¶éƒ½ç»è¿‡å¤„ç†é“¾ï¼Œç±»ä¼¼äºæ´‹è‘±æ¨¡å‹**

```python
from typing import Optional, Any
from abc import ABC, abstractmethod
from dataclasses import dataclass

@dataclass
class Context:
    """è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œåœ¨é“¾ä¸­ä¼ é€’"""
    request: dict
    response: Optional[dict] = None
    metadata: dict = None

    def __post_init__(self):
        if self.metadata is None:
            self.metadata = {}

class BidirectionalHandler(ABC):
    """
    åŒå‘å¤„ç†è€… - æ´‹è‘±æ¨¡å‹

    è¯·æ±‚æ—¶ï¼šå¤–å±‚ â†’ å†…å±‚ï¼ˆpre_handleï¼‰
    å“åº”æ—¶ï¼šå†…å±‚ â†’ å¤–å±‚ï¼ˆpost_handleï¼‰
    """

    def __init__(self):
        self._next_handler: Optional["BidirectionalHandler"] = None

    def set_next(self, handler: "BidirectionalHandler") -> "BidirectionalHandler":
        self._next_handler = handler
        return handler

    def handle(self, context: Context) -> Context:
        """
        å¤„ç†è¯·æ±‚

        1. æ‰§è¡Œå‰ç½®å¤„ç†ï¼ˆè¯·æ±‚æ–¹å‘ï¼‰
        2. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†è€…
        3. æ‰§è¡Œåç½®å¤„ç†ï¼ˆå“åº”æ–¹å‘ï¼‰
        """
        # å‰ç½®å¤„ç†
        context = self.pre_handle(context)

        # å¦‚æœå“åº”å·²è®¾ç½®ï¼ˆçŸ­è·¯ï¼‰ï¼Œä¸å†ä¼ é€’
        if context.response is not None:
            return self.post_handle(context)

        # ä¼ é€’ç»™ä¸‹ä¸€ä¸ª
        if self._next_handler:
            context = self._next_handler.handle(context)

        # åç½®å¤„ç†
        return self.post_handle(context)

    def pre_handle(self, context: Context) -> Context:
        """å‰ç½®å¤„ç†ï¼ˆè¯·æ±‚æ–¹å‘ï¼‰ï¼Œå­ç±»å¯è¦†ç›–"""
        return context

    def post_handle(self, context: Context) -> Context:
        """åç½®å¤„ç†ï¼ˆå“åº”æ–¹å‘ï¼‰ï¼Œå­ç±»å¯è¦†ç›–"""
        return context

# å…·ä½“å®ç°
class TimingHandler(BidirectionalHandler):
    """è®¡æ—¶å¤„ç†å™¨ï¼šè®°å½•è¯·æ±‚å¤„ç†æ—¶é—´"""

    def pre_handle(self, context: Context) -> Context:
        import time
        context.metadata["start_time"] = time.time()
        print("[Timing] Request started")
        return context

    def post_handle(self, context: Context) -> Context:
        import time
        start_time = context.metadata.get("start_time", time.time())
        duration = time.time() - start_time
        context.metadata["duration"] = duration
        print(f"[Timing] Request finished in {duration:.4f}s")
        return context

class LoggingBidirectionalHandler(BidirectionalHandler):
    """æ—¥å¿—å¤„ç†å™¨ï¼šè®°å½•è¯·æ±‚å’Œå“åº”"""

    def pre_handle(self, context: Context) -> Context:
        print(f"[Log] Request: {context.request}")
        return context

    def post_handle(self, context: Context) -> Context:
        print(f"[Log] Response: {context.response}")
        return context

class TransformHandler(BidirectionalHandler):
    """è½¬æ¢å¤„ç†å™¨ï¼šè¯·æ±‚/å“åº”æ•°æ®è½¬æ¢"""

    def pre_handle(self, context: Context) -> Context:
        # è¯·æ±‚æ•°æ®è½¬æ¢ï¼ˆå¦‚ï¼šsnake_case â†’ camelCaseï¼‰
        context.request = {
            self._to_camel_case(k): v
            for k, v in context.request.items()
        }
        return context

    def post_handle(self, context: Context) -> Context:
        # å“åº”æ•°æ®è½¬æ¢ï¼ˆå¦‚ï¼šcamelCase â†’ snake_caseï¼‰
        if context.response:
            context.response = {
                self._to_snake_case(k): v
                for k, v in context.response.items()
            }
        return context

    @staticmethod
    def _to_camel_case(name: str) -> str:
        components = name.split('_')
        return components[0] + ''.join(x.title() for x in components[1:])

    @staticmethod
    def _to_snake_case(name: str) -> str:
        import re
        return re.sub(r'(?<!^)(?=[A-Z])', '_', name).lower()

class BusinessBidirectionalHandler(BidirectionalHandler):
    """ä¸šåŠ¡å¤„ç†å™¨ï¼šé“¾çš„ç»ˆç‚¹"""

    def pre_handle(self, context: Context) -> Context:
        # æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        context.response = {
            "status": "success",
            "data": f"Processed: {context.request}",
            "userId": context.request.get("userId", "unknown")
        }
        return context

# ä½¿ç”¨ç¤ºä¾‹
def demo_bidirectional():
    """æ¼”ç¤ºåŒå‘é“¾"""

    timing = TimingHandler()
    logging = LoggingBidirectionalHandler()
    transform = TransformHandler()
    business = BusinessBidirectionalHandler()

    timing.set_next(logging).set_next(transform).set_next(business)

    context = Context(request={"user_id": "123", "action_type": "query"})
    result = timing.handle(context)

    print(f"\nFinal response: {result.response}")
    print(f"Duration: {result.metadata.get('duration', 0):.4f}s")

# è¾“å‡ºï¼š
# [Timing] Request started
# [Log] Request: {'user_id': '123', 'action_type': 'query'}
# [Log] Response: {'status': 'success', 'data': "Processed: {'userId': '123', 'actionType': 'query'}", 'userId': '123'}
# [Timing] Request finished in 0.0001s
#
# Final response: {'status': 'success', 'data': "...", 'user_id': '123'}
# Duration: 0.0001s
```

**æ´‹è‘±æ¨¡å‹ç¤ºæ„å›¾ï¼š**

```
è¯·æ±‚æ–¹å‘ â†’
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Timing.pre_handle()                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Logging.pre_handle()                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Transform.pre_handle()       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Business.pre_handle â”‚    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   (è®¾ç½® response)    â”‚    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ Transform.post_handle()      â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚ Logging.post_handle()               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ Timing.post_handle()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â† å“åº”æ–¹å‘
```

---

### æ‰©å±•æ¦‚å¿µ3ï¼šå¼‚æ­¥è´£ä»»é“¾ âš¡

**å¼‚æ­¥è´£ä»»é“¾æ”¯æŒå¼‚æ­¥å¤„ç†ï¼Œé€‚ç”¨äº I/O å¯†é›†å‹æ“ä½œ**

```python
import asyncio
from typing import Optional
from abc import ABC, abstractmethod

class AsyncHandler(ABC):
    """
    å¼‚æ­¥å¤„ç†è€…

    æ”¯æŒ async/await çš„è´£ä»»é“¾å®ç°
    """

    def __init__(self):
        self._next_handler: Optional["AsyncHandler"] = None

    def set_next(self, handler: "AsyncHandler") -> "AsyncHandler":
        self._next_handler = handler
        return handler

    async def handle(self, request: dict) -> Optional[str]:
        """å¼‚æ­¥å¤„ç†è¯·æ±‚"""
        result = await self._do_handle(request)
        if result is not None:
            return result
        if self._next_handler:
            return await self._next_handler.handle(request)
        return None

    @abstractmethod
    async def _do_handle(self, request: dict) -> Optional[str]:
        pass

# å¼‚æ­¥å¤„ç†è€…å®ç°
class AsyncAuthHandler(AsyncHandler):
    async def _do_handle(self, request: dict) -> Optional[str]:
        # æ¨¡æ‹Ÿå¼‚æ­¥è®¤è¯ï¼ˆå¦‚è°ƒç”¨è®¤è¯æœåŠ¡ï¼‰
        await asyncio.sleep(0.1)
        if "token" not in request:
            return "Auth failed"
        print("[AsyncAuth] Authenticated")
        return None

class AsyncDatabaseHandler(AsyncHandler):
    async def _do_handle(self, request: dict) -> Optional[str]:
        # æ¨¡æ‹Ÿå¼‚æ­¥æ•°æ®åº“æŸ¥è¯¢
        await asyncio.sleep(0.2)
        user_id = request.get("user_id")
        print(f"[AsyncDB] Queried user {user_id}")
        return None

class AsyncExternalAPIHandler(AsyncHandler):
    async def _do_handle(self, request: dict) -> Optional[str]:
        # æ¨¡æ‹Ÿè°ƒç”¨å¤–éƒ¨ API
        await asyncio.sleep(0.15)
        print("[AsyncAPI] External API called")
        return f"Result for {request}"

# ä½¿ç”¨
async def demo_async_chain():
    auth = AsyncAuthHandler()
    db = AsyncDatabaseHandler()
    api = AsyncExternalAPIHandler()

    auth.set_next(db).set_next(api)

    result = await auth.handle({"token": "xxx", "user_id": "123"})
    print(f"Final: {result}")

# asyncio.run(demo_async_chain())
```

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# LangChain çš„ Runnable æ”¯æŒå¼‚æ­¥
class Runnable(ABC):
    @abstractmethod
    def invoke(self, input: Any) -> Any:
        """åŒæ­¥è°ƒç”¨"""
        pass

    @abstractmethod
    async def ainvoke(self, input: Any) -> Any:
        """å¼‚æ­¥è°ƒç”¨"""
        pass

# Chain ç»„åˆæ—¶ä¿æŒå¼‚æ­¥ç‰¹æ€§
class RunnableSequence(Runnable):
    """
    Runnable åºåˆ— - ç±»ä¼¼è´£ä»»é“¾

    first | middle | last å½¢æˆå¤„ç†é“¾
    """

    def __init__(self, first, *middle, last):
        self.first = first
        self.middle = list(middle)
        self.last = last

    async def ainvoke(self, input: Any) -> Any:
        """å¼‚æ­¥æ‰§è¡Œé“¾"""
        result = await self.first.ainvoke(input)
        for runnable in self.middle:
            result = await runnable.ainvoke(result)
        return await self.last.ainvoke(result)
```

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½å¼€å§‹ç†è§£ LangChain æºç ä¸­çš„è´£ä»»é“¾åº”ç”¨ï¼š

### 4.1 å®šä¹‰ Handler æŠ½è±¡ç±»

```python
from abc import ABC, abstractmethod
from typing import Optional, TypeVar, Generic

T = TypeVar("T")

class Handler(ABC, Generic[T]):
    """å¤„ç†è€…æŠ½è±¡åŸºç±»"""

    def __init__(self):
        self._next: Optional["Handler[T]"] = None

    def set_next(self, handler: "Handler[T]") -> "Handler[T]":
        self._next = handler
        return handler

    @abstractmethod
    def handle(self, request: T) -> Optional[str]:
        pass
```

### 4.2 å®ç°å…·ä½“ Handler

```python
class ConcreteHandler(Handler[dict]):
    """å…·ä½“å¤„ç†è€…æ¨¡æ¿"""

    def handle(self, request: dict) -> Optional[str]:
        # åˆ¤æ–­æ˜¯å¦èƒ½å¤„ç†
        if self._can_handle(request):
            return self._do_handle(request)

        # ä¼ é€’ç»™ä¸‹ä¸€ä¸ª
        if self._next:
            return self._next.handle(request)
        return None

    def _can_handle(self, request: dict) -> bool:
        """åˆ¤æ–­æ˜¯å¦èƒ½å¤„ç†ï¼ˆå­ç±»å®ç°ï¼‰"""
        return True

    def _do_handle(self, request: dict) -> str:
        """å…·ä½“å¤„ç†é€»è¾‘ï¼ˆå­ç±»å®ç°ï¼‰"""
        return f"Handled: {request}"
```

### 4.3 ç»„è£…é“¾

```python
# æ–¹å¼1ï¼šé“¾å¼è°ƒç”¨
handler1.set_next(handler2).set_next(handler3)

# æ–¹å¼2ï¼šä»åˆ—è¡¨æ„å»º
def build_chain(handlers: list) -> Handler:
    for i in range(len(handlers) - 1):
        handlers[i].set_next(handlers[i + 1])
    return handlers[0]

chain = build_chain([handler1, handler2, handler3])
```

### 4.4 ä¼ é€’è¯·æ±‚

```python
# ä»é“¾å¤´å¼€å§‹å¤„ç†
result = chain.handle({"type": "query", "data": "..."})

# è¯·æ±‚ä¼šè‡ªåŠ¨æ²¿é“¾ä¼ é€’
# handler1 â†’ handler2 â†’ handler3
```

### 4.5 ä¸­æ–­é“¾æ¡ä»¶

```python
class EarlyStopHandler(Handler[dict]):
    def handle(self, request: dict) -> Optional[str]:
        if request.get("stop"):
            return "Stopped early"  # è¿”å›ç»“æœï¼Œä¸å†ä¼ é€’

        if self._next:
            return self._next.handle(request)
        return None
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£ LangChain Callback ç³»ç»Ÿçš„è®¾è®¡
- å®ç°ç®€å•çš„è¯·æ±‚å¤„ç†é“¾
- ç†è§£ä¸­é—´ä»¶æ¶æ„çš„å·¥ä½œåŸç†
- ä¸ºå­¦ä¹ æ›´å¤æ‚çš„é“¾å¼ç»„åˆæ‰“åŸºç¡€

---

## 5. ã€1ä¸ªç±»æ¯”ï¼ˆåŒè½¨ï¼‰ã€‘

### ç±»æ¯”1ï¼šè¯·æ±‚å¤„ç†é“¾

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šExpress.js ä¸­é—´ä»¶

Express.js çš„ä¸­é—´ä»¶å°±æ˜¯å…¸å‹çš„è´£ä»»é“¾æ¨¡å¼ï¼š

```javascript
// JavaScript - Express ä¸­é—´ä»¶
const express = require('express');
const app = express();

// ä¸­é—´ä»¶1ï¼šæ—¥å¿—
app.use((req, res, next) => {
    console.log(`[LOG] ${req.method} ${req.url}`);
    next();  // ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
});

// ä¸­é—´ä»¶2ï¼šè®¤è¯
app.use((req, res, next) => {
    if (!req.headers.authorization) {
        return res.status(401).send('Unauthorized');  // ä¸­æ–­é“¾
    }
    next();  // ä¼ é€’
});

// ä¸­é—´ä»¶3ï¼šä¸šåŠ¡å¤„ç†
app.get('/api/data', (req, res) => {
    res.json({ data: 'Hello' });  // é“¾çš„ç»ˆç‚¹
});

// è¯·æ±‚æµå‘ï¼šæ—¥å¿— â†’ è®¤è¯ â†’ ä¸šåŠ¡å¤„ç†
```

```python
# Python - å¯¹åº”çš„è´£ä»»é“¾å®ç°
class ExpressLikeMiddleware(ABC):
    def __init__(self):
        self._next = None

    def use(self, middleware):
        if self._next is None:
            self._next = middleware
        else:
            self._next.use(middleware)
        return self

    def handle(self, req, res):
        result = self._do_handle(req, res)
        if result is None and self._next:  # next() è¢«è°ƒç”¨
            return self._next.handle(req, res)
        return result

class LoggingMiddleware(ExpressLikeMiddleware):
    def _do_handle(self, req, res):
        print(f"[LOG] {req['method']} {req['url']}")
        return None  # ç›¸å½“äº next()

class AuthMiddleware(ExpressLikeMiddleware):
    def _do_handle(self, req, res):
        if 'authorization' not in req.get('headers', {}):
            return {'status': 401, 'body': 'Unauthorized'}
        return None  # next()
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šä¼ çº¸æ¡æ¸¸æˆ

æƒ³è±¡ä¸€ä¸‹è¯¾å ‚ä¸Šä¼ çº¸æ¡çš„æ¸¸æˆï¼š

**åœºæ™¯**ï¼šå°æ˜æƒ³ç»™æœ€åä¸€æ’çš„å°çº¢ä¼ çº¸æ¡

```
å°æ˜ â†’ å°æ â†’ å°ç‹ â†’ å°å¼  â†’ å°çº¢
  â†“      â†“      â†“      â†“      â†“
 å†™çº¸æ¡  çœ‹ä¸€çœ¼  çœ‹ä¸€çœ¼  çœ‹ä¸€çœ¼  æ”¶åˆ°ï¼
        ä¼ ä¸‹å»  ä¼ ä¸‹å»  ä¼ ä¸‹å»
```

**è´£ä»»é“¾çš„å¯¹åº”å…³ç³»**ï¼š
- **çº¸æ¡** = è¯·æ±‚
- **æ¯ä¸ªåŒå­¦** = å¤„ç†è€…ï¼ˆHandlerï¼‰
- **ä¼ ä¸‹å»** = è°ƒç”¨ next
- **è€å¸ˆå‘ç°** = ä¸­æ–­é“¾ï¼ˆå¼‚å¸¸å¤„ç†ï¼‰

**ç”Ÿæ´»ä¾‹å­ - è¯·å‡å®¡æ‰¹**ï¼š

```
å­¦ç”Ÿè¯·å‡ â†’ ç­é•¿ â†’ ç­ä¸»ä»» â†’ å¹´çº§ä¸»ä»» â†’ æ ¡é•¿
             â†“        â†“         â†“        â†“
           åŠå¤©å‡   ä¸€å¤©å‡    ä¸‰å¤©å‡   ä¸€å‘¨å‡
           (å¯æ‰¹)   (å¯æ‰¹)    (å¯æ‰¹)   (å¯æ‰¹)
```

- è¯·å‡åŠå¤©ï¼šç­é•¿å°±èƒ½æ‰¹å‡†ï¼Œé“¾åˆ°æ­¤ç»“æŸ
- è¯·å‡ä¸‰å¤©ï¼šç­é•¿å’Œç­ä¸»ä»»éƒ½è¯´"ä¸æ˜¯æˆ‘èƒ½æ‰¹çš„"ï¼Œä¼ ç»™å¹´çº§ä¸»ä»»

---

### ç±»æ¯”2ï¼šäº‹ä»¶ä¼ é€’

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šDOM äº‹ä»¶å†’æ³¡

DOM äº‹ä»¶å†’æ³¡æ˜¯è´£ä»»é“¾çš„ä¸€ä¸ªå˜ä½“ï¼š

```javascript
// JavaScript - äº‹ä»¶å†’æ³¡
<div id="grandparent">
  <div id="parent">
    <button id="child">Click me</button>
  </div>
</div>

<script>
// äº‹ä»¶ä» child å†’æ³¡åˆ° parentï¼Œå†åˆ° grandparent
document.getElementById('child').addEventListener('click', (e) => {
    console.log('Child clicked');
    // e.stopPropagation();  // å¯ä»¥é˜»æ­¢å†’æ³¡ï¼ˆä¸­æ–­é“¾ï¼‰
});

document.getElementById('parent').addEventListener('click', (e) => {
    console.log('Parent clicked');
});

document.getElementById('grandparent').addEventListener('click', (e) => {
    console.log('Grandparent clicked');
});

// ç‚¹å‡» button è¾“å‡ºï¼š
// Child clicked
// Parent clicked
// Grandparent clicked
</script>
```

```python
# Python - äº‹ä»¶å†’æ³¡çš„è´£ä»»é“¾å®ç°
class EventHandler:
    def __init__(self, name: str):
        self.name = name
        self._parent = None

    def set_parent(self, parent):
        self._parent = parent
        return parent

    def handle_event(self, event: dict, propagate: bool = True):
        print(f"{self.name} received event: {event['type']}")

        # å¯ä»¥é€‰æ‹©æ˜¯å¦ç»§ç»­å†’æ³¡
        if propagate and self._parent:
            self._parent.handle_event(event)

child = EventHandler("Child")
parent = EventHandler("Parent")
grandparent = EventHandler("Grandparent")

child.set_parent(parent).set_parent(grandparent)

child.handle_event({"type": "click"})
# Child received event: click
# Parent received event: click
# Grandparent received event: click
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šå‡»é¼“ä¼ èŠ±

**åœºæ™¯**ï¼šéŸ³ä¹åœæ­¢æ—¶ï¼ŒèŠ±åœ¨è°æ‰‹é‡Œè°å°±è¦è¡¨æ¼”

```
    ğŸµ éŸ³ä¹å“èµ· ğŸµ
         â†“
å°æ˜ â†’ å°æ â†’ å°ç‹ â†’ å°å¼  â†’ å°çº¢
  ğŸŒ¸    ğŸŒ¸â†’    â†’ğŸŒ¸    ...
  â†“
ä¼ ç»™ä¸‹ä¸€ä¸ªäºº
  â†“
    ğŸµ éŸ³ä¹åœæ­¢ ğŸµ
         â†“
   èŠ±åœ¨è°æ‰‹é‡Œè°è¡¨æ¼”ï¼
```

**è´£ä»»é“¾çš„å¯¹åº”å…³ç³»**ï¼š
- **èŠ±** = è¯·æ±‚
- **æ¯ä¸ªå°æœ‹å‹** = å¤„ç†è€…
- **éŸ³ä¹åœæ­¢** = æŸä¸ªå¤„ç†è€…å†³å®š"æˆ‘æ¥å¤„ç†"
- **ä¼ ç»™ä¸‹ä¸€ä¸ª** = è°ƒç”¨ next

---

### ç±»æ¯”3ï¼šç®¡é“å¤„ç†

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šRxJS ç®¡é“æ“ä½œç¬¦

```javascript
// JavaScript - RxJS ç®¡é“
import { of } from 'rxjs';
import { map, filter, tap } from 'rxjs/operators';

of(1, 2, 3, 4, 5)
  .pipe(
    tap(x => console.log('åŸå§‹å€¼:', x)),      // å¤„ç†è€…1ï¼šæ—¥å¿—
    filter(x => x % 2 === 0),                 // å¤„ç†è€…2ï¼šè¿‡æ»¤
    map(x => x * 10),                         // å¤„ç†è€…3ï¼šè½¬æ¢
    tap(x => console.log('æœ€ç»ˆå€¼:', x))       // å¤„ç†è€…4ï¼šæ—¥å¿—
  )
  .subscribe();

// è¾“å‡ºï¼š
// åŸå§‹å€¼: 1
// åŸå§‹å€¼: 2
// æœ€ç»ˆå€¼: 20
// åŸå§‹å€¼: 3
// åŸå§‹å€¼: 4
// æœ€ç»ˆå€¼: 40
// åŸå§‹å€¼: 5
```

```python
# Python - ç®¡é“å¼å¤„ç†é“¾
class PipeHandler:
    def __init__(self, transform=None):
        self._next = None
        self._transform = transform or (lambda x: x)

    def pipe(self, handler):
        if self._next is None:
            self._next = handler
        else:
            self._next.pipe(handler)
        return self

    def process(self, value):
        result = self._transform(value)
        if result is not None and self._next:
            return self._next.process(result)
        return result

# æ„å»ºç®¡é“
pipeline = PipeHandler(lambda x: x)  # å…¥å£
pipeline.pipe(PipeHandler(lambda x: x * 2))  # ä¹˜2
pipeline.pipe(PipeHandler(lambda x: x + 10))  # åŠ 10
pipeline.pipe(PipeHandler(lambda x: f"Result: {x}"))  # æ ¼å¼åŒ–

print(pipeline.process(5))  # Result: 20
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šé£Ÿå ‚æ‰“é¥­æµç¨‹

**åœºæ™¯**ï¼šå­¦æ ¡é£Ÿå ‚æ‰“é¥­

```
å­¦ç”Ÿæ‹¿ç›˜å­ â†’ æ‰“ç±³é¥­ â†’ æ‰“èœ â†’ æ‰“æ±¤ â†’ ç»“è´¦
    â†“          â†“       â†“      â†“      â†“
  ç©ºç›˜å­     +ç±³é¥­    +èœ    +æ±¤   ä»˜é’±èµ°äºº
```

**è´£ä»»é“¾çš„å¯¹åº”å…³ç³»**ï¼š
- **ç›˜å­** = è¯·æ±‚ï¼ˆä¸æ–­è¢«æ·»åŠ å†…å®¹ï¼‰
- **æ¯ä¸ªçª—å£** = å¤„ç†è€…
- **ä¼ é€’ç›˜å­** = è°ƒç”¨ next
- **ä¸æƒ³è¦æŸæ ·** = è·³è¿‡æŸä¸ªå¤„ç†è€…

---

### ç±»æ¯”æ€»ç»“è¡¨

| LangChain æ¦‚å¿µ | å‰ç«¯ç±»æ¯” | å°æœ‹å‹ç±»æ¯” |
|---------------|---------|-----------|
| Handler | Express ä¸­é—´ä»¶ | ä¼ çº¸æ¡çš„åŒå­¦ |
| set_next() | app.use() | æŒ‡å®šä¸‹ä¸€ä¸ªäºº |
| handle() | (req, res, next) | å†³å®šä¼ è¿˜æ˜¯å¤„ç† |
| ä¸­æ–­é“¾ | res.send() / ä¸è°ƒç”¨ next() | è€å¸ˆå‘ç°çº¸æ¡ |
| è¯·æ±‚å¯¹è±¡ | req å¯¹è±¡ | çº¸æ¡å†…å®¹ |
| é“¾çš„ç»„è£… | ä¸­é—´ä»¶æ³¨å†Œé¡ºåº | åº§ä½é¡ºåº |
| Callback Handler | äº‹ä»¶ç›‘å¬å™¨ | å‡»é¼“ä¼ èŠ±çš„æ¯ä¸ªäºº |
| CallbackManager | äº‹ä»¶åˆ†å‘å™¨ | æ¸¸æˆä¸»æŒäºº |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šè´£ä»»é“¾å¿…é¡»æœ‰äººå¤„ç†è¯·æ±‚ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- è´£ä»»é“¾å¯ä»¥è®¾è®¡æˆ"æ— äººå¤„ç†"ä¹Ÿæ˜¯åˆæ³•çŠ¶æ€
- ä¸æ˜¯æ‰€æœ‰è¯·æ±‚éƒ½å¿…é¡»è¢«å¤„ç†
- é“¾çš„æœ«ç«¯å¯ä»¥æ˜¯é»˜è®¤å¤„ç†æˆ–ç©ºæ“ä½œ

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- ç›´è§‰ä¸Šï¼Œå‘å‡ºè¯·æ±‚å°±åº”è¯¥å¾—åˆ°å“åº”
- ç±»æ¯”ç°å®ä¸­çš„æœåŠ¡ï¼šä½ ç‚¹é¤æ€»ä¼šæœ‰äººå“åº”
- ä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œ"æ²¡æœ‰å¤„ç†è€…"æ˜¯æ­£å¸¸æƒ…å†µ

**æ­£ç¡®ç†è§£ï¼š**

```python
# æ­£ç¡®ï¼šé“¾æœ«ç«¯å¯ä»¥ä¸å¤„ç†
class DefaultHandler(Handler):
    """é»˜è®¤å¤„ç†è€… - é“¾çš„æœ«ç«¯"""

    def handle(self, request: dict) -> Optional[str]:
        # æ–¹å¼1ï¼šè¿”å› Noneï¼Œè¡¨ç¤º"æ²¡äººå¤„ç†"
        return None

        # æ–¹å¼2ï¼šè¿”å›é»˜è®¤å€¼
        # return "No handler found"

        # æ–¹å¼3ï¼šè®°å½•æ—¥å¿—ï¼Œä½†ä¸å¤„ç†
        # print(f"Unhandled request: {request}")
        # return None

# ä½¿ç”¨åœºæ™¯ï¼šäº‹ä»¶è¿‡æ»¤
class EventFilter(Handler):
    """åªå¤„ç†ç‰¹å®šç±»å‹çš„äº‹ä»¶"""

    def __init__(self, event_type: str):
        super().__init__()
        self._event_type = event_type

    def handle(self, request: dict) -> Optional[str]:
        if request.get("type") == self._event_type:
            return f"Handled {self._event_type} event"
        # ä¸æ˜¯æˆ‘çš„ç±»å‹ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ª
        if self._next:
            return self._next.handle(request)
        # é“¾æœ«ç«¯ï¼Œæ²¡äººå¤„ç†ä¹Ÿæ˜¯æ­£å¸¸çš„
        return None

# é“¾ä¸­å¯èƒ½æ²¡æœ‰å¤„ç†è€…åŒ¹é…
click_filter = EventFilter("click")
scroll_filter = EventFilter("scroll")
click_filter.set_next(scroll_filter)

result = click_filter.handle({"type": "hover"})  # hover æ²¡äººå¤„ç†
print(result)  # None - è¿™æ˜¯åˆæ³•çš„ï¼
```

---

### è¯¯åŒº2ï¼šè´£ä»»é“¾å°±æ˜¯é“¾è¡¨æ•°æ®ç»“æ„ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- è´£ä»»é“¾æ˜¯**è¡Œä¸ºæ¨¡å¼**ï¼Œå…³æ³¨çš„æ˜¯"å¤„ç†é€»è¾‘çš„ä¼ é€’"
- é“¾è¡¨æ˜¯**æ•°æ®ç»“æ„**ï¼Œå…³æ³¨çš„æ˜¯"æ•°æ®çš„å­˜å‚¨å’Œéå†"
- è´£ä»»é“¾å¯ä»¥ç”¨é“¾è¡¨å®ç°ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨å…¶ä»–æ–¹å¼ï¼ˆåˆ—è¡¨ã€æ ‘ã€å›¾ï¼‰

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- åå­—é‡Œæœ‰"é“¾"ï¼Œå®¹æ˜“è”æƒ³åˆ°é“¾è¡¨
- æœ€å¸¸è§çš„å®ç°ç¡®å®æ˜¯é“¾å¼ç»“æ„
- å¿½ç•¥äº†"è´£ä»»"äºŒå­—çš„å«ä¹‰

**æ­£ç¡®ç†è§£ï¼š**

```python
# æ–¹å¼1ï¼šé“¾è¡¨å®ç°ï¼ˆæœ€å¸¸è§ï¼‰
class LinkedHandler:
    def __init__(self):
        self._next = None  # æŒ‡å‘ä¸‹ä¸€ä¸ª

    def handle(self, request):
        if self._can_handle(request):
            return self._do_handle(request)
        if self._next:
            return self._next.handle(request)

# æ–¹å¼2ï¼šåˆ—è¡¨å®ç°ï¼ˆLangChain çš„ CallbackManagerï¼‰
class ListBasedChain:
    def __init__(self, handlers: list):
        self._handlers = handlers

    def handle(self, request):
        for handler in self._handlers:
            result = handler.handle(request)
            if result is not None:
                return result
        return None

# æ–¹å¼3ï¼šä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°
import heapq

class PriorityHandler:
    def __init__(self, priority: int):
        self.priority = priority

    def __lt__(self, other):
        return self.priority < other.priority

class PriorityChain:
    def __init__(self):
        self._handlers = []

    def add(self, handler: PriorityHandler):
        heapq.heappush(self._handlers, handler)

    def handle(self, request):
        # æŒ‰ä¼˜å…ˆçº§é¡ºåºå°è¯•å¤„ç†
        for handler in sorted(self._handlers):
            result = handler.handle(request)
            if result is not None:
                return result

# æ–¹å¼4ï¼šæ ‘å½¢ç»“æ„ï¼ˆåˆ†ç±»å¤„ç†ï¼‰
class TreeHandler:
    def __init__(self):
        self._children = {}  # æŒ‰ç±»å‹åˆ†æ”¯

    def add_child(self, type_name: str, handler):
        self._children[type_name] = handler

    def handle(self, request):
        request_type = request.get("type")
        if request_type in self._children:
            return self._children[request_type].handle(request)
        return None
```

**å…³é”®åŒºåˆ«ï¼š**

| ç‰¹å¾ | é“¾è¡¨ï¼ˆæ•°æ®ç»“æ„ï¼‰ | è´£ä»»é“¾ï¼ˆè®¾è®¡æ¨¡å¼ï¼‰ |
|------|-----------------|-------------------|
| å…³æ³¨ç‚¹ | æ•°æ®å¦‚ä½•å­˜å‚¨å’Œéå† | è¯·æ±‚å¦‚ä½•è¢«å¤„ç† |
| æ ¸å¿ƒæ“ä½œ | insert, delete, traverse | handle, set_next |
| èŠ‚ç‚¹å…³ç³» | æ•°æ®èŠ‚ç‚¹ | å¤„ç†è€…å¯¹è±¡ |
| éå†ç›®çš„ | è®¿é—®æ¯ä¸ªæ•°æ® | æ‰¾åˆ°èƒ½å¤„ç†çš„äºº |
| å®ç°æ–¹å¼ | åªèƒ½æ˜¯é“¾å¼ | é“¾å¼/åˆ—è¡¨/æ ‘/å›¾ |

---

### è¯¯åŒº3ï¼šè´£ä»»é“¾ä¼šé™ä½æ€§èƒ½ï¼ˆéå†æ•´ä¸ªé“¾ï¼‰ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- çŸ­è·¯å¤„ç†å¯ä»¥æå‰ç»ˆæ­¢ï¼Œä¸éœ€è¦éå†æ•´ä¸ªé“¾
- è§£è€¦å¸¦æ¥çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§æ›´é‡è¦
- å®é™…åœºæ™¯ä¸­é“¾çš„é•¿åº¦é€šå¸¸å¾ˆçŸ­ï¼ˆ5-10ä¸ªå¤„ç†è€…ï¼‰

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
- ç›´è§‰ä¸Šï¼Œå¤šä¸ªå¤„ç†è€… = å¤šæ¬¡åˆ¤æ–­ = æ€§èƒ½ä¸‹é™
- å¿½ç•¥äº†"çŸ­è·¯"æœºåˆ¶
- è¿‡åº¦ä¼˜åŒ–å¿ƒç†ï¼ˆpremature optimizationï¼‰

**æ­£ç¡®ç†è§£ï¼š**

```python
import time

# æ€§èƒ½æµ‹è¯•ï¼šè´£ä»»é“¾ vs if-else
class PerfTestHandler:
    def __init__(self, name: str, can_handle: bool = False):
        self._next = None
        self.name = name
        self._can_handle = can_handle

    def set_next(self, handler):
        self._next = handler
        return handler

    def handle(self, request):
        if self._can_handle:
            return f"Handled by {self.name}"
        if self._next:
            return self._next.handle(request)
        return None

def test_chain_performance():
    """æµ‹è¯•è´£ä»»é“¾æ€§èƒ½"""

    # æ„å»ºä¸€ä¸ª10å±‚çš„é“¾ï¼Œç¬¬3ä¸ªèƒ½å¤„ç†
    handlers = [PerfTestHandler(f"H{i}", i == 2) for i in range(10)]
    for i in range(len(handlers) - 1):
        handlers[i].set_next(handlers[i + 1])

    chain = handlers[0]

    # æµ‹è¯•
    start = time.perf_counter()
    for _ in range(100000):
        chain.handle({})
    chain_time = time.perf_counter() - start

    print(f"Chain (100k calls): {chain_time:.4f}s")

    # å¯¹æ¯”ï¼šif-else
    def if_else_handler(request):
        handlers_check = [False, False, True, False, False, False, False, False, False, False]
        for i, can_handle in enumerate(handlers_check):
            if can_handle:
                return f"Handled by H{i}"
        return None

    start = time.perf_counter()
    for _ in range(100000):
        if_else_handler({})
    ifelse_time = time.perf_counter() - start

    print(f"If-else (100k calls): {ifelse_time:.4f}s")
    print(f"Ratio: {chain_time / ifelse_time:.2f}x")

# å…¸å‹è¾“å‡ºï¼š
# Chain (100k calls): 0.0821s
# If-else (100k calls): 0.0312s
# Ratio: 2.63x

# ç»“è®ºï¼š
# 1. è´£ä»»é“¾ç¡®å®æœ‰è½»å¾®å¼€é”€ï¼ˆæ–¹æ³•è°ƒç”¨ vs å¾ªç¯ï¼‰
# 2. ä½† 100k æ¬¡è°ƒç”¨åªå·® 0.05sï¼Œå®é™…å¯å¿½ç•¥
# 3. çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§çš„æ”¶ç›Šè¿œå¤§äºæ€§èƒ½æŸå¤±
```

**å®é™…åœºæ™¯åˆ†æï¼š**

| åœºæ™¯ | é“¾é•¿åº¦ | è°ƒç”¨é¢‘ç‡ | æ€§èƒ½å½±å“ | æ˜¯å¦ä½¿ç”¨è´£ä»»é“¾ |
|------|--------|----------|----------|--------------|
| HTTP ä¸­é—´ä»¶ | 5-10 | 100æ¬¡/ç§’ | å¯å¿½ç•¥ | âœ… æ¨è |
| LLM Callback | 3-5 | 1æ¬¡/ç§’ | å¯å¿½ç•¥ | âœ… æ¨è |
| æ—¥å¿—å¤„ç† | 3-4 | 1000æ¬¡/ç§’ | è½»å¾® | âœ… å¯ç”¨ |
| çƒ­ç‚¹æ•°æ®è¿‡æ»¤ | 10+ | 10ä¸‡æ¬¡/ç§’ | æ˜æ˜¾ | âš ï¸ æ…ç”¨ |
| å®æ—¶æ¸¸æˆé€»è¾‘ | - | 60æ¬¡/å¸§ | éœ€æµ‹è¯• | è§†æƒ…å†µ |

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

```python
"""
å®æˆ˜ç¤ºä¾‹ï¼šLLM åº”ç”¨ä¸­çš„è´£ä»»é“¾æ¨¡å¼

æ¼”ç¤ºåœºæ™¯ï¼š
1. æ—¥å¿—çº§åˆ«å¤„ç†é“¾
2. HTTP è¯·æ±‚å¤„ç†é“¾
3. LangChain Callback ç³»ç»Ÿæ¨¡æ‹Ÿ
4. åŠ¨æ€é“¾ç»„è£…
"""

from abc import ABC, abstractmethod
from typing import Optional, Any, Dict, List, Callable
from dataclasses import dataclass, field
from enum import Enum, auto
from datetime import datetime
import json
import time

# ============================================================
# åœºæ™¯1ï¼šæ—¥å¿—çº§åˆ«å¤„ç†é“¾
# ============================================================

class LogLevel(Enum):
    DEBUG = 10
    INFO = 20
    WARNING = 30
    ERROR = 40
    CRITICAL = 50

@dataclass
class LogRecord:
    """æ—¥å¿—è®°å½•"""
    level: LogLevel
    message: str
    timestamp: datetime = field(default_factory=datetime.now)
    extra: Dict[str, Any] = field(default_factory=dict)

class LogHandler(ABC):
    """æ—¥å¿—å¤„ç†å™¨åŸºç±»"""

    def __init__(self, level: LogLevel):
        self._level = level
        self._next: Optional["LogHandler"] = None

    def set_next(self, handler: "LogHandler") -> "LogHandler":
        self._next = handler
        return handler

    def handle(self, record: LogRecord) -> None:
        """å¤„ç†æ—¥å¿—è®°å½•"""
        # çº§åˆ«è¶³å¤Ÿæ‰å¤„ç†
        if record.level.value >= self._level.value:
            self._write(record)

        # æ€»æ˜¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ªï¼ˆæ—¥å¿—åœºæ™¯ï¼šæ‰€æœ‰åˆæ ¼çš„å¤„ç†å™¨éƒ½å¤„ç†ï¼‰
        if self._next:
            self._next.handle(record)

    @abstractmethod
    def _write(self, record: LogRecord) -> None:
        """å†™å…¥æ—¥å¿—ï¼ˆå­ç±»å®ç°ï¼‰"""
        pass

class ConsoleLogHandler(LogHandler):
    """æ§åˆ¶å°æ—¥å¿—å¤„ç†å™¨"""

    def _write(self, record: LogRecord) -> None:
        color = {
            LogLevel.DEBUG: "\033[36m",     # é’è‰²
            LogLevel.INFO: "\033[32m",      # ç»¿è‰²
            LogLevel.WARNING: "\033[33m",   # é»„è‰²
            LogLevel.ERROR: "\033[31m",     # çº¢è‰²
            LogLevel.CRITICAL: "\033[35m",  # ç´«è‰²
        }
        reset = "\033[0m"
        c = color.get(record.level, "")
        print(f"{c}[{record.level.name}] {record.timestamp.strftime('%H:%M:%S')} - {record.message}{reset}")

class FileLogHandler(LogHandler):
    """æ–‡ä»¶æ—¥å¿—å¤„ç†å™¨"""

    def __init__(self, level: LogLevel, filename: str = "app.log"):
        super().__init__(level)
        self._filename = filename
        self._logs: List[str] = []  # æ¨¡æ‹Ÿæ–‡ä»¶å†™å…¥

    def _write(self, record: LogRecord) -> None:
        log_line = json.dumps({
            "level": record.level.name,
            "message": record.message,
            "timestamp": record.timestamp.isoformat(),
            "extra": record.extra
        })
        self._logs.append(log_line)
        print(f"[File:{self._filename}] Written: {record.level.name}")

    def get_logs(self) -> List[str]:
        return self._logs

class AlertLogHandler(LogHandler):
    """å‘Šè­¦æ—¥å¿—å¤„ç†å™¨ï¼ˆåªå¤„ç† ERROR åŠä»¥ä¸Šï¼‰"""

    def __init__(self):
        super().__init__(LogLevel.ERROR)
        self._alerts: List[str] = []

    def _write(self, record: LogRecord) -> None:
        alert = f"ğŸš¨ ALERT: {record.message}"
        self._alerts.append(alert)
        print(f"[Alert] Sending notification: {record.level.name}")

def demo_log_chain():
    """æ¼”ç¤ºæ—¥å¿—å¤„ç†é“¾"""
    print("=" * 60)
    print("åœºæ™¯1ï¼šæ—¥å¿—çº§åˆ«å¤„ç†é“¾")
    print("=" * 60)

    # æ„å»ºå¤„ç†é“¾
    console = ConsoleLogHandler(LogLevel.DEBUG)
    file_handler = FileLogHandler(LogLevel.INFO, "app.log")
    alert = AlertLogHandler()

    console.set_next(file_handler).set_next(alert)

    # å‘é€ä¸åŒçº§åˆ«çš„æ—¥å¿—
    logs = [
        LogRecord(LogLevel.DEBUG, "è°ƒè¯•ä¿¡æ¯ï¼šå˜é‡ x = 10"),
        LogRecord(LogLevel.INFO, "ç”¨æˆ·ç™»å½•æˆåŠŸ", extra={"user_id": "123"}),
        LogRecord(LogLevel.WARNING, "API å“åº”ç¼“æ…¢"),
        LogRecord(LogLevel.ERROR, "æ•°æ®åº“è¿æ¥å¤±è´¥", extra={"retry": 3}),
        LogRecord(LogLevel.CRITICAL, "ç³»ç»Ÿå†…å­˜ä¸è¶³"),
    ]

    for log in logs:
        print(f"\n--- å¤„ç† {log.level.name} æ—¥å¿— ---")
        console.handle(log)

    print(f"\næ–‡ä»¶æ—¥å¿—æ•°é‡: {len(file_handler.get_logs())}")
    print(f"å‘Šè­¦æ•°é‡: {len(alert._alerts)}")

# ============================================================
# åœºæ™¯2ï¼šHTTP è¯·æ±‚å¤„ç†é“¾ï¼ˆç±»ä¼¼ Express ä¸­é—´ä»¶ï¼‰
# ============================================================

@dataclass
class HTTPRequest:
    """HTTP è¯·æ±‚"""
    method: str
    path: str
    headers: Dict[str, str] = field(default_factory=dict)
    body: Dict[str, Any] = field(default_factory=dict)
    context: Dict[str, Any] = field(default_factory=dict)  # ä¸­é—´ä»¶æ·»åŠ çš„ä¸Šä¸‹æ–‡

@dataclass
class HTTPResponse:
    """HTTP å“åº”"""
    status: int = 200
    body: Any = None
    headers: Dict[str, str] = field(default_factory=dict)

class Middleware(ABC):
    """ä¸­é—´ä»¶åŸºç±»"""

    def __init__(self):
        self._next: Optional["Middleware"] = None

    def set_next(self, middleware: "Middleware") -> "Middleware":
        self._next = middleware
        return middleware

    def __call__(self, request: HTTPRequest) -> HTTPResponse:
        """å¤„ç†è¯·æ±‚"""
        # å‰ç½®å¤„ç†
        response = self._before(request)
        if response:
            return response  # çŸ­è·¯ï¼šç›´æ¥è¿”å›å“åº”

        # ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
        if self._next:
            response = self._next(request)
        else:
            response = HTTPResponse(status=404, body="Not Found")

        # åç½®å¤„ç†
        return self._after(request, response)

    def _before(self, request: HTTPRequest) -> Optional[HTTPResponse]:
        """å‰ç½®å¤„ç†ï¼Œè¿”å› Response è¡¨ç¤ºçŸ­è·¯"""
        return None

    def _after(self, request: HTTPRequest, response: HTTPResponse) -> HTTPResponse:
        """åç½®å¤„ç†"""
        return response

class LoggingMiddleware(Middleware):
    """æ—¥å¿—ä¸­é—´ä»¶"""

    def _before(self, request: HTTPRequest) -> Optional[HTTPResponse]:
        request.context["start_time"] = time.time()
        print(f"[â†’] {request.method} {request.path}")
        return None

    def _after(self, request: HTTPRequest, response: HTTPResponse) -> HTTPResponse:
        duration = time.time() - request.context.get("start_time", time.time())
        print(f"[â†] {response.status} ({duration:.4f}s)")
        return response

class AuthMiddleware(Middleware):
    """è®¤è¯ä¸­é—´ä»¶"""

    def __init__(self, valid_tokens: set = None):
        super().__init__()
        self._valid_tokens = valid_tokens or {"Bearer token123", "Bearer admin"}

    def _before(self, request: HTTPRequest) -> Optional[HTTPResponse]:
        auth = request.headers.get("Authorization")
        if not auth:
            return HTTPResponse(status=401, body={"error": "Missing Authorization"})
        if auth not in self._valid_tokens:
            return HTTPResponse(status=403, body={"error": "Invalid token"})

        # è§£æç”¨æˆ·ä¿¡æ¯
        request.context["user"] = auth.split()[-1]
        print(f"[Auth] User authenticated: {request.context['user']}")
        return None

class RateLimitMiddleware(Middleware):
    """é™æµä¸­é—´ä»¶"""

    def __init__(self, max_requests: int = 5):
        super().__init__()
        self._max = max_requests
        self._counts: Dict[str, int] = {}

    def _before(self, request: HTTPRequest) -> Optional[HTTPResponse]:
        user = request.context.get("user", "anonymous")
        self._counts[user] = self._counts.get(user, 0) + 1

        if self._counts[user] > self._max:
            return HTTPResponse(status=429, body={"error": "Rate limit exceeded"})

        print(f"[RateLimit] {user}: {self._counts[user]}/{self._max}")
        return None

class RouterMiddleware(Middleware):
    """è·¯ç”±ä¸­é—´ä»¶ï¼ˆé“¾çš„ç»ˆç‚¹ï¼‰"""

    def __init__(self):
        super().__init__()
        self._routes: Dict[str, Callable] = {}

    def route(self, method: str, path: str):
        """è£…é¥°å™¨ï¼šæ³¨å†Œè·¯ç”±"""
        def decorator(func: Callable):
            key = f"{method}:{path}"
            self._routes[key] = func
            return func
        return decorator

    def _before(self, request: HTTPRequest) -> Optional[HTTPResponse]:
        key = f"{request.method}:{request.path}"
        handler = self._routes.get(key)

        if handler:
            result = handler(request)
            return HTTPResponse(status=200, body=result)
        return None

def demo_http_chain():
    """æ¼”ç¤º HTTP ä¸­é—´ä»¶é“¾"""
    print("\n" + "=" * 60)
    print("åœºæ™¯2ï¼šHTTP è¯·æ±‚å¤„ç†é“¾")
    print("=" * 60)

    # æ„å»ºä¸­é—´ä»¶é“¾
    logging = LoggingMiddleware()
    auth = AuthMiddleware()
    rate_limit = RateLimitMiddleware(max_requests=3)
    router = RouterMiddleware()

    logging.set_next(auth).set_next(rate_limit).set_next(router)

    # æ³¨å†Œè·¯ç”±
    @router.route("GET", "/api/users")
    def get_users(request: HTTPRequest):
        return {"users": ["Alice", "Bob"], "requested_by": request.context.get("user")}

    @router.route("POST", "/api/orders")
    def create_order(request: HTTPRequest):
        return {"order_id": "12345", "status": "created"}

    # æµ‹è¯•è¯·æ±‚
    print("\n--- æµ‹è¯•1ï¼šæ­£å¸¸è¯·æ±‚ ---")
    req1 = HTTPRequest(
        method="GET",
        path="/api/users",
        headers={"Authorization": "Bearer token123"}
    )
    resp1 = logging(req1)
    print(f"Response: {resp1.body}")

    print("\n--- æµ‹è¯•2ï¼šæœªè®¤è¯ ---")
    req2 = HTTPRequest(method="GET", path="/api/users")
    resp2 = logging(req2)
    print(f"Response: {resp2.status} - {resp2.body}")

    print("\n--- æµ‹è¯•3ï¼šè§¦å‘é™æµ ---")
    for i in range(5):
        req = HTTPRequest(
            method="GET",
            path="/api/users",
            headers={"Authorization": "Bearer token123"}
        )
        resp = logging(req)
        if resp.status == 429:
            print(f"Request {i+1}: Rate limited!")
            break

# ============================================================
# åœºæ™¯3ï¼šLangChain Callback ç³»ç»Ÿæ¨¡æ‹Ÿ
# ============================================================

class LLMCallbackHandler(ABC):
    """LLM å›è°ƒå¤„ç†å™¨åŸºç±»"""

    def on_llm_start(self, prompts: List[str], **kwargs) -> None:
        """LLM å¼€å§‹è°ƒç”¨"""
        pass

    def on_llm_new_token(self, token: str, **kwargs) -> None:
        """æ”¶åˆ°æ–° tokenï¼ˆæµå¼ï¼‰"""
        pass

    def on_llm_end(self, response: str, **kwargs) -> None:
        """LLM è°ƒç”¨ç»“æŸ"""
        pass

    def on_llm_error(self, error: Exception, **kwargs) -> None:
        """LLM è°ƒç”¨å‡ºé”™"""
        pass

class StreamingCallbackHandler(LLMCallbackHandler):
    """æµå¼è¾“å‡ºå¤„ç†å™¨"""

    def on_llm_new_token(self, token: str, **kwargs) -> None:
        print(token, end="", flush=True)

    def on_llm_end(self, response: str, **kwargs) -> None:
        print()  # æ¢è¡Œ

class MetricsCallbackHandler(LLMCallbackHandler):
    """æ€§èƒ½æŒ‡æ ‡å¤„ç†å™¨"""

    def __init__(self):
        self._start_time = None
        self._token_count = 0

    def on_llm_start(self, prompts: List[str], **kwargs) -> None:
        self._start_time = time.time()
        self._token_count = 0
        print(f"[Metrics] Started with {len(prompts)} prompt(s)")

    def on_llm_new_token(self, token: str, **kwargs) -> None:
        self._token_count += 1

    def on_llm_end(self, response: str, **kwargs) -> None:
        duration = time.time() - self._start_time
        tps = self._token_count / duration if duration > 0 else 0
        print(f"[Metrics] Completed: {self._token_count} tokens in {duration:.2f}s ({tps:.1f} tokens/s)")

class CostCallbackHandler(LLMCallbackHandler):
    """æˆæœ¬è®¡ç®—å¤„ç†å™¨"""

    def __init__(self, cost_per_1k_tokens: float = 0.002):
        self._cost_per_1k = cost_per_1k_tokens
        self._total_tokens = 0

    def on_llm_end(self, response: str, **kwargs) -> None:
        # ç®€å•ä¼°ç®— token æ•°
        tokens = len(response.split())
        self._total_tokens += tokens
        cost = (self._total_tokens / 1000) * self._cost_per_1k
        print(f"[Cost] Estimated: ${cost:.6f} ({self._total_tokens} tokens)")

class CallbackManager:
    """å›è°ƒç®¡ç†å™¨ - ç®¡ç†å¤šä¸ª Handler"""

    def __init__(self, handlers: List[LLMCallbackHandler] = None):
        self._handlers = handlers or []

    def add_handler(self, handler: LLMCallbackHandler) -> None:
        self._handlers.append(handler)

    def on_llm_start(self, prompts: List[str], **kwargs) -> None:
        for handler in self._handlers:
            handler.on_llm_start(prompts, **kwargs)

    def on_llm_new_token(self, token: str, **kwargs) -> None:
        for handler in self._handlers:
            handler.on_llm_new_token(token, **kwargs)

    def on_llm_end(self, response: str, **kwargs) -> None:
        for handler in self._handlers:
            handler.on_llm_end(response, **kwargs)

    def on_llm_error(self, error: Exception, **kwargs) -> None:
        for handler in self._handlers:
            handler.on_llm_error(error, **kwargs)

class MockLLM:
    """æ¨¡æ‹Ÿ LLM"""

    def __init__(self, callback_manager: CallbackManager = None):
        self._callback_manager = callback_manager or CallbackManager()

    def invoke(self, prompt: str, stream: bool = False) -> str:
        """è°ƒç”¨ LLM"""
        self._callback_manager.on_llm_start([prompt])

        # æ¨¡æ‹Ÿç”Ÿæˆå“åº”
        response = "Hello! I am an AI assistant. How can I help you today?"

        if stream:
            for token in response.split():
                time.sleep(0.1)  # æ¨¡æ‹Ÿå»¶è¿Ÿ
                self._callback_manager.on_llm_new_token(token + " ")

        self._callback_manager.on_llm_end(response)
        return response

def demo_callback_chain():
    """æ¼”ç¤º LangChain Callback ç³»ç»Ÿ"""
    print("\n" + "=" * 60)
    print("åœºæ™¯3ï¼šLangChain Callback ç³»ç»Ÿ")
    print("=" * 60)

    # åˆ›å»ºå›è°ƒç®¡ç†å™¨
    manager = CallbackManager()
    manager.add_handler(StreamingCallbackHandler())
    manager.add_handler(MetricsCallbackHandler())
    manager.add_handler(CostCallbackHandler())

    # åˆ›å»º LLM
    llm = MockLLM(callback_manager=manager)

    # è°ƒç”¨ LLMï¼ˆæµå¼ï¼‰
    print("\n--- æµå¼è°ƒç”¨ ---")
    response = llm.invoke("Hello!", stream=True)

# ============================================================
# åœºæ™¯4ï¼šåŠ¨æ€é“¾ç»„è£…
# ============================================================

class DynamicChainBuilder:
    """åŠ¨æ€é“¾æ„å»ºå™¨"""

    _registry: Dict[str, type] = {}

    @classmethod
    def register(cls, name: str):
        """æ³¨å†Œå¤„ç†å™¨ç±»å‹"""
        def decorator(handler_class):
            cls._registry[name] = handler_class
            return handler_class
        return decorator

    @classmethod
    def build_from_config(cls, config: List[Dict[str, Any]]) -> "Middleware":
        """æ ¹æ®é…ç½®æ„å»ºé“¾"""
        handlers = []

        for item in config:
            name = item.get("name")
            params = item.get("params", {})
            enabled = item.get("enabled", True)

            if not enabled:
                continue

            handler_class = cls._registry.get(name)
            if handler_class:
                handlers.append(handler_class(**params))
            else:
                print(f"Warning: Unknown handler '{name}'")

        if not handlers:
            raise ValueError("No handlers configured")

        # ç»„è£…é“¾
        for i in range(len(handlers) - 1):
            handlers[i].set_next(handlers[i + 1])

        return handlers[0]

# æ³¨å†Œå¤„ç†å™¨
@DynamicChainBuilder.register("logging")
class RegisteredLoggingMiddleware(LoggingMiddleware):
    pass

@DynamicChainBuilder.register("auth")
class RegisteredAuthMiddleware(AuthMiddleware):
    pass

@DynamicChainBuilder.register("rate_limit")
class RegisteredRateLimitMiddleware(RateLimitMiddleware):
    pass

def demo_dynamic_chain():
    """æ¼”ç¤ºåŠ¨æ€é“¾ç»„è£…"""
    print("\n" + "=" * 60)
    print("åœºæ™¯4ï¼šåŠ¨æ€é“¾ç»„è£…")
    print("=" * 60)

    # é…ç½®æ–‡ä»¶ï¼ˆå¯ä»¥ä» YAML/JSON è¯»å–ï¼‰
    dev_config = [
        {"name": "logging", "enabled": True},
        {"name": "auth", "enabled": False},  # å¼€å‘ç¯å¢ƒç¦ç”¨è®¤è¯
        {"name": "rate_limit", "enabled": False},
    ]

    prod_config = [
        {"name": "logging", "enabled": True},
        {"name": "auth", "enabled": True, "params": {"valid_tokens": {"Bearer prod_token"}}},
        {"name": "rate_limit", "enabled": True, "params": {"max_requests": 100}},
    ]

    print("\n--- å¼€å‘ç¯å¢ƒé“¾ ---")
    print(f"Config: {dev_config}")
    try:
        dev_chain = DynamicChainBuilder.build_from_config(dev_config)
        req = HTTPRequest(method="GET", path="/test")
        dev_chain(req)
    except ValueError as e:
        print(f"Error: {e}")

    print("\n--- ç”Ÿäº§ç¯å¢ƒé“¾ ---")
    print(f"Config: {prod_config}")
    prod_chain = DynamicChainBuilder.build_from_config(prod_config)
    req = HTTPRequest(
        method="GET",
        path="/api/data",
        headers={"Authorization": "Bearer prod_token"}
    )
    resp = prod_chain(req)
    print(f"Response: {resp.status}")

# ============================================================
# ä¸»å‡½æ•°
# ============================================================

if __name__ == "__main__":
    demo_log_chain()
    demo_http_chain()
    demo_callback_chain()
    demo_dynamic_chain()
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**

```
============================================================
åœºæ™¯1ï¼šæ—¥å¿—çº§åˆ«å¤„ç†é“¾
============================================================

--- å¤„ç† DEBUG æ—¥å¿— ---
[DEBUG] 10:30:00 - è°ƒè¯•ä¿¡æ¯ï¼šå˜é‡ x = 10

--- å¤„ç† INFO æ—¥å¿— ---
[INFO] 10:30:00 - ç”¨æˆ·ç™»å½•æˆåŠŸ
[File:app.log] Written: INFO

--- å¤„ç† WARNING æ—¥å¿— ---
[WARNING] 10:30:00 - API å“åº”ç¼“æ…¢
[File:app.log] Written: WARNING

--- å¤„ç† ERROR æ—¥å¿— ---
[ERROR] 10:30:00 - æ•°æ®åº“è¿æ¥å¤±è´¥
[File:app.log] Written: ERROR
[Alert] Sending notification: ERROR

--- å¤„ç† CRITICAL æ—¥å¿— ---
[CRITICAL] 10:30:00 - ç³»ç»Ÿå†…å­˜ä¸è¶³
[File:app.log] Written: CRITICAL
[Alert] Sending notification: CRITICAL

æ–‡ä»¶æ—¥å¿—æ•°é‡: 4
å‘Šè­¦æ•°é‡: 2

============================================================
åœºæ™¯2ï¼šHTTP è¯·æ±‚å¤„ç†é“¾
============================================================

--- æµ‹è¯•1ï¼šæ­£å¸¸è¯·æ±‚ ---
[â†’] GET /api/users
[Auth] User authenticated: token123
[RateLimit] token123: 1/3
[â†] 200 (0.0001s)
Response: {'users': ['Alice', 'Bob'], 'requested_by': 'token123'}

--- æµ‹è¯•2ï¼šæœªè®¤è¯ ---
[â†’] GET /api/users
[â†] 401 (0.0001s)
Response: 401 - {'error': 'Missing Authorization'}

--- æµ‹è¯•3ï¼šè§¦å‘é™æµ ---
[â†’] GET /api/users
[Auth] User authenticated: token123
[RateLimit] token123: 2/3
[â†] 200 (0.0001s)
[â†’] GET /api/users
[Auth] User authenticated: token123
[RateLimit] token123: 3/3
[â†] 200 (0.0001s)
[â†’] GET /api/users
[Auth] User authenticated: token123
[â†] 429 (0.0001s)
Request 3: Rate limited!

============================================================
åœºæ™¯3ï¼šLangChain Callback ç³»ç»Ÿ
============================================================

--- æµå¼è°ƒç”¨ ---
[Metrics] Started with 1 prompt(s)
Hello! I am an AI assistant. How can I help you today?
[Metrics] Completed: 10 tokens in 1.01s (9.9 tokens/s)
[Cost] Estimated: $0.000020 (10 tokens)

============================================================
åœºæ™¯4ï¼šåŠ¨æ€é“¾ç»„è£…
============================================================

--- å¼€å‘ç¯å¢ƒé“¾ ---
Config: [{'name': 'logging', 'enabled': True}, ...]
[â†’] GET /test
[â†] 404 (0.0001s)

--- ç”Ÿäº§ç¯å¢ƒé“¾ ---
Config: [{'name': 'logging', 'enabled': True}, ...]
[â†’] GET /api/data
[Auth] User authenticated: prod_token
[RateLimit] prod_token: 1/100
[â†] 404 (0.0001s)
Response: 404
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"è´£ä»»é“¾æ¨¡å¼å’Œè§‚å¯Ÿè€…æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"è´£ä»»é“¾æ˜¯ä¸€ä¸ªå¤„ç†è¯·æ±‚ï¼Œè§‚å¯Ÿè€…æ˜¯å¤šä¸ªè§‚å¯Ÿã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **è´£ä»»é“¾å’Œè§‚å¯Ÿè€…æœ‰ä¸‰ä¸ªå…³é”®åŒºåˆ«ï¼š**
>
> 1. **ä¼ é€’æ–¹å¼ä¸åŒ**ï¼š
>    - è´£ä»»é“¾ï¼šè¯·æ±‚**é¡ºåºä¼ é€’**ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ª
>    - è§‚å¯Ÿè€…ï¼šäº‹ä»¶**å¹¿æ’­é€šçŸ¥**ï¼ŒåŒæ—¶é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…
>
> 2. **å¤„ç†è€…å…³ç³»ä¸åŒ**ï¼š
>    - è´£ä»»é“¾ï¼šå¤„ç†è€…å½¢æˆ**é“¾æ¡**ï¼Œæœ‰æ˜ç¡®çš„é¡ºåº
>    - è§‚å¯Ÿè€…ï¼šè§‚å¯Ÿè€…æ˜¯**å¹³ç­‰çš„**ï¼Œæ²¡æœ‰é¡ºåºå…³ç³»
>
> 3. **å¤„ç†ç»“æœä¸åŒ**ï¼š
>    - è´£ä»»é“¾ï¼šé€šå¸¸**ä¸€ä¸ªå¤„ç†è€…å¤„ç†**åå°±åœæ­¢ï¼ˆå¯é…ç½®ï¼‰
>    - è§‚å¯Ÿè€…ï¼š**æ‰€æœ‰è§‚å¯Ÿè€…éƒ½ä¼šæ”¶åˆ°é€šçŸ¥**
>
> **åœ¨ LangChain ä¸­çš„åº”ç”¨**ï¼š
>
> - **Callback ç³»ç»Ÿ**ï¼šæ›´åƒè§‚å¯Ÿè€…ï¼ˆæ‰€æœ‰ Handler éƒ½æ”¶åˆ°äº‹ä»¶ï¼‰
> - **ä¸­é—´ä»¶é“¾**ï¼šæ›´åƒè´£ä»»é“¾ï¼ˆè¯·æ±‚é¡ºåºç»è¿‡æ¯ä¸ªä¸­é—´ä»¶ï¼‰
> - **å®é™…ä¸Šæ˜¯æ··åˆæ¨¡å¼**ï¼šäº‹ä»¶å¹¿æ’­ç»™æ‰€æœ‰ Handlerï¼ˆè§‚å¯Ÿè€…ï¼‰ï¼Œä½† Handler å†…éƒ¨å¯ä»¥æœ‰é“¾å¼å¤„ç†ï¼ˆè´£ä»»é“¾ï¼‰
>
> ```python
> # è§‚å¯Ÿè€…ï¼šäº‹ä»¶å¹¿æ’­
> for handler in handlers:
>     handler.on_event(event)  # æ‰€æœ‰äººéƒ½å¤„ç†
>
> # è´£ä»»é“¾ï¼šé¡ºåºä¼ é€’
> def handle(request):
>     result = self.do_handle(request)
>     if result is None and self.next:
>         return self.next.handle(request)  # ä¼ ç»™ä¸‹ä¸€ä¸ª
> ```

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… ä»å¤šä¸ªç»´åº¦å¯¹æ¯”ï¼ˆä¼ é€’æ–¹å¼ã€å…³ç³»ã€ç»“æœï¼‰
2. âœ… ç»“åˆ LangChain å®é™…åº”ç”¨
3. âœ… æŒ‡å‡ºä¸¤ç§æ¨¡å¼å¯ä»¥æ··åˆä½¿ç”¨
4. âœ… æœ‰ä»£ç ç¤ºä¾‹è¯´æ˜åŒºåˆ«

---

### é—®é¢˜2ï¼š"åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹åº”è¯¥ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"éœ€è¦å¤šä¸ªå¯¹è±¡å¤„ç†è¯·æ±‚çš„æ—¶å€™ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **è´£ä»»é“¾æ¨¡å¼é€‚ç”¨äºä»¥ä¸‹å››ç±»åœºæ™¯ï¼š**
>
> 1. **è¯·æ±‚çš„å¤„ç†è€…ä¸ç¡®å®š**
>    - å‘é€è€…ä¸çŸ¥é“è°ä¼šå¤„ç†è¯·æ±‚
>    - ä¾‹ï¼šæ—¥å¿—ç³»ç»Ÿï¼Œä¸åŒçº§åˆ«çš„æ—¥å¿—ç”±ä¸åŒå¤„ç†å™¨å¤„ç†
>
> 2. **éœ€è¦åŠ¨æ€ç»„è£…å¤„ç†æµç¨‹**
>    - å¤„ç†é“¾å¯ä»¥åœ¨è¿è¡Œæ—¶é…ç½®
>    - ä¾‹ï¼šHTTP ä¸­é—´ä»¶ï¼Œæ ¹æ®ç¯å¢ƒå¯ç”¨/ç¦ç”¨ä¸åŒä¸­é—´ä»¶
>
> 3. **è¯·æ±‚éœ€è¦å¤šä¸ªå¤„ç†è€…ä¾æ¬¡å¤„ç†**
>    - æ¯ä¸ªå¤„ç†è€…å®Œæˆä¸€éƒ¨åˆ†å·¥ä½œ
>    - ä¾‹ï¼šæ•°æ®éªŒè¯é“¾ï¼ˆæ ¼å¼æ ¡éªŒ â†’ ä¸šåŠ¡æ ¡éªŒ â†’ æƒé™æ ¡éªŒï¼‰
>
> 4. **éœ€è¦è§£è€¦å‘é€è€…å’Œæ¥æ”¶è€…**
>    - å‘é€è€…åªå…³å¿ƒ"å‘å‡ºè¯·æ±‚"ï¼Œä¸å…³å¿ƒè°å¤„ç†
>    - ä¾‹ï¼šäº‹ä»¶ç³»ç»Ÿã€æ’ä»¶æ¶æ„
>
> **ä¸é€‚åˆçš„åœºæ™¯**ï¼š
> - å¤„ç†è€…å›ºå®šä¸”ç®€å•ï¼ˆç”¨ if-else æ›´ç›´è§‚ï¼‰
> - æ€§èƒ½æ•æ„Ÿçš„çƒ­ç‚¹è·¯å¾„ï¼ˆæœ‰è½»å¾®å¼€é”€ï¼‰
> - å¤„ç†è€…ä¹‹é—´æœ‰å¤æ‚ä¾èµ–ï¼ˆè´£ä»»é“¾æ˜¯çº¿æ€§çš„ï¼‰
>
> **LangChain ä¸­çš„å®é™…åº”ç”¨**ï¼š
>
> | åœºæ™¯ | ä½¿ç”¨åŸå›  |
> |------|---------|
> | Callback ç³»ç»Ÿ | ç”¨æˆ·å¯ä»¥è‡ªç”±æ·»åŠ ç›‘å¬å™¨ |
> | è¾“å‡ºè§£æé“¾ | å¤šç§è§£æå™¨ä¾æ¬¡å°è¯• |
> | é‡è¯•æœºåˆ¶ | å¤±è´¥åå°è¯•ä¸‹ä¸€ä¸ªç­–ç•¥ |
> | RAG æ£€ç´¢ | å¤šä¸ªæ£€ç´¢å™¨ä¾æ¬¡æ£€ç´¢ |

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… åˆ†ç±»æ˜ç¡®ï¼Œè¦†ç›–å››ç§åœºæ™¯
2. âœ… æ¯ä¸ªåœºæ™¯æœ‰å…·ä½“ä¾‹å­
3. âœ… æŒ‡å‡ºä¸é€‚åˆçš„åœºæ™¯ï¼ˆä½“ç°æ·±åº¦æ€è€ƒï¼‰
4. âœ… ç»“åˆ LangChain å®é™…åº”ç”¨

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šç›´è§‰ç†è§£ ğŸ¯

**ä¸€å¥è¯ï¼š** è´£ä»»é“¾å°±åƒä¼ è¯æ¸¸æˆï¼Œæ¶ˆæ¯æ²¿ç€ä¸€æ¡çº¿ä¼ é€’ï¼Œç›´åˆ°æœ‰äºº"æ¥æ”¶"ã€‚

**ä¸¾ä¾‹ï¼š**
```
å­¦ç”Ÿè¯·å‡ï¼šå­¦ç”Ÿ â†’ ç­é•¿ â†’ ç­ä¸»ä»» â†’ å¹´çº§ä¸»ä»» â†’ æ ¡é•¿
                â†“       â†“         â†“         â†“
              åŠå¤©     ä¸€å¤©      ä¸‰å¤©      ä¸€å‘¨
              (èƒ½æ‰¹)   (èƒ½æ‰¹)    (èƒ½æ‰¹)    (èƒ½æ‰¹)
```

**åº”ç”¨ï¼š** LangChain çš„ Callback äº‹ä»¶ä»å†…å±‚ç»„ä»¶ä¼ é€’åˆ°å¤–å±‚

---

### å¡ç‰‡2ï¼šå½¢å¼å®šä¹‰ ğŸ“

**ä¸€å¥è¯ï¼š** è´£ä»»é“¾æ¨¡å¼ = Handlerï¼ˆå¤„ç†è€…ï¼‰ + Successorï¼ˆåç»§è€…ï¼‰ + é“¾å¼ä¼ é€’

**æ ¸å¿ƒç»“æ„ï¼š**
```python
class Handler:
    successor: Handler  # åç»§è€…

    def handle(request):
        if can_handle(request):
            return do_handle(request)
        elif successor:
            return successor.handle(request)
```

**åº”ç”¨ï¼š** å®šä¹‰äº†æ‰€æœ‰å¤„ç†è€…çš„ç»Ÿä¸€æ¥å£

---

### å¡ç‰‡3ï¼šHandler æŠ½è±¡ç±»è®¾è®¡ ğŸ”§

**ä¸€å¥è¯ï¼š** Handler å®šä¹‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š`set_next()` è®¾ç½®åç»§ï¼Œ`handle()` å¤„ç†è¯·æ±‚

```python
class Handler(ABC):
    def __init__(self):
        self._next = None

    def set_next(self, handler) -> Handler:
        self._next = handler
        return handler  # æ”¯æŒé“¾å¼è°ƒç”¨

    @abstractmethod
    def handle(self, request):
        pass
```

**åº”ç”¨ï¼š** LangChain çš„ `BaseCallbackHandler` å®šä¹‰äº†äº‹ä»¶å¤„ç†æ¥å£

---

### å¡ç‰‡4ï¼šConcreteHandler å®ç° ğŸ­

**ä¸€å¥è¯ï¼š** å…·ä½“å¤„ç†è€…å†³å®š"å¤„ç†"è¿˜æ˜¯"ä¼ é€’"

```python
class ConcreteHandler(Handler):
    def handle(self, request):
        if self._can_handle(request):
            return self._process(request)  # å¤„ç†
        if self._next:
            return self._next.handle(request)  # ä¼ é€’
        return None  # æ— äººå¤„ç†
```

**åº”ç”¨ï¼š** æ¯ä¸ª Callback Handler å†³å®šæ˜¯å¦å“åº”ç‰¹å®šäº‹ä»¶

---

### å¡ç‰‡5ï¼šé“¾çš„ç»„è£…æ–¹å¼ ğŸ”—

**ä¸€å¥è¯ï¼š** é“¾å¯ä»¥æ‰‹åŠ¨ç»„è£…ã€åˆ—è¡¨æ„å»ºæˆ–é…ç½®é©±åŠ¨

```python
# æ–¹å¼1ï¼šé“¾å¼è°ƒç”¨
h1.set_next(h2).set_next(h3)

# æ–¹å¼2ï¼šåˆ—è¡¨æ„å»º
for i in range(len(handlers)-1):
    handlers[i].set_next(handlers[i+1])

# æ–¹å¼3ï¼šé…ç½®é©±åŠ¨
chain = ChainBuilder.build(["auth", "log", "business"])
```

**åº”ç”¨ï¼š** LangChain çš„ `CallbackManager` ç®¡ç† Handler åˆ—è¡¨

---

### å¡ç‰‡6ï¼šä¸­æ–­é“¾ï¼ˆçŸ­è·¯å¤„ç†ï¼‰âš¡

**ä¸€å¥è¯ï¼š** å¤„ç†è€…å¯ä»¥æå‰ç»ˆæ­¢é“¾ï¼Œä¸å†ä¼ é€’ç»™åç»§

```python
def handle(self, request):
    # è®¤è¯å¤±è´¥ï¼Œç›´æ¥è¿”å›é”™è¯¯
    if not self._validate(request):
        return Error("Unauthorized")  # ä¸­æ–­é“¾

    # é€šè¿‡éªŒè¯ï¼Œç»§ç»­ä¼ é€’
    if self._next:
        return self._next.handle(request)
```

**åº”ç”¨ï¼š** ç¼“å­˜å‘½ä¸­æ—¶ä¸å†æŸ¥è¯¢æ•°æ®åº“

---

### å¡ç‰‡7ï¼švs è§‚å¯Ÿè€…æ¨¡å¼ ğŸ”„

**ä¸€å¥è¯ï¼š** è´£ä»»é“¾æ˜¯"é¡ºåºä¼ é€’æ‰¾äººå¤„ç†"ï¼Œè§‚å¯Ÿè€…æ˜¯"å¹¿æ’­é€šçŸ¥æ‰€æœ‰äºº"

| ç‰¹å¾ | è´£ä»»é“¾ | è§‚å¯Ÿè€… |
|------|--------|--------|
| ä¼ é€’æ–¹å¼ | é¡ºåº | å¹¿æ’­ |
| å¤„ç†è€…å…³ç³» | é“¾æ¡ | å¹³ç­‰ |
| é€šå¸¸ç»“æœ | ä¸€ä¸ªå¤„ç† | å…¨éƒ¨é€šçŸ¥ |

**åº”ç”¨ï¼š** LangChain Callback æ˜¯ä¸¤è€…çš„æ··åˆ

---

### å¡ç‰‡8ï¼švs è£…é¥°å™¨æ¨¡å¼ ğŸ­

**ä¸€å¥è¯ï¼š** è´£ä»»é“¾å…³æ³¨"è°æ¥å¤„ç†"ï¼Œè£…é¥°å™¨å…³æ³¨"å¢å¼ºåŠŸèƒ½"

| ç‰¹å¾ | è´£ä»»é“¾ | è£…é¥°å™¨ |
|------|--------|--------|
| ç›®çš„ | æ‰¾åˆ°å¤„ç†è€… | å¢å¼ºå¯¹è±¡ |
| å…³ç³» | å¯èƒ½åªæœ‰ä¸€ä¸ªå¤„ç† | å±‚å±‚åŒ…è£… |
| å…¸å‹åœºæ™¯ | è¯·æ±‚åˆ†å‘ | åŠŸèƒ½å¢å¼º |

**åº”ç”¨ï¼š** ä¸­é—´ä»¶æ›´åƒ"è£…é¥°å™¨é£æ ¼çš„è´£ä»»é“¾"

---

### å¡ç‰‡9ï¼šLangChain Callback ç³»ç»Ÿ ğŸª

**ä¸€å¥è¯ï¼š** Callback æ˜¯"è§‚å¯Ÿè€…+è´£ä»»é“¾"çš„æ··åˆï¼Œäº‹ä»¶å¹¿æ’­ç»™æ‰€æœ‰ Handler

```python
class CallbackManager:
    handlers: List[Handler]

    def on_llm_start(self, prompts):
        for handler in self.handlers:  # å¹¿æ’­
            handler.on_llm_start(prompts)

# ä½¿ç”¨
manager.add_handler(LoggingHandler())
manager.add_handler(MetricsHandler())
manager.add_handler(StreamingHandler())
```

**åº”ç”¨ï¼š** æ—¥å¿—ã€ç›‘æ§ã€æµå¼è¾“å‡ºåŒæ—¶å“åº” LLM äº‹ä»¶

---

### å¡ç‰‡10ï¼šæ€»ç»“ä¸æœ€ä½³å®è·µ ğŸ“

**ä¸€å¥è¯ï¼š** è´£ä»»é“¾è®©è¯·æ±‚çš„å‘é€è€…å’Œå¤„ç†è€…è§£è€¦ï¼Œæ˜¯æ„å»ºå¯æ‰©å±•ç³»ç»Ÿçš„åˆ©å™¨

**æœ€ä½³å®è·µï¼š**
1. âœ… ä¿æŒ Handler èŒè´£å•ä¸€
2. âœ… æä¾›é»˜è®¤çš„é“¾æœ«ç«¯å¤„ç†
3. âœ… æ”¯æŒåŠ¨æ€ç»„è£…é“¾
4. âœ… è€ƒè™‘æ˜¯å¦éœ€è¦ä¸­æ–­æœºåˆ¶
5. âŒ é¿å…é“¾è¿‡é•¿ï¼ˆ5-10ä¸ªä¸ºå®œï¼‰
6. âŒ é¿å… Handler ä¹‹é—´å¼ºä¾èµ–

**LangChain å¯ç¤ºï¼š** é€šè¿‡ Callback ç³»ç»Ÿï¼Œç”¨æˆ·å¯ä»¥è‡ªç”±æ’æ‹”ç›‘å¬å™¨ï¼Œå®ç°å®šåˆ¶åŒ–çš„äº‹ä»¶å¤„ç†

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**è´£ä»»é“¾æ¨¡å¼é€šè¿‡é“¾å¼ä¼ é€’è¯·æ±‚ï¼Œè®©å¤šä¸ªå¤„ç†è€…éƒ½æœ‰æœºä¼šå“åº”ï¼Œè§£è€¦äº†å‘é€è€…å’Œæ¥æ”¶è€…ï¼Œåœ¨ LangChain çš„ Callback ç³»ç»Ÿä¸­å®ç°äº†äº‹ä»¶çš„çµæ´»ç›‘å¬ä¸å¯æ’æ‹”å¤„ç†ã€‚**

---

## ğŸ“š å­¦ä¹ æ£€æŸ¥æ¸…å•

### åŸºç¡€ç†è§£
- [ ] èƒ½è¯´å‡ºè´£ä»»é“¾æ¨¡å¼çš„æ ¸å¿ƒå®šä¹‰ï¼ˆ30å­—ä»¥å†…ï¼‰
- [ ] èƒ½è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦è´£ä»»é“¾æ¨¡å¼
- [ ] èƒ½ç”»å‡ºè´£ä»»é“¾çš„åŸºæœ¬ç»“æ„å›¾

### æ ¸å¿ƒæ¦‚å¿µ
- [ ] èƒ½å®ç° Handler æŠ½è±¡ç±»
- [ ] èƒ½å®ç°å…·ä½“çš„ ConcreteHandler
- [ ] èƒ½ç»„è£…ä¸€ä¸ªç®€å•çš„å¤„ç†é“¾
- [ ] ç†è§£"ä¸­æ–­é“¾"çš„æœºåˆ¶

### è¿›é˜¶åº”ç”¨
- [ ] èƒ½å®ç°åŒå‘é“¾ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰
- [ ] èƒ½å®ç°å¼‚æ­¥è´£ä»»é“¾
- [ ] èƒ½æ ¹æ®é…ç½®åŠ¨æ€æ„å»ºé“¾

### LangChain å…³è”
- [ ] ç†è§£ Callback ç³»ç»Ÿçš„è®¾è®¡
- [ ] èƒ½è§£é‡Š Callback ä¸è´£ä»»é“¾çš„å…³ç³»
- [ ] èƒ½è‡ªå®šä¹‰ä¸€ä¸ª Callback Handler

### é¢è¯•å‡†å¤‡
- [ ] èƒ½åŒºåˆ†è´£ä»»é“¾å’Œè§‚å¯Ÿè€…æ¨¡å¼
- [ ] èƒ½è¯´å‡ºè´£ä»»é“¾çš„é€‚ç”¨åœºæ™¯
- [ ] èƒ½ä¸¾å‡º 2-3 ä¸ªå®é™…åº”ç”¨ä¾‹å­

---

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

1. **è§‚å¯Ÿè€…æ¨¡å¼** - ç†è§£äº‹ä»¶å¹¿æ’­æœºåˆ¶
2. **è£…é¥°å™¨æ¨¡å¼** - ç†è§£åŠŸèƒ½å¢å¼ºæœºåˆ¶
3. **LangChain Callback æºç ** - `langchain_core/callbacks/`
4. **Express.js ä¸­é—´ä»¶** - å‰ç«¯é¢†åŸŸçš„è´£ä»»é“¾åº”ç”¨

---

## ğŸ“– å‚è€ƒèµ„æº

- [LangChain Callbacks æ–‡æ¡£](https://python.langchain.com/docs/modules/callbacks/)
- [è®¾è®¡æ¨¡å¼ - è´£ä»»é“¾æ¨¡å¼](https://refactoring.guru/design-patterns/chain-of-responsibility)
- [Express.js ä¸­é—´ä»¶](https://expressjs.com/en/guide/using-middleware.html)
