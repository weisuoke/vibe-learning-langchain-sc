# æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)

> åŸå­åŒ–çŸ¥è¯†ç‚¹ | è½¯ä»¶å·¥ç¨‹åŸºç¡€ | LangChain æºç å­¦ä¹ å‰ç½®çŸ¥è¯†

---

## 1. ã€30å­—æ ¸å¿ƒã€‘

**æ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨æŠ½è±¡ç±»ä¸­å®šä¹‰ç®—æ³•éª¨æ¶ï¼Œå°†å…·ä½“æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»å®ç°ï¼Œæ˜¯ LangChain ç»„ä»¶æ‰©å±•çš„æ ¸å¿ƒæœºåˆ¶ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**æ¨¡æ¿æ–¹æ³•æ¨¡å¼ = å›ºå®šçš„ç®—æ³•éª¨æ¶ + å¯å˜çš„å…·ä½“æ­¥éª¤**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

- **å›ºå®šçš„éª¨æ¶**ï¼šç®—æ³•çš„æ•´ä½“æµç¨‹å’Œæ­¥éª¤é¡ºåºä¸å˜
- **å¯å˜çš„æ­¥éª¤**ï¼šå…·ä½“çš„å®ç°ç»†èŠ‚ç”±å­ç±»å†³å®š
- **æ§åˆ¶åè½¬**ï¼šçˆ¶ç±»è°ƒç”¨å­ç±»çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯å­ç±»è°ƒç”¨çˆ¶ç±»

#### 2. ä¸ºä»€ä¹ˆéœ€è¦æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•åœ¨ä¿æŒç®—æ³•ç»“æ„ä¸å˜çš„æƒ…å†µä¸‹ï¼Œå…è®¸ä¸åŒçš„å®ç°ï¼Ÿ**

```python
# æ²¡æœ‰æ¨¡æ¿æ–¹æ³•ï¼šæ¯ä¸ªå®ç°éƒ½è¦é‡å¤å†™ç›¸åŒçš„æµç¨‹
class OpenAIChat:
    def chat(self, message: str) -> str:
        # 1. éªŒè¯è¾“å…¥
        if not message:
            raise ValueError("æ¶ˆæ¯ä¸èƒ½ä¸ºç©º")

        # 2. è°ƒç”¨ APIï¼ˆä¸åŒå®ç°ï¼‰
        response = self._call_openai_api(message)

        # 3. åå¤„ç†
        return response.strip()

class AnthropicChat:
    def chat(self, message: str) -> str:
        # 1. éªŒè¯è¾“å…¥ â† é‡å¤ï¼
        if not message:
            raise ValueError("æ¶ˆæ¯ä¸èƒ½ä¸ºç©º")

        # 2. è°ƒç”¨ APIï¼ˆä¸åŒå®ç°ï¼‰
        response = self._call_anthropic_api(message)

        # 3. åå¤„ç† â† é‡å¤ï¼
        return response.strip()

# é—®é¢˜ï¼š
# 1. ç›¸åŒçš„é€»è¾‘é‡å¤å†™å¤šæ¬¡
# 2. å¦‚æœè¦ä¿®æ”¹éªŒè¯é€»è¾‘ï¼Œéœ€è¦æ”¹å¤šä¸ªåœ°æ–¹
# 3. å®¹æ˜“æ¼æ‰æŸäº›æ­¥éª¤
```

```python
# ä½¿ç”¨æ¨¡æ¿æ–¹æ³•ï¼šéª¨æ¶å›ºå®šï¼Œå®ç°å¯å˜
from abc import ABC, abstractmethod

class BaseChatModel(ABC):
    """èŠå¤©æ¨¡å‹åŸºç±» - å®šä¹‰ç®—æ³•éª¨æ¶"""

    def chat(self, message: str) -> str:
        """æ¨¡æ¿æ–¹æ³•ï¼šå›ºå®šçš„æµç¨‹"""
        # 1. éªŒè¯è¾“å…¥ï¼ˆå›ºå®šï¼‰
        self._validate_input(message)

        # 2. è°ƒç”¨ APIï¼ˆå­ç±»å®ç°ï¼‰
        response = self._call_api(message)

        # 3. åå¤„ç†ï¼ˆå›ºå®šï¼‰
        return self._postprocess(response)

    def _validate_input(self, message: str):
        if not message:
            raise ValueError("æ¶ˆæ¯ä¸èƒ½ä¸ºç©º")

    @abstractmethod
    def _call_api(self, message: str) -> str:
        """æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å¿…é¡»å®ç°"""
        pass

    def _postprocess(self, response: str) -> str:
        return response.strip()

class OpenAIChat(BaseChatModel):
    def _call_api(self, message: str) -> str:
        # åªéœ€è¦å®ç°è¿™ä¸€ä¸ªæ–¹æ³•ï¼
        return f"OpenAI: {message}"

class AnthropicChat(BaseChatModel):
    def _call_api(self, message: str) -> str:
        return f"Claude: {message}"

# ä¼˜åŠ¿ï¼š
# 1. ç®—æ³•æµç¨‹åªå®šä¹‰ä¸€æ¬¡
# 2. ä¿®æ”¹æµç¨‹åªéœ€æ”¹åŸºç±»
# 3. å­ç±»ä¸“æ³¨äºå·®å¼‚åŒ–å®ç°
```

#### 3. æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šä»£ç å¤ç”¨ - é¿å…é‡å¤

```python
# æ‰€æœ‰å­ç±»å…±äº«ç›¸åŒçš„æµç¨‹ä»£ç 
# åªæœ‰ _call_api è¿™ä¸ªå·®å¼‚åŒ–éƒ¨åˆ†éœ€è¦å„è‡ªå®ç°
```

##### ä»·å€¼2ï¼šæµç¨‹æ§åˆ¶ - ä¿è¯ä¸€è‡´æ€§

```python
# æ— è®ºå“ªä¸ªå­ç±»ï¼Œéƒ½å¿…é¡»ç»è¿‡ï¼šéªŒè¯ â†’ APIè°ƒç”¨ â†’ åå¤„ç†
# ä¸ä¼šæ¼æ‰ä»»ä½•æ­¥éª¤
```

##### ä»·å€¼3ï¼šæ‰©å±•æ€§ - å¼€é—­åŸåˆ™

```python
# æ–°å¢æ¨¡å‹åªéœ€è¦ç»§æ‰¿åŸºç±»ï¼Œå®ç°æŠ½è±¡æ–¹æ³•
# ä¸éœ€è¦ä¿®æ”¹å·²æœ‰ä»£ç 
class GeminiChat(BaseChatModel):
    def _call_api(self, message: str) -> str:
        return f"Gemini: {message}"
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ LangChain æºç åº”ç”¨

**æ¨ç†é“¾ï¼š**

```
1. LLM åº”ç”¨æ¡†æ¶éœ€è¦æ”¯æŒå¤šç§æ¨¡å‹ï¼ˆOpenAIã€Anthropicã€æœ¬åœ°æ¨¡å‹...ï¼‰
   â†“
2. æ¯ç§æ¨¡å‹çš„è°ƒç”¨æ–¹å¼ä¸åŒï¼Œä½†æ•´ä½“æµç¨‹ç›¸ä¼¼
   â†“
3. éœ€è¦ç»Ÿä¸€æ¥å£ï¼ŒåŒæ—¶å…è®¸å·®å¼‚åŒ–å®ç°
   â†“
4. æ¨¡æ¿æ–¹æ³•æ¨¡å¼å®Œç¾åŒ¹é…è¿™ä¸ªéœ€æ±‚
   â†“
5. å®šä¹‰ BaseChatModelï¼Œå›ºå®š invoke() æµç¨‹
   â†“
6. æŠ½è±¡å‡º _generate() æ–¹æ³•ï¼Œå­ç±»å®ç°å…·ä½“è°ƒç”¨
   â†“
7. æ‰€æœ‰æ¨¡å‹é€šè¿‡ç›¸åŒæ¥å£è°ƒç”¨ï¼šmodel.invoke("Hello")
   â†“
8. LCEL ç®¡é“å¯ä»¥æ— ç¼åˆ‡æ¢ä¸åŒæ¨¡å‹å®ç°
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**æ¨¡æ¿æ–¹æ³•æ¨¡å¼é€šè¿‡"å›ºå®šéª¨æ¶+å¯å˜æ­¥éª¤"çš„è®¾è®¡ï¼Œåœ¨ä¿æŒç®—æ³•ä¸€è‡´æ€§çš„åŒæ—¶å®ç°çµæ´»æ‰©å±•ï¼Œæ˜¯ LangChain æ”¯æŒå¤šç§ LLM çš„æ¶æ„åŸºç¡€ã€‚**

---

## 3. ã€æ ¸å¿ƒæ¦‚å¿µï¼ˆå…¨é¢è¦†ç›–ï¼‰ã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šæŠ½è±¡ç±»ä¸æ¨¡æ¿æ–¹æ³• ğŸ—ï¸

**æŠ½è±¡ç±»å®šä¹‰ç®—æ³•éª¨æ¶ï¼Œæ¨¡æ¿æ–¹æ³•æ˜¯éª¨æ¶çš„å…¥å£**

```python
from abc import ABC, abstractmethod
from typing import Any, List, Optional

class BaseDocumentLoader(ABC):
    """æ–‡æ¡£åŠ è½½å™¨æŠ½è±¡åŸºç±» - ç±»ä¼¼ LangChain çš„ BaseLoader"""

    # ===== æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰ç®—æ³•éª¨æ¶ =====
    def load(self) -> List[dict]:
        """
        æ¨¡æ¿æ–¹æ³•ï¼šå›ºå®šçš„åŠ è½½æµç¨‹

        è¿™ä¸ªæ–¹æ³•å®šä¹‰äº†æ–‡æ¡£åŠ è½½çš„å®Œæ•´æµç¨‹ï¼š
        1. éªŒè¯é…ç½®
        2. åŠ è½½åŸå§‹æ•°æ®ï¼ˆå­ç±»å®ç°ï¼‰
        3. è§£ææ•°æ®ï¼ˆå­ç±»å®ç°ï¼‰
        4. åå¤„ç†
        """
        # æ­¥éª¤1ï¼šéªŒè¯ï¼ˆå›ºå®šï¼‰
        self._validate()

        # æ­¥éª¤2ï¼šåŠ è½½åŸå§‹æ•°æ®ï¼ˆå­ç±»å®ç°ï¼‰
        raw_data = self._load_raw()

        # æ­¥éª¤3ï¼šè§£ææ•°æ®ï¼ˆå­ç±»å®ç°ï¼‰
        documents = self._parse(raw_data)

        # æ­¥éª¤4ï¼šåå¤„ç†ï¼ˆå›ºå®šï¼Œå¯è¢«é’©å­æ–¹æ³•è¦†ç›–ï¼‰
        return self._postprocess(documents)

    # ===== å›ºå®šæ­¥éª¤ï¼šæ‰€æœ‰å­ç±»å…±äº« =====
    def _validate(self):
        """éªŒè¯é…ç½®"""
        pass  # é»˜è®¤ä¸åšéªŒè¯ï¼Œå­ç±»å¯è¦†ç›–

    def _postprocess(self, documents: List[dict]) -> List[dict]:
        """åå¤„ç†ï¼šæ·»åŠ å…ƒæ•°æ®"""
        for doc in documents:
            doc["loader"] = self.__class__.__name__
        return documents

    # ===== æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å¿…é¡»å®ç° =====
    @abstractmethod
    def _load_raw(self) -> Any:
        """åŠ è½½åŸå§‹æ•°æ® - å­ç±»å¿…é¡»å®ç°"""
        pass

    @abstractmethod
    def _parse(self, raw_data: Any) -> List[dict]:
        """è§£ææ•°æ® - å­ç±»å¿…é¡»å®ç°"""
        pass
```

**æ¨¡æ¿æ–¹æ³•çš„ç‰¹å¾ï¼š**

| ç‰¹å¾ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| é€šå¸¸æ˜¯ public | å¤–éƒ¨è°ƒç”¨å…¥å£ | `load()`, `invoke()` |
| å®šä¹‰ç®—æ³•æµç¨‹ | ç¡®å®šæ­¥éª¤é¡ºåº | éªŒè¯ â†’ åŠ è½½ â†’ è§£æ â†’ åå¤„ç† |
| è°ƒç”¨å…¶ä»–æ–¹æ³• | ç»„åˆå„ä¸ªæ­¥éª¤ | è°ƒç”¨ `_validate()`, `_load_raw()` ç­‰ |
| é€šå¸¸ä¸è¢«è¦†ç›– | éª¨æ¶åº”è¯¥å›ºå®š | ç”¨ `final` æ ‡è®°ï¼ˆPython æ— å¼ºåˆ¶ï¼‰ |

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# langchain_core/language_models/chat_models.py ç®€åŒ–ç‰ˆ
class BaseChatModel(ABC):
    """èŠå¤©æ¨¡å‹åŸºç±»"""

    def invoke(self, input, config=None):
        """æ¨¡æ¿æ–¹æ³•ï¼šè°ƒç”¨æµç¨‹"""
        # 1. è¾“å…¥è½¬æ¢
        messages = self._convert_input(input)

        # 2. ç”Ÿæˆå“åº”ï¼ˆå­ç±»å®ç°ï¼‰
        result = self._generate(messages, config=config)

        # 3. æå–ç»“æœ
        return result.generations[0].message

    @abstractmethod
    def _generate(self, messages, **kwargs):
        """æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å®ç°å…·ä½“ç”Ÿæˆé€»è¾‘"""
        pass
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šé’©å­æ–¹æ³• (Hook Method) ğŸ£

**é’©å­æ–¹æ³•æ˜¯å¯é€‰çš„æ‰©å±•ç‚¹ï¼Œå­ç±»å¯ä»¥é€‰æ‹©æ€§è¦†ç›–**

```python
from abc import ABC, abstractmethod
from typing import Any, Optional

class BaseProcessor(ABC):
    """æ•°æ®å¤„ç†å™¨åŸºç±» - å±•ç¤ºé’©å­æ–¹æ³•"""

    def process(self, data: Any) -> Any:
        """æ¨¡æ¿æ–¹æ³•"""
        # é’©å­1ï¼šå‰ç½®å¤„ç†ï¼ˆå¯é€‰è¦†ç›–ï¼‰
        if self._should_preprocess():
            data = self._preprocess(data)

        # æ ¸å¿ƒå¤„ç†ï¼ˆå¿…é¡»å®ç°ï¼‰
        result = self._do_process(data)

        # é’©å­2ï¼šåç½®å¤„ç†ï¼ˆå¯é€‰è¦†ç›–ï¼‰
        result = self._postprocess(result)

        # é’©å­3ï¼šéªŒè¯ç»“æœï¼ˆå¯é€‰è¦†ç›–ï¼‰
        if self._should_validate():
            self._validate_result(result)

        return result

    # ===== é’©å­æ–¹æ³•ï¼šæœ‰é»˜è®¤å®ç°ï¼Œå­ç±»å¯é€‰æ‹©è¦†ç›– =====

    def _should_preprocess(self) -> bool:
        """é’©å­ï¼šæ˜¯å¦éœ€è¦é¢„å¤„ç†"""
        return True  # é»˜è®¤éœ€è¦

    def _preprocess(self, data: Any) -> Any:
        """é’©å­ï¼šé¢„å¤„ç†é€»è¾‘"""
        return data  # é»˜è®¤ä¸å¤„ç†

    def _postprocess(self, result: Any) -> Any:
        """é’©å­ï¼šåå¤„ç†é€»è¾‘"""
        return result  # é»˜è®¤ä¸å¤„ç†

    def _should_validate(self) -> bool:
        """é’©å­ï¼šæ˜¯å¦éœ€è¦éªŒè¯"""
        return False  # é»˜è®¤ä¸éªŒè¯

    def _validate_result(self, result: Any):
        """é’©å­ï¼šéªŒè¯é€»è¾‘"""
        pass

    # ===== æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å¿…é¡»å®ç° =====

    @abstractmethod
    def _do_process(self, data: Any) -> Any:
        """æ ¸å¿ƒå¤„ç†é€»è¾‘"""
        pass

class TextProcessor(BaseProcessor):
    """æ–‡æœ¬å¤„ç†å™¨ - ä½¿ç”¨é’©å­æ–¹æ³•"""

    def _preprocess(self, data: str) -> str:
        """è¦†ç›–é’©å­ï¼šå»é™¤ç©ºç™½"""
        return data.strip()

    def _do_process(self, data: str) -> str:
        """å®ç°æ ¸å¿ƒé€»è¾‘"""
        return data.upper()

    def _should_validate(self) -> bool:
        """è¦†ç›–é’©å­ï¼šå¯ç”¨éªŒè¯"""
        return True

    def _validate_result(self, result: str):
        """è¦†ç›–é’©å­ï¼šéªŒè¯ç»“æœ"""
        if not result:
            raise ValueError("ç»“æœä¸èƒ½ä¸ºç©º")

class NumberProcessor(BaseProcessor):
    """æ•°å­—å¤„ç†å™¨ - æœ€å°åŒ–å®ç°"""

    def _should_preprocess(self) -> bool:
        """è¦†ç›–é’©å­ï¼šç¦ç”¨é¢„å¤„ç†"""
        return False

    def _do_process(self, data: int) -> int:
        """å®ç°æ ¸å¿ƒé€»è¾‘"""
        return data * 2
```

**é’©å­æ–¹æ³• vs æŠ½è±¡æ–¹æ³•ï¼š**

| ç‰¹æ€§ | é’©å­æ–¹æ³• (Hook) | æŠ½è±¡æ–¹æ³• (Abstract) |
|------|----------------|-------------------|
| å¿…é¡»å®ç°ï¼Ÿ | âŒ å¯é€‰ | âœ… å¿…é¡» |
| æœ‰é»˜è®¤å®ç°ï¼Ÿ | âœ… æœ‰ | âŒ æ—  |
| ä½¿ç”¨åœºæ™¯ | å¯é€‰çš„æ‰©å±•ç‚¹ | å¿…éœ€çš„å·®å¼‚åŒ–å®ç° |
| è£…é¥°å™¨ | æ—  | `@abstractmethod` |
| å‘½åçº¦å®š | `_should_xxx()`, `_on_xxx()` | `_do_xxx()`, `_xxx()` |

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# langchain_core/callbacks/base.py ç®€åŒ–ç‰ˆ
class BaseCallbackHandler:
    """å›è°ƒå¤„ç†å™¨åŸºç±» - å¤§é‡ä½¿ç”¨é’©å­æ–¹æ³•"""

    def on_llm_start(self, serialized, prompts, **kwargs):
        """é’©å­ï¼šLLM å¼€å§‹æ—¶è°ƒç”¨"""
        pass  # é»˜è®¤ä¸åšä»»ä½•äº‹

    def on_llm_end(self, response, **kwargs):
        """é’©å­ï¼šLLM ç»“æŸæ—¶è°ƒç”¨"""
        pass

    def on_llm_error(self, error, **kwargs):
        """é’©å­ï¼šLLM å‡ºé”™æ—¶è°ƒç”¨"""
        pass

    def on_chain_start(self, serialized, inputs, **kwargs):
        """é’©å­ï¼šChain å¼€å§‹æ—¶è°ƒç”¨"""
        pass

# å­ç±»åªéœ€è¦è¦†ç›–å…³å¿ƒçš„é’©å­
class LoggingHandler(BaseCallbackHandler):
    def on_llm_start(self, serialized, prompts, **kwargs):
        print(f"LLM å¼€å§‹: {prompts}")

    def on_llm_end(self, response, **kwargs):
        print(f"LLM ç»“æŸ: {response}")
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šå…·ä½“å®ç°ç±» ğŸ”§

**å…·ä½“ç±»ç»§æ‰¿æŠ½è±¡ç±»ï¼Œå®ç°æ‰€æœ‰æŠ½è±¡æ–¹æ³•**

```python
from abc import ABC, abstractmethod
from typing import List, Dict, Any
import json

class BaseRetriever(ABC):
    """æ£€ç´¢å™¨æŠ½è±¡åŸºç±» - ç±»ä¼¼ LangChain çš„ BaseRetriever"""

    def __init__(self, top_k: int = 5):
        self.top_k = top_k

    def retrieve(self, query: str) -> List[Dict[str, Any]]:
        """æ¨¡æ¿æ–¹æ³•ï¼šæ£€ç´¢æµç¨‹"""
        # 1. é¢„å¤„ç†æŸ¥è¯¢
        processed_query = self._preprocess_query(query)

        # 2. æ‰§è¡Œæ£€ç´¢ï¼ˆå­ç±»å®ç°ï¼‰
        results = self._do_retrieve(processed_query)

        # 3. æ’åºå’Œæˆªæ–­
        sorted_results = self._rank_results(results)

        # 4. åå¤„ç†
        return sorted_results[:self.top_k]

    def _preprocess_query(self, query: str) -> str:
        """é’©å­ï¼šé¢„å¤„ç†æŸ¥è¯¢"""
        return query.lower().strip()

    def _rank_results(self, results: List[Dict]) -> List[Dict]:
        """é’©å­ï¼šç»“æœæ’åº"""
        return sorted(results, key=lambda x: x.get("score", 0), reverse=True)

    @abstractmethod
    def _do_retrieve(self, query: str) -> List[Dict[str, Any]]:
        """æŠ½è±¡æ–¹æ³•ï¼šæ‰§è¡Œæ£€ç´¢"""
        pass

# ===== å…·ä½“å®ç°ç±»1ï¼šå…³é”®è¯æ£€ç´¢å™¨ =====
class KeywordRetriever(BaseRetriever):
    """åŸºäºå…³é”®è¯çš„æ£€ç´¢å™¨"""

    def __init__(self, documents: List[str], top_k: int = 5):
        super().__init__(top_k)
        self.documents = documents

    def _do_retrieve(self, query: str) -> List[Dict[str, Any]]:
        """å®ç°å…³é”®è¯åŒ¹é…æ£€ç´¢"""
        results = []
        keywords = query.split()

        for i, doc in enumerate(self.documents):
            doc_lower = doc.lower()
            score = sum(1 for kw in keywords if kw in doc_lower)
            if score > 0:
                results.append({
                    "id": i,
                    "content": doc,
                    "score": score / len(keywords)
                })

        return results

# ===== å…·ä½“å®ç°ç±»2ï¼šå‘é‡æ£€ç´¢å™¨ =====
class VectorRetriever(BaseRetriever):
    """åŸºäºå‘é‡çš„æ£€ç´¢å™¨"""

    def __init__(self, embeddings: List[List[float]], documents: List[str], top_k: int = 5):
        super().__init__(top_k)
        self.embeddings = embeddings
        self.documents = documents

    def _do_retrieve(self, query: str) -> List[Dict[str, Any]]:
        """å®ç°å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢"""
        # ç®€åŒ–ï¼šè¿™é‡Œç”¨å­—ç¬¦ä¸²é•¿åº¦æ¨¡æ‹Ÿå‘é‡ç›¸ä¼¼åº¦
        query_vec = len(query)
        results = []

        for i, (emb, doc) in enumerate(zip(self.embeddings, self.documents)):
            # æ¨¡æ‹Ÿä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—
            similarity = 1.0 / (1 + abs(sum(emb) - query_vec))
            results.append({
                "id": i,
                "content": doc,
                "score": similarity
            })

        return results

    def _preprocess_query(self, query: str) -> str:
        """è¦†ç›–é’©å­ï¼šå‘é‡æ£€ç´¢ä¸éœ€è¦å°å†™åŒ–"""
        return query.strip()

# ===== å…·ä½“å®ç°ç±»3ï¼šæ··åˆæ£€ç´¢å™¨ =====
class HybridRetriever(BaseRetriever):
    """æ··åˆæ£€ç´¢å™¨ï¼šç»„åˆå¤šç§æ£€ç´¢ç­–ç•¥"""

    def __init__(self, keyword_retriever: KeywordRetriever,
                 vector_retriever: VectorRetriever, top_k: int = 5):
        super().__init__(top_k)
        self.keyword = keyword_retriever
        self.vector = vector_retriever

    def _do_retrieve(self, query: str) -> List[Dict[str, Any]]:
        """å®ç°æ··åˆæ£€ç´¢"""
        # è·å–ä¸¤ç§æ£€ç´¢ç»“æœ
        kw_results = {r["id"]: r for r in self.keyword._do_retrieve(query)}
        vec_results = {r["id"]: r for r in self.vector._do_retrieve(query)}

        # åˆå¹¶ç»“æœ
        all_ids = set(kw_results.keys()) | set(vec_results.keys())
        merged = []

        for id in all_ids:
            kw_score = kw_results.get(id, {}).get("score", 0)
            vec_score = vec_results.get(id, {}).get("score", 0)
            content = kw_results.get(id, vec_results.get(id, {})).get("content", "")

            merged.append({
                "id": id,
                "content": content,
                "score": 0.5 * kw_score + 0.5 * vec_score  # åŠ æƒèåˆ
            })

        return merged
```

**å…·ä½“å®ç°ç±»çš„è®¾è®¡åŸåˆ™ï¼š**

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| å•ä¸€èŒè´£ | æ¯ä¸ªç±»è´Ÿè´£ä¸€ç§å®ç° | KeywordRetriever åªåšå…³é”®è¯æ£€ç´¢ |
| æœ€å°å®ç° | åªå®ç°å¿…éœ€çš„æŠ½è±¡æ–¹æ³• | èƒ½ç”¨é»˜è®¤é’©å­å°±ä¸è¦†ç›– |
| ç»„åˆä¼˜äºç»§æ‰¿ | å¤æ‚åŠŸèƒ½ç”¨ç»„åˆ | HybridRetriever ç»„åˆä¸¤ç§æ£€ç´¢å™¨ |
| å¯æ›¿æ¢æ€§ | ç¬¦åˆé‡Œæ°æ›¿æ¢åŸåˆ™ | ä»»ä½• Retriever éƒ½èƒ½ä¼ ç»™éœ€è¦ BaseRetriever çš„åœ°æ–¹ |

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# langchain_openai/chat_models.py ç®€åŒ–ç‰ˆ
class ChatOpenAI(BaseChatModel):
    """OpenAI èŠå¤©æ¨¡å‹ - å…·ä½“å®ç°ç±»"""

    model_name: str = "gpt-3.5-turbo"
    temperature: float = 0.7

    def _generate(self, messages, **kwargs):
        """å®ç°å…·ä½“çš„ API è°ƒç”¨"""
        # è°ƒç”¨ OpenAI API
        response = self.client.chat.completions.create(
            model=self.model_name,
            messages=[m.to_dict() for m in messages],
            temperature=self.temperature,
        )
        return self._create_result(response)

# langchain_anthropic/chat_models.py ç®€åŒ–ç‰ˆ
class ChatAnthropic(BaseChatModel):
    """Anthropic èŠå¤©æ¨¡å‹ - å¦ä¸€ä¸ªå…·ä½“å®ç°ç±»"""

    model_name: str = "claude-3-opus"

    def _generate(self, messages, **kwargs):
        """å®ç°å…·ä½“çš„ API è°ƒç”¨"""
        # è°ƒç”¨ Anthropic API
        response = self.client.messages.create(
            model=self.model_name,
            messages=[m.to_anthropic() for m in messages],
        )
        return self._create_result(response)
```

---

### æ‰©å±•æ¦‚å¿µ4ï¼šæ¨¡æ¿æ–¹æ³•çš„å˜ä½“ ğŸ”„

```python
from abc import ABC, abstractmethod
from typing import Any, Generator

class BaseStreamProcessor(ABC):
    """æµå¼å¤„ç†å™¨ - å±•ç¤ºæ¨¡æ¿æ–¹æ³•çš„æµå¼å˜ä½“"""

    def stream(self, input: Any) -> Generator[Any, None, None]:
        """æ¨¡æ¿æ–¹æ³•ï¼šæµå¼å¤„ç†"""
        # åˆå§‹åŒ–
        self._on_start(input)

        try:
            # æµå¼å¤„ç†ï¼ˆå­ç±»å®ç°ï¼‰
            for chunk in self._do_stream(input):
                # å¤„ç†æ¯ä¸ªå—
                processed = self._process_chunk(chunk)
                if processed is not None:
                    yield processed
        finally:
            # æ¸…ç†
            self._on_end()

    def _on_start(self, input: Any):
        """é’©å­ï¼šå¼€å§‹æ—¶è°ƒç”¨"""
        pass

    def _on_end(self):
        """é’©å­ï¼šç»“æŸæ—¶è°ƒç”¨"""
        pass

    def _process_chunk(self, chunk: Any) -> Any:
        """é’©å­ï¼šå¤„ç†å•ä¸ªå—"""
        return chunk

    @abstractmethod
    def _do_stream(self, input: Any) -> Generator[Any, None, None]:
        """æŠ½è±¡æ–¹æ³•ï¼šæµå¼ç”Ÿæˆ"""
        pass

class TokenStreamer(BaseStreamProcessor):
    """Token æµå¼å¤„ç†å™¨"""

    def __init__(self):
        self.total_tokens = 0

    def _on_start(self, input: Any):
        print(f"å¼€å§‹å¤„ç†: {input}")
        self.total_tokens = 0

    def _on_end(self):
        print(f"å¤„ç†å®Œæˆï¼Œå…± {self.total_tokens} ä¸ª token")

    def _process_chunk(self, chunk: str) -> str:
        self.total_tokens += 1
        return chunk

    def _do_stream(self, input: str) -> Generator[str, None, None]:
        for char in input:
            yield char
```

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½ç†è§£ LangChain æºç ä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼š

### 4.1 å®šä¹‰æŠ½è±¡åŸºç±»å’Œæ¨¡æ¿æ–¹æ³•

```python
from abc import ABC, abstractmethod

class BaseModel(ABC):
    """æŠ½è±¡åŸºç±»"""

    def invoke(self, input: str) -> str:
        """æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰æµç¨‹"""
        validated = self._validate(input)
        result = self._call(validated)
        return self._format(result)

    def _validate(self, input: str) -> str:
        """å›ºå®šæ­¥éª¤ï¼šéªŒè¯è¾“å…¥"""
        return input.strip()

    @abstractmethod
    def _call(self, input: str) -> str:
        """æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å¿…é¡»å®ç°"""
        pass

    def _format(self, result: str) -> str:
        """é’©å­æ–¹æ³•ï¼šå¯é€‰è¦†ç›–"""
        return result
```

### 4.2 å®ç°å…·ä½“å­ç±»

```python
class OpenAIModel(BaseModel):
    """å…·ä½“å®ç°"""

    def _call(self, input: str) -> str:
        # åªéœ€è¦å®ç°è¿™ä¸ªæ–¹æ³•
        return f"OpenAI: {input}"

class ClaudeModel(BaseModel):
    """å¦ä¸€ä¸ªå…·ä½“å®ç°"""

    def _call(self, input: str) -> str:
        return f"Claude: {input}"

    def _format(self, result: str) -> str:
        # å¯é€‰ï¼šè¦†ç›–é’©å­æ–¹æ³•
        return f"ã€{result}ã€‘"
```

### 4.3 ä½¿ç”¨æ¨¡æ¿æ–¹æ³•

```python
# ç»Ÿä¸€çš„è°ƒç”¨æ–¹å¼
models = [OpenAIModel(), ClaudeModel()]

for model in models:
    print(model.invoke("Hello"))
# OpenAI: Hello
# ã€Claude: Helloã€‘
```

### 4.4 è¯†åˆ« LangChain ä¸­çš„æ¨¡æ¿æ–¹æ³•

```python
# LangChain ä¸­çš„å…¸å‹æ¨¡å¼
class SomeLangChainClass:
    def invoke(self, input):      # æ¨¡æ¿æ–¹æ³•ï¼ˆå…¬å¼€ï¼‰
        ...
        result = self._call(input) # è°ƒç”¨æŠ½è±¡æ–¹æ³•
        ...

    def _call(self, input):       # æŠ½è±¡æ–¹æ³•ï¼ˆå­ç±»å®ç°ï¼‰
        pass
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£ LangChain ä¸­ `BaseChatModel.invoke()` è°ƒç”¨ `_generate()` çš„æ¨¡å¼
- ç†è§£ `BaseRetriever.invoke()` è°ƒç”¨ `_get_relevant_documents()` çš„æ¨¡å¼
- åˆ›å»ºè‡ªå®šä¹‰çš„ LangChain ç»„ä»¶
- ç†è§£ä¸ºä»€ä¹ˆå¯ä»¥ç”¨ç›¸åŒæ¥å£è°ƒç”¨ä¸åŒçš„ LLM

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘ï¼ˆåŒè½¨åˆ¶ï¼‰

### ç±»æ¯”1ï¼šæ¨¡æ¿æ–¹æ³• = ç®—æ³•éª¨æ¶

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šReact ç”Ÿå‘½å‘¨æœŸ

æ¨¡æ¿æ–¹æ³•å°±åƒ React ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

```typescript
// React ç±»ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ = æ¨¡æ¿æ–¹æ³•æ¨¡å¼
class MyComponent extends React.Component {
  // React æ¡†æ¶å®šä¹‰çš„"æ¨¡æ¿æ–¹æ³•"æµç¨‹ï¼š
  // constructor â†’ getDerivedStateFromProps â†’ render â†’ componentDidMount

  constructor(props) {
    super(props);
    // é’©å­ï¼šåˆå§‹åŒ–ï¼ˆå¯é€‰è¦†ç›–ï¼‰
  }

  componentDidMount() {
    // é’©å­ï¼šæŒ‚è½½åï¼ˆå¯é€‰è¦†ç›–ï¼‰
    this.fetchData();
  }

  render() {
    // æŠ½è±¡æ–¹æ³•ï¼šå¿…é¡»å®ç°
    return <div>{this.state.data}</div>;
  }

  componentWillUnmount() {
    // é’©å­ï¼šå¸è½½å‰ï¼ˆå¯é€‰è¦†ç›–ï¼‰
    this.cleanup();
  }
}

// React æ¡†æ¶æ§åˆ¶ç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰
// ä½ åªéœ€è¦å®ç° renderï¼ˆå¿…éœ€ï¼‰å’Œè¦†ç›–é’©å­ï¼ˆå¯é€‰ï¼‰
```

```python
# Python å¯¹åº”ï¼šLangChain çš„ Runnable
class BaseRunnable(ABC):
    def invoke(self, input):
        # "ç”Ÿå‘½å‘¨æœŸ"æµç¨‹
        self._on_start(input)       # ç±»ä¼¼ componentDidMount
        result = self._call(input)   # ç±»ä¼¼ renderï¼ˆå¿…é¡»å®ç°ï¼‰
        self._on_end(result)         # ç±»ä¼¼ componentWillUnmount
        return result

    def _on_start(self, input): pass  # é’©å­
    def _on_end(self, result): pass   # é’©å­

    @abstractmethod
    def _call(self, input): pass      # å¿…é¡»å®ç°
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šé£Ÿè°±/èœè°±

æ¨¡æ¿æ–¹æ³•å°±åƒå¦ˆå¦ˆæ•™ä½ åšèœçš„é£Ÿè°±ã€‚

**ç”Ÿæ´»ä¾‹å­ï¼š**
```
å¦ˆå¦ˆçš„"ç‚’èœé£Ÿè°±"ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1æ­¥ï¼šæ´—èœ âœ…                    â”‚  â† å›ºå®šæ­¥éª¤
â”‚ ç¬¬2æ­¥ï¼šåˆ‡èœ âœ…                    â”‚  â† å›ºå®šæ­¥éª¤
â”‚ ç¬¬3æ­¥ï¼šçƒ­æ²¹ âœ…                    â”‚  â† å›ºå®šæ­¥éª¤
â”‚ ç¬¬4æ­¥ï¼šã€ç‚’ _____ ã€‘              â”‚  â† ä½ å†³å®šç‚’ä»€ä¹ˆï¼
â”‚ ç¬¬5æ­¥ï¼šåŠ è°ƒæ–™ âœ…                  â”‚  â† å›ºå®šæ­¥éª¤
â”‚ ç¬¬6æ­¥ï¼šè£…ç›˜ âœ…                    â”‚  â† å›ºå®šæ­¥éª¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å°æ˜æŒ‰ç…§é£Ÿè°±ï¼šç¬¬4æ­¥å¡«"é¸¡è›‹" â†’ ç‚’é¸¡è›‹
å°çº¢æŒ‰ç…§é£Ÿè°±ï¼šç¬¬4æ­¥å¡«"è¥¿çº¢æŸ¿" â†’ ç‚’è¥¿çº¢æŸ¿
å°åæŒ‰ç…§é£Ÿè°±ï¼šç¬¬4æ­¥å¡«"é’èœ" â†’ ç‚’é’èœ

é£Ÿè°±ï¼ˆéª¨æ¶ï¼‰æ˜¯å›ºå®šçš„ï¼Œåªæœ‰ç¬¬4æ­¥ï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰ç”±ä½ å†³å®šï¼
```

---

### ç±»æ¯”2ï¼šé’©å­æ–¹æ³• = å¯é€‰æ‰©å±•ç‚¹

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šExpress ä¸­é—´ä»¶ / Vue ç”Ÿå‘½å‘¨æœŸ

```typescript
// Express ä¸­é—´ä»¶ = é’©å­æ–¹æ³•
app.use((req, res, next) => {
  // é’©å­ï¼šè¯·æ±‚å‰å¤„ç†ï¼ˆå¯é€‰ï¼‰
  console.log('Request received');
  next();
});

app.get('/api', (req, res) => {
  // æ ¸å¿ƒå¤„ç†ï¼ˆå¿…é¡»å®ç°ï¼‰
  res.json({ data: 'hello' });
});

app.use((err, req, res, next) => {
  // é’©å­ï¼šé”™è¯¯å¤„ç†ï¼ˆå¯é€‰ï¼‰
  res.status(500).json({ error: err.message });
});
```

```python
# Python å¯¹åº”ï¼šLangChain çš„ Callback
class MyCallback(BaseCallbackHandler):
    def on_llm_start(self, *args):  # é’©å­ï¼šå¯é€‰è¦†ç›–
        print("LLM å¼€å§‹")

    def on_llm_end(self, *args):    # é’©å­ï¼šå¯é€‰è¦†ç›–
        print("LLM ç»“æŸ")

    # ä¸å…³å¿ƒçš„é’©å­å°±ä¸è¦†ç›–
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šç§¯æœ¨è¯´æ˜ä¹¦çš„"å¯é€‰æ­¥éª¤"

**ç”Ÿæ´»ä¾‹å­ï¼š**
```
ä¹é«˜åŸå ¡è¯´æ˜ä¹¦ï¼š

ç¬¬1æ­¥ï¼šæ­åœ°åŸº âœ…ï¼ˆå¿…é¡»ï¼‰
ç¬¬2æ­¥ï¼šæ­åŸå¢™ âœ…ï¼ˆå¿…é¡»ï¼‰
ç¬¬3æ­¥ï¼šã€å¯é€‰ã€‘åŠ æŠ¤åŸæ²³ ğŸ£  â† é’©å­ï¼šä½ å¯ä»¥åŠ ï¼Œä¹Ÿå¯ä»¥ä¸åŠ 
ç¬¬4æ­¥ï¼šæ­åŸæ¥¼ âœ…ï¼ˆå¿…é¡»ï¼‰
ç¬¬5æ­¥ï¼šã€å¯é€‰ã€‘åŠ æ——å¸œ ğŸ£    â† é’©å­ï¼šä½ å¯ä»¥åŠ ï¼Œä¹Ÿå¯ä»¥ä¸åŠ 
ç¬¬6æ­¥ï¼šå®Œæˆï¼

å°æ˜ï¼šåŠ äº†æŠ¤åŸæ²³ï¼Œæ²¡åŠ æ——å¸œ
å°çº¢ï¼šæ²¡åŠ æŠ¤åŸæ²³ï¼ŒåŠ äº†æ——å¸œ
å°åï¼šä¸¤ä¸ªéƒ½åŠ äº†
å°åˆšï¼šä¸¤ä¸ªéƒ½æ²¡åŠ 

é’©å­å°±æ˜¯"å¯ä»¥åšï¼Œä¹Ÿå¯ä»¥ä¸åš"çš„æ­¥éª¤ï¼
```

---

### ç±»æ¯”3ï¼šæ§åˆ¶åè½¬ = "å¥½è±ååŸåˆ™"

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šæ¡†æ¶ vs åº“

```typescript
// åº“ï¼šä½ è°ƒç”¨å®ƒ
import axios from 'axios';
const data = await axios.get('/api');  // ä½ æ§åˆ¶æµç¨‹

// æ¡†æ¶ï¼šå®ƒè°ƒç”¨ä½ 
// React æ¡†æ¶æ§åˆ¶ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ
class MyComponent extends React.Component {
  render() {
    // React å†³å®šä»€ä¹ˆæ—¶å€™è°ƒç”¨ render
    // ä½ åªéœ€è¦å‘Šè¯‰å®ƒ"æ€ä¹ˆæ¸²æŸ“"
    return <div>Hello</div>;
  }
}

// æ¨¡æ¿æ–¹æ³•ä¹Ÿæ˜¯æ¡†æ¶è°ƒç”¨ä½ çš„ä»£ç 
```

```python
# Python å¯¹åº”ï¼šLangChain çš„ Runnable
class MyChain(Runnable):
    def _call(self, input):
        # LangChain å†³å®šä»€ä¹ˆæ—¶å€™è°ƒç”¨ _call
        # ä½ åªéœ€è¦å‘Šè¯‰å®ƒ"æ€ä¹ˆå¤„ç†"
        return f"Processed: {input}"

# ä½¿ç”¨æ—¶
chain.invoke("Hello")  # LangChain æ¡†æ¶æ§åˆ¶æ•´ä¸ªæµç¨‹
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šå‚åŠ æ‰è‰ºæ¯”èµ›

**ç”Ÿæ´»ä¾‹å­ï¼š**
```
æ‰è‰ºæ¯”èµ›ï¼ˆå¥½è±ååŸåˆ™ï¼‰ï¼š

ä¸»æŒäººï¼ˆæ¡†æ¶/æ¨¡æ¿æ–¹æ³•ï¼‰ï¼š
"æ¬¢è¿å¤§å®¶ï¼æ¯”èµ›æµç¨‹å¦‚ä¸‹ï¼š"
1. æˆ‘ä»‹ç»é€‰æ‰‹ âœ…ï¼ˆä¸»æŒäººåšï¼‰
2. ã€é€‰æ‰‹è¡¨æ¼”ã€‘   â† ä½ å†³å®šè¡¨æ¼”ä»€ä¹ˆï¼
3. æˆ‘å®£å¸ƒå¾—åˆ† âœ…ï¼ˆä¸»æŒäººåšï¼‰
4. ä¸‹ä¸€ä½é€‰æ‰‹...

å°æ˜ï¼šç¬¬2æ­¥è¡¨æ¼”å”±æ­Œ
å°çº¢ï¼šç¬¬2æ­¥è¡¨æ¼”è·³èˆ
å°åï¼šç¬¬2æ­¥è¡¨æ¼”é­”æœ¯

ä½ ä¸éœ€è¦æ“å¿ƒæ¯”èµ›æµç¨‹ï¼Œåªéœ€è¦å‡†å¤‡å¥½è¡¨æ¼”ï¼
ä¸»æŒäººä¼šåœ¨åˆé€‚çš„æ—¶å€™å«ä½ ä¸Šå°ï¼ˆæ¡†æ¶è°ƒç”¨ä½ çš„ä»£ç ï¼‰
```

---

### ç±»æ¯”4ï¼šæŠ½è±¡æ–¹æ³• vs é’©å­æ–¹æ³•

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šrequired vs optional props

```typescript
// TypeScript æ¥å£
interface ButtonProps {
  label: string;        // å¿…éœ€ï¼šæŠ½è±¡æ–¹æ³•
  onClick: () => void;  // å¿…éœ€ï¼šæŠ½è±¡æ–¹æ³•
  icon?: string;        // å¯é€‰ï¼šé’©å­æ–¹æ³•
  disabled?: boolean;   // å¯é€‰ï¼šé’©å­æ–¹æ³•
}

// ä½¿ç”¨æ—¶
<Button label="Click" onClick={handleClick} />  // å¿…éœ€çš„å¿…é¡»æä¾›
<Button label="Click" onClick={handleClick} icon="star" />  // å¯é€‰çš„éšæ„
```

```python
# Python å¯¹åº”
class BaseButton(ABC):
    @abstractmethod
    def render_label(self): pass  # å¿…éœ€

    @abstractmethod
    def on_click(self): pass      # å¿…éœ€

    def render_icon(self):        # å¯é€‰ï¼ˆé’©å­ï¼‰
        return None

    def is_disabled(self):        # å¯é€‰ï¼ˆé’©å­ï¼‰
        return False
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šå¡«è¡¨æ ¼

**ç”Ÿæ´»ä¾‹å­ï¼š**
```
å…¥å­¦ç™»è®°è¡¨ï¼š

å§“åï¼š_____________ â˜…ï¼ˆå¿…å¡«ï¼‰â† æŠ½è±¡æ–¹æ³•
å¹´é¾„ï¼š_____________ â˜…ï¼ˆå¿…å¡«ï¼‰â† æŠ½è±¡æ–¹æ³•
ç”µè¯ï¼š_____________ â˜…ï¼ˆå¿…å¡«ï¼‰â† æŠ½è±¡æ–¹æ³•
çˆ±å¥½ï¼š_____________ ï¼ˆé€‰å¡«ï¼‰â† é’©å­æ–¹æ³•
ç‰¹é•¿ï¼š_____________ ï¼ˆé€‰å¡«ï¼‰â† é’©å­æ–¹æ³•

â˜… è¡¨ç¤ºå¿…é¡»å¡«å†™ï¼Œä¸å¡«å°±ä¸èƒ½æäº¤
æ²¡æœ‰ â˜… çš„å¯ä»¥å¡«ï¼Œä¹Ÿå¯ä»¥ä¸å¡«
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| æ¨¡æ¿æ–¹æ³•æ¦‚å¿µ | å‰ç«¯ç±»æ¯” | å°æœ‹å‹ç±»æ¯” |
|-------------|---------|-----------|
| æ¨¡æ¿æ–¹æ³• | React ç”Ÿå‘½å‘¨æœŸæµç¨‹ | é£Ÿè°±çš„å›ºå®šæ­¥éª¤ |
| æŠ½è±¡æ–¹æ³• | required props | å¿…å¡«é¡¹ â˜… |
| é’©å­æ–¹æ³• | optional props / ä¸­é—´ä»¶ | å¯é€‰æ­¥éª¤ / é€‰å¡«é¡¹ |
| æ§åˆ¶åè½¬ | æ¡†æ¶ vs åº“ | æ‰è‰ºæ¯”èµ›ä¸»æŒäºº |
| æŠ½è±¡åŸºç±» | React.Component | é£Ÿè°±æ¨¡æ¿ |
| å…·ä½“å®ç°ç±» | MyComponent extends ... | å…·ä½“åšçš„èœ |
| ç®—æ³•éª¨æ¶ | ç»„ä»¶æ¸²æŸ“æµç¨‹ | åšèœçš„æ­¥éª¤é¡ºåº |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šæ¨¡æ¿æ–¹æ³•åªæ˜¯ç®€å•çš„ç»§æ‰¿ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- æ¨¡æ¿æ–¹æ³•çš„æ ¸å¿ƒæ˜¯ **æ§åˆ¶åè½¬**ï¼ˆå¥½è±ååŸåˆ™ï¼‰
- æ™®é€šç»§æ‰¿ï¼šå­ç±»è°ƒç”¨çˆ¶ç±»æ–¹æ³•
- æ¨¡æ¿æ–¹æ³•ï¼š**çˆ¶ç±»è°ƒç”¨å­ç±»æ–¹æ³•**
- è¿™ç§"åå‘è°ƒç”¨"æ‰æ˜¯æ¨¡æ¿æ–¹æ³•çš„ç²¾é«“

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
å› ä¸ºæ¨¡æ¿æ–¹æ³•ç¡®å®ä½¿ç”¨äº†ç»§æ‰¿ï¼Œè€Œä¸”ä»£ç çœ‹èµ·æ¥å°±æ˜¯"å­ç±»ç»§æ‰¿çˆ¶ç±»"ã€‚ä½†çœŸæ­£çš„é­”æ³•åœ¨äºè°ƒç”¨æ–¹å‘ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```python
# æ™®é€šç»§æ‰¿ï¼šå­ç±»è°ƒç”¨çˆ¶ç±»
class Parent:
    def greet(self):
        return "Hello"

class Child(Parent):
    def greet(self):
        parent_greeting = super().greet()  # å­ç±»ä¸»åŠ¨è°ƒç”¨çˆ¶ç±»
        return f"{parent_greeting}, World!"

# æ¨¡æ¿æ–¹æ³•ï¼šçˆ¶ç±»è°ƒç”¨å­ç±»
class Parent(ABC):
    def greet(self):
        # çˆ¶ç±»å®šä¹‰æµç¨‹
        name = self._get_name()  # çˆ¶ç±»è°ƒç”¨å­ç±»çš„æ–¹æ³•ï¼
        return f"Hello, {name}!"

    @abstractmethod
    def _get_name(self):
        pass

class Child(Parent):
    def _get_name(self):
        return "World"  # å­ç±»åªæä¾›æ•°æ®ï¼Œä¸æ§åˆ¶æµç¨‹

# è°ƒç”¨æ–¹å‘å®Œå…¨ä¸åŒï¼
# æ™®é€šç»§æ‰¿ï¼šChild.greet() â†’ Parent.greet()
# æ¨¡æ¿æ–¹æ³•ï¼šParent.greet() â†’ Child._get_name()
```

---

### è¯¯åŒº2ï¼šé’©å­æ–¹æ³•å’ŒæŠ½è±¡æ–¹æ³•æ²¡æœ‰æœ¬è´¨åŒºåˆ« âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- **æŠ½è±¡æ–¹æ³•**ï¼šå®šä¹‰"å¿…é¡»åšä»€ä¹ˆ"ï¼Œå­ç±»**å¿…é¡»**å®ç°
- **é’©å­æ–¹æ³•**ï¼šå®šä¹‰"å¯ä»¥åšä»€ä¹ˆ"ï¼Œå­ç±»**å¯ä»¥é€‰æ‹©**è¦†ç›–
- ä¸€ä¸ªæ˜¯å¼ºåˆ¶å¥‘çº¦ï¼Œä¸€ä¸ªæ˜¯å¯é€‰æ‰©å±•ç‚¹

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
ä¸¤è€…éƒ½æ˜¯åœ¨çˆ¶ç±»ä¸­å®šä¹‰ã€ç”±å­ç±»å®ç°ï¼Œçœ‹èµ·æ¥å¾ˆåƒã€‚ä½†è®¾è®¡æ„å›¾å®Œå…¨ä¸åŒã€‚

**æ­£ç¡®ç†è§£ï¼š**

```python
from abc import ABC, abstractmethod

class PaymentProcessor(ABC):
    def process(self, amount: float):
        # é’©å­ï¼šæ—¥å¿—ï¼ˆå¯é€‰ï¼‰
        self._log_start(amount)

        # æŠ½è±¡ï¼šæ ¸å¿ƒå¤„ç†ï¼ˆå¿…é¡»å®ç°ï¼‰
        result = self._do_payment(amount)

        # é’©å­ï¼šé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        self._notify(result)

        return result

    # é’©å­æ–¹æ³•ï¼šæœ‰é»˜è®¤å®ç°
    def _log_start(self, amount):
        pass  # é»˜è®¤ä¸è®°å½•

    def _notify(self, result):
        pass  # é»˜è®¤ä¸é€šçŸ¥

    # æŠ½è±¡æ–¹æ³•ï¼šå¿…é¡»å®ç°
    @abstractmethod
    def _do_payment(self, amount) -> bool:
        pass

class AlipayProcessor(PaymentProcessor):
    # å¿…é¡»å®ç° _do_payment
    def _do_payment(self, amount) -> bool:
        print(f"æ”¯ä»˜å®æ”¯ä»˜ {amount} å…ƒ")
        return True

    # é€‰æ‹©è¦†ç›–éƒ¨åˆ†é’©å­
    def _notify(self, result):
        print(f"çŸ­ä¿¡é€šçŸ¥: {'æˆåŠŸ' if result else 'å¤±è´¥'}")

class WechatProcessor(PaymentProcessor):
    # å¿…é¡»å®ç° _do_payment
    def _do_payment(self, amount) -> bool:
        print(f"å¾®ä¿¡æ”¯ä»˜ {amount} å…ƒ")
        return True

    # é€‰æ‹©ä¸è¦†ç›–ä»»ä½•é’©å­ - å®Œå…¨å¯ä»¥ï¼

# åŒºåˆ«ï¼š
# - å¦‚æœä¸å®ç° _do_payment â†’ æŠ¥é”™ï¼
# - å¦‚æœä¸è¦†ç›– _notify â†’ æ­£å¸¸è¿è¡Œï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
```

---

### è¯¯åŒº3ï¼šæ¨¡æ¿æ–¹æ³•æ¨¡å¼å·²ç»è¿‡æ—¶ï¼Œåº”è¯¥ç”¨ç­–ç•¥æ¨¡å¼æ›¿ä»£ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- ä¸¤ç§æ¨¡å¼è§£å†³**ä¸åŒçš„é—®é¢˜**
- **æ¨¡æ¿æ–¹æ³•**ï¼šå›ºå®šç®—æ³•éª¨æ¶ï¼Œå­ç±»å®ç°æŸäº›æ­¥éª¤
- **ç­–ç•¥æ¨¡å¼**ï¼šæ•´ä¸ªç®—æ³•å¯æ›¿æ¢
- å®ƒä»¬ç»å¸¸**é…åˆä½¿ç”¨**ï¼Œè€Œä¸æ˜¯äº’ç›¸æ›¿ä»£

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
ä¸¤è€…éƒ½æ¶‰åŠ"å¯å˜çš„è¡Œä¸º"ï¼Œå¾ˆå®¹æ˜“æ··æ·†ã€‚ç°ä»£ç¼–ç¨‹å¼ºè°ƒ"ç»„åˆä¼˜äºç»§æ‰¿"ï¼Œè®©äººè§‰å¾—åŸºäºç»§æ‰¿çš„æ¨¡æ¿æ–¹æ³•ä¸å¥½ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```python
from abc import ABC, abstractmethod

# ===== æ¨¡æ¿æ–¹æ³•ï¼šå›ºå®šéª¨æ¶ï¼Œå¯å˜æ­¥éª¤ =====
class ReportGenerator(ABC):
    def generate(self, data):
        """éª¨æ¶æ˜¯å›ºå®šçš„"""
        header = self._create_header()       # å­ç±»å®ç°
        body = self._create_body(data)       # å­ç±»å®ç°
        footer = self._create_footer()       # å­ç±»å®ç°
        return f"{header}\n{body}\n{footer}"

    @abstractmethod
    def _create_header(self): pass

    @abstractmethod
    def _create_body(self, data): pass

    @abstractmethod
    def _create_footer(self): pass

class HTMLReport(ReportGenerator):
    def _create_header(self):
        return "<html><head>Report</head><body>"

    def _create_body(self, data):
        return f"<p>{data}</p>"

    def _create_footer(self):
        return "</body></html>"

# ===== ç­–ç•¥æ¨¡å¼ï¼šæ•´ä¸ªç®—æ³•å¯æ›¿æ¢ =====
class SortStrategy(ABC):
    @abstractmethod
    def sort(self, data: list) -> list:
        pass

class QuickSort(SortStrategy):
    def sort(self, data):
        # æ•´ä¸ªå¿«æ’ç®—æ³•
        if len(data) <= 1:
            return data
        pivot = data[len(data) // 2]
        left = [x for x in data if x < pivot]
        middle = [x for x in data if x == pivot]
        right = [x for x in data if x > pivot]
        return self.sort(left) + middle + self.sort(right)

class BubbleSort(SortStrategy):
    def sort(self, data):
        # æ•´ä¸ªå†’æ³¡æ’åºç®—æ³•ï¼ˆå®Œå…¨ä¸åŒçš„å®ç°ï¼‰
        arr = data.copy()
        n = len(arr)
        for i in range(n):
            for j in range(0, n-i-1):
                if arr[j] > arr[j+1]:
                    arr[j], arr[j+1] = arr[j+1], arr[j]
        return arr

class DataProcessor:
    def __init__(self, sort_strategy: SortStrategy):
        self.sorter = sort_strategy  # ç»„åˆï¼Œä¸æ˜¯ç»§æ‰¿

    def process(self, data):
        return self.sorter.sort(data)  # å§”æ‰˜ç»™ç­–ç•¥

# é€‰æ‹©åœºæ™¯ï¼š
# - æ¨¡æ¿æ–¹æ³•ï¼šæµç¨‹å›ºå®šï¼Œéƒ¨åˆ†æ­¥éª¤å¯å˜ â†’ ç”¨ç»§æ‰¿
# - ç­–ç•¥æ¨¡å¼ï¼šæ•´ä¸ªç®—æ³•å¯æ›¿æ¢ â†’ ç”¨ç»„åˆ
# - LangChain ä¸¤è€…éƒ½ç”¨ï¼š
#   - BaseChatModel ç”¨æ¨¡æ¿æ–¹æ³•ï¼ˆinvoke æµç¨‹å›ºå®šï¼‰
#   - Chain ç”¨ç­–ç•¥æ¨¡å¼ï¼ˆLLM å¯æ›¿æ¢ï¼‰
```

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

```python
"""
ç¤ºä¾‹ï¼šæ„å»º LangChain é£æ ¼çš„æ¨¡æ¿æ–¹æ³•ç³»ç»Ÿ
æ¼”ç¤ºæ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨ LLM åº”ç”¨æ¡†æ¶ä¸­çš„æ ¸å¿ƒç”¨æ³•
"""

from abc import ABC, abstractmethod
from typing import Any, Dict, List, Optional, Generator
from dataclasses import dataclass
from datetime import datetime
import time

# ===== 1. åŸºç¡€æ¶ˆæ¯ç±»å‹ =====
print("=== 1. åŸºç¡€æ¶ˆæ¯ç±»å‹ ===")

@dataclass
class Message:
    role: str
    content: str
    timestamp: datetime = None

    def __post_init__(self):
        if self.timestamp is None:
            self.timestamp = datetime.now()

@dataclass
class ChatResult:
    message: Message
    model: str
    usage: Dict[str, int]

# ===== 2. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼šBaseChatModel =====
print("\n=== 2. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼šBaseChatModel ===")

class BaseChatModel(ABC):
    """
    èŠå¤©æ¨¡å‹æŠ½è±¡åŸºç±» - å±•ç¤ºæ¨¡æ¿æ–¹æ³•æ¨¡å¼

    ç±»ä¼¼ LangChain çš„ BaseChatModel
    """

    def __init__(self, model_name: str = "base", temperature: float = 0.7):
        self.model_name = model_name
        self.temperature = temperature
        self._call_count = 0

    # ===== æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰ç®—æ³•éª¨æ¶ =====

    def invoke(self, input: str) -> Message:
        """
        æ¨¡æ¿æ–¹æ³•ï¼šè°ƒç”¨æµç¨‹

        æµç¨‹ï¼šéªŒè¯ â†’ é¢„å¤„ç† â†’ ç”Ÿæˆ â†’ åå¤„ç†
        """
        # æ­¥éª¤1ï¼šéªŒè¯è¾“å…¥ï¼ˆå›ºå®šï¼‰
        self._validate_input(input)

        # æ­¥éª¤2ï¼šé¢„å¤„ç†ï¼ˆé’©å­ï¼Œå¯è¦†ç›–ï¼‰
        processed_input = self._preprocess(input)

        # æ­¥éª¤3ï¼šç”Ÿæˆå“åº”ï¼ˆæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°ï¼‰
        result = self._generate(processed_input)

        # æ­¥éª¤4ï¼šåå¤„ç†ï¼ˆé’©å­ï¼Œå¯è¦†ç›–ï¼‰
        final_result = self._postprocess(result)

        # æ›´æ–°ç»Ÿè®¡
        self._call_count += 1

        return final_result.message

    def stream(self, input: str) -> Generator[str, None, None]:
        """
        æ¨¡æ¿æ–¹æ³•ï¼šæµå¼è°ƒç”¨
        """
        self._validate_input(input)
        processed_input = self._preprocess(input)

        # æµå¼ç”Ÿæˆï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰
        for chunk in self._stream_generate(processed_input):
            yield self._process_chunk(chunk)

        self._call_count += 1

    # ===== å›ºå®šæ­¥éª¤ï¼šæ‰€æœ‰å­ç±»å…±äº« =====

    def _validate_input(self, input: str):
        """éªŒè¯è¾“å…¥"""
        if not input or not input.strip():
            raise ValueError("è¾“å…¥ä¸èƒ½ä¸ºç©º")

    # ===== é’©å­æ–¹æ³•ï¼šæœ‰é»˜è®¤å®ç°ï¼Œå­ç±»å¯é€‰æ‹©è¦†ç›– =====

    def _preprocess(self, input: str) -> str:
        """é¢„å¤„ç†è¾“å…¥"""
        return input.strip()

    def _postprocess(self, result: ChatResult) -> ChatResult:
        """åå¤„ç†ç»“æœ"""
        return result

    def _process_chunk(self, chunk: str) -> str:
        """å¤„ç†å•ä¸ªæµå¼å—"""
        return chunk

    # ===== æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å¿…é¡»å®ç° =====

    @abstractmethod
    def _generate(self, input: str) -> ChatResult:
        """ç”Ÿæˆå“åº” - å­ç±»å¿…é¡»å®ç°"""
        pass

    @abstractmethod
    def _stream_generate(self, input: str) -> Generator[str, None, None]:
        """æµå¼ç”Ÿæˆ - å­ç±»å¿…é¡»å®ç°"""
        pass

    # ===== å±æ€§ =====

    @property
    def call_count(self) -> int:
        return self._call_count

# ===== 3. å…·ä½“å®ç°ç±» =====
print("\n=== 3. å…·ä½“å®ç°ç±» ===")

class FakeOpenAI(BaseChatModel):
    """æ¨¡æ‹Ÿ OpenAI æ¨¡å‹"""

    def __init__(self, temperature: float = 0.7):
        super().__init__(model_name="gpt-4-fake", temperature=temperature)

    def _generate(self, input: str) -> ChatResult:
        """å®ç°å…·ä½“çš„ç”Ÿæˆé€»è¾‘"""
        # æ¨¡æ‹Ÿ API è°ƒç”¨å»¶è¿Ÿ
        time.sleep(0.1)

        response = f"[OpenAI] æ”¶åˆ°: {input}"
        return ChatResult(
            message=Message(role="assistant", content=response),
            model=self.model_name,
            usage={"input_tokens": len(input), "output_tokens": len(response)}
        )

    def _stream_generate(self, input: str) -> Generator[str, None, None]:
        """å®ç°æµå¼ç”Ÿæˆ"""
        response = f"[OpenAI] æ”¶åˆ°: {input}"
        for char in response:
            time.sleep(0.01)  # æ¨¡æ‹Ÿæµå¼å»¶è¿Ÿ
            yield char

class FakeAnthropic(BaseChatModel):
    """æ¨¡æ‹Ÿ Anthropic æ¨¡å‹"""

    def __init__(self, temperature: float = 0.7):
        super().__init__(model_name="claude-3-fake", temperature=temperature)

    def _preprocess(self, input: str) -> str:
        """è¦†ç›–é¢„å¤„ç†ï¼šæ·»åŠ  Human/Assistant æ ¼å¼"""
        base = super()._preprocess(input)
        return f"Human: {base}\n\nAssistant:"

    def _generate(self, input: str) -> ChatResult:
        """å®ç°å…·ä½“çš„ç”Ÿæˆé€»è¾‘"""
        time.sleep(0.1)

        # ç§»é™¤ Human/Assistant å‰ç¼€ï¼Œåªè¿”å›å†…å®¹
        response = f"[Claude] æˆ‘æ¥å¸®åŠ©ä½ å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚"
        return ChatResult(
            message=Message(role="assistant", content=response),
            model=self.model_name,
            usage={"input_tokens": len(input), "output_tokens": len(response)}
        )

    def _stream_generate(self, input: str) -> Generator[str, None, None]:
        response = "[Claude] æˆ‘æ¥å¸®åŠ©ä½ å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚"
        for char in response:
            time.sleep(0.01)
            yield char

    def _postprocess(self, result: ChatResult) -> ChatResult:
        """è¦†ç›–åå¤„ç†ï¼šæ·»åŠ æ¨¡å‹æ ‡è¯†"""
        result.message.content = f"âœ¨ {result.message.content}"
        return result

class FakeLocalLLM(BaseChatModel):
    """æ¨¡æ‹Ÿæœ¬åœ°æ¨¡å‹"""

    def __init__(self, model_path: str = "/models/llama"):
        super().__init__(model_name="llama-local", temperature=0.5)
        self.model_path = model_path

    def _validate_input(self, input: str):
        """è¦†ç›–éªŒè¯ï¼šæœ¬åœ°æ¨¡å‹æœ‰é•¿åº¦é™åˆ¶"""
        super()._validate_input(input)
        if len(input) > 1000:
            raise ValueError("æœ¬åœ°æ¨¡å‹è¾“å…¥é•¿åº¦ä¸èƒ½è¶…è¿‡ 1000 å­—ç¬¦")

    def _generate(self, input: str) -> ChatResult:
        response = f"[Local LLM] æœ¬åœ°å¤„ç†: {input[:50]}..."
        return ChatResult(
            message=Message(role="assistant", content=response),
            model=self.model_name,
            usage={"input_tokens": len(input), "output_tokens": len(response)}
        )

    def _stream_generate(self, input: str) -> Generator[str, None, None]:
        response = f"[Local LLM] æœ¬åœ°å¤„ç†å®Œæˆ"
        for word in response.split():
            time.sleep(0.05)
            yield word + " "

# æµ‹è¯•åŸºæœ¬è°ƒç”¨
openai = FakeOpenAI()
anthropic = FakeAnthropic()
local = FakeLocalLLM()

print("OpenAI:", openai.invoke("Hello!").content)
print("Anthropic:", anthropic.invoke("Hello!").content)
print("Local:", local.invoke("Hello!").content)

# ===== 4. å¤šæ€è°ƒç”¨ =====
print("\n=== 4. å¤šæ€è°ƒç”¨ ===")

def chat_with_model(model: BaseChatModel, message: str) -> str:
    """
    å¤šæ€ï¼šä¸å…³å¿ƒå…·ä½“æ˜¯å“ªä¸ªæ¨¡å‹
    ç»Ÿä¸€çš„è°ƒç”¨æ¥å£
    """
    return model.invoke(message).content

models: List[BaseChatModel] = [openai, anthropic, local]
for model in models:
    print(f"{model.model_name}: {chat_with_model(model, 'Test')}")

# ===== 5. æµå¼è¾“å‡º =====
print("\n=== 5. æµå¼è¾“å‡º ===")

print("æµå¼è¾“å‡ºæµ‹è¯•: ", end="")
for chunk in openai.stream("æµå¼æµ‹è¯•"):
    print(chunk, end="", flush=True)
print()

# ===== 6. å¸¦å›è°ƒçš„æ¨¡å‹ï¼ˆé’©å­æ–¹æ³•çš„é«˜çº§ç”¨æ³•ï¼‰ =====
print("\n=== 6. å¸¦å›è°ƒçš„æ¨¡å‹ ===")

class CallbackChatModel(BaseChatModel):
    """å¸¦å›è°ƒçš„èŠå¤©æ¨¡å‹ - å±•ç¤ºé’©å­æ–¹æ³•"""

    def __init__(self, base_model: BaseChatModel):
        super().__init__(model_name=f"callback-{base_model.model_name}")
        self.base = base_model
        self.callbacks: List[callable] = []

    def add_callback(self, callback: callable):
        self.callbacks.append(callback)

    def _preprocess(self, input: str) -> str:
        # è§¦å‘å›è°ƒ
        for cb in self.callbacks:
            cb("preprocess", {"input": input})
        return self.base._preprocess(input)

    def _generate(self, input: str) -> ChatResult:
        # è§¦å‘å›è°ƒ
        for cb in self.callbacks:
            cb("generate_start", {"input": input})

        result = self.base._generate(input)

        for cb in self.callbacks:
            cb("generate_end", {"result": result})

        return result

    def _stream_generate(self, input: str) -> Generator[str, None, None]:
        for chunk in self.base._stream_generate(input):
            for cb in self.callbacks:
                cb("chunk", {"chunk": chunk})
            yield chunk

    def _postprocess(self, result: ChatResult) -> ChatResult:
        for cb in self.callbacks:
            cb("postprocess", {"result": result})
        return self.base._postprocess(result)

# ä½¿ç”¨å›è°ƒ
def my_callback(event: str, data: dict):
    print(f"  [Callback] {event}: {str(data)[:50]}...")

callback_model = CallbackChatModel(openai)
callback_model.add_callback(my_callback)
print("å¸¦å›è°ƒçš„è°ƒç”¨:")
callback_model.invoke("Hello with callback!")

# ===== 7. æ–‡æ¡£åŠ è½½å™¨ï¼ˆå¦ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ç¤ºä¾‹ï¼‰ =====
print("\n=== 7. æ–‡æ¡£åŠ è½½å™¨ ===")

class BaseDocumentLoader(ABC):
    """æ–‡æ¡£åŠ è½½å™¨æŠ½è±¡åŸºç±»"""

    def load(self) -> List[Dict[str, Any]]:
        """æ¨¡æ¿æ–¹æ³•"""
        self._validate()
        raw = self._load_raw()
        docs = self._parse(raw)
        return self._add_metadata(docs)

    def _validate(self):
        pass

    def _add_metadata(self, docs: List[Dict]) -> List[Dict]:
        for doc in docs:
            doc["loader"] = self.__class__.__name__
            doc["loaded_at"] = datetime.now().isoformat()
        return docs

    @abstractmethod
    def _load_raw(self) -> Any:
        pass

    @abstractmethod
    def _parse(self, raw: Any) -> List[Dict[str, Any]]:
        pass

class TextLoader(BaseDocumentLoader):
    def __init__(self, content: str):
        self.content = content

    def _load_raw(self) -> str:
        return self.content

    def _parse(self, raw: str) -> List[Dict[str, Any]]:
        return [{"content": raw, "type": "text"}]

class JSONLoader(BaseDocumentLoader):
    def __init__(self, data: dict):
        self.data = data

    def _load_raw(self) -> dict:
        return self.data

    def _parse(self, raw: dict) -> List[Dict[str, Any]]:
        return [{"content": str(raw), "type": "json", "keys": list(raw.keys())}]

# ä½¿ç”¨
text_loader = TextLoader("Hello, World!")
json_loader = JSONLoader({"name": "test", "value": 123})

print("Text Loader:", text_loader.load())
print("JSON Loader:", json_loader.load())

# ===== 8. æ£€ç´¢å™¨ï¼ˆå±•ç¤ºæ›´å¤æ‚çš„æ¨¡æ¿æ–¹æ³•ï¼‰ =====
print("\n=== 8. æ£€ç´¢å™¨ ===")

class BaseRetriever(ABC):
    """æ£€ç´¢å™¨æŠ½è±¡åŸºç±»"""

    def __init__(self, top_k: int = 3):
        self.top_k = top_k

    def retrieve(self, query: str) -> List[Dict[str, Any]]:
        """æ¨¡æ¿æ–¹æ³•ï¼šæ£€ç´¢æµç¨‹"""
        # 1. é¢„å¤„ç†æŸ¥è¯¢
        processed = self._preprocess_query(query)

        # 2. æ‰§è¡Œæ£€ç´¢
        results = self._do_retrieve(processed)

        # 3. é‡æ’åº
        ranked = self._rerank(results)

        # 4. æˆªæ–­
        return ranked[:self.top_k]

    def _preprocess_query(self, query: str) -> str:
        return query.lower().strip()

    def _rerank(self, results: List[Dict]) -> List[Dict]:
        return sorted(results, key=lambda x: x.get("score", 0), reverse=True)

    @abstractmethod
    def _do_retrieve(self, query: str) -> List[Dict[str, Any]]:
        pass

class SimpleRetriever(BaseRetriever):
    def __init__(self, documents: List[str], top_k: int = 3):
        super().__init__(top_k)
        self.documents = documents

    def _do_retrieve(self, query: str) -> List[Dict[str, Any]]:
        results = []
        for i, doc in enumerate(self.documents):
            if query in doc.lower():
                results.append({
                    "id": i,
                    "content": doc,
                    "score": doc.lower().count(query)
                })
        return results

# ä½¿ç”¨
docs = [
    "Python is a programming language",
    "Python is great for AI",
    "JavaScript is for web",
    "Python and AI are related"
]
retriever = SimpleRetriever(docs, top_k=2)
print("æ£€ç´¢ 'python':", retriever.retrieve("python"))

print("\n=== å®Œæˆ ===")
print(f"OpenAI è°ƒç”¨æ¬¡æ•°: {openai.call_count}")
print(f"Anthropic è°ƒç”¨æ¬¡æ•°: {anthropic.call_count}")
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**
```
=== 1. åŸºç¡€æ¶ˆæ¯ç±»å‹ ===

=== 2. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼šBaseChatModel ===

=== 3. å…·ä½“å®ç°ç±» ===
OpenAI: [OpenAI] æ”¶åˆ°: Hello!
Anthropic: âœ¨ [Claude] æˆ‘æ¥å¸®åŠ©ä½ å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚
Local: [Local LLM] æœ¬åœ°å¤„ç†: Hello!...

=== 4. å¤šæ€è°ƒç”¨ ===
gpt-4-fake: [OpenAI] æ”¶åˆ°: Test
claude-3-fake: âœ¨ [Claude] æˆ‘æ¥å¸®åŠ©ä½ å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚
llama-local: [Local LLM] æœ¬åœ°å¤„ç†: Test...

=== 5. æµå¼è¾“å‡º ===
æµå¼è¾“å‡ºæµ‹è¯•: [OpenAI] æ”¶åˆ°: æµå¼æµ‹è¯•

=== 6. å¸¦å›è°ƒçš„æ¨¡å‹ ===
å¸¦å›è°ƒçš„è°ƒç”¨:
  [Callback] preprocess: {'input': 'Hello with callback!'}...
  [Callback] generate_start: {'input': 'Hello with callback!'}...
  [Callback] generate_end: {'result': ChatResult(message=Message...
  [Callback] postprocess: {'result': ChatResult(message=Message...

=== 7. æ–‡æ¡£åŠ è½½å™¨ ===
Text Loader: [{'content': 'Hello, World!', 'type': 'text', 'loader': 'TextLoader', 'loaded_at': '...'}]
JSON Loader: [{'content': "{'name': 'test', 'value': 123}", 'type': 'json', 'keys': ['name', 'value'], 'loader': 'JSONLoader', 'loaded_at': '...'}]

=== 8. æ£€ç´¢å™¨ ===
æ£€ç´¢ 'python': [{'id': 1, 'content': 'Python is great for AI', 'score': 1}, {'id': 0, 'content': 'Python is a programming language', 'score': 1}]

=== å®Œæˆ ===
OpenAI è°ƒç”¨æ¬¡æ•°: 4
Anthropic è°ƒç”¨æ¬¡æ•°: 2
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜ï¼š"ä»€ä¹ˆæ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Ÿåœ¨å®é™…é¡¹ç›®ä¸­æ€ä¹ˆä½¿ç”¨ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯åœ¨çˆ¶ç±»ä¸­å®šä¹‰ç®—æ³•éª¨æ¶ï¼ŒæŠŠå…·ä½“æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»å®ç°ã€‚æ¯”å¦‚å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œé‡Œé¢æœ‰ä¸ªæ¨¡æ¿æ–¹æ³•è°ƒç”¨ä¸€äº›æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¿™äº›æŠ½è±¡æ–¹æ³•ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **æ¨¡æ¿æ–¹æ³•æ¨¡å¼æœ‰ä¸‰å±‚ç†è§£ï¼š**
>
> 1. **è®¾è®¡å±‚é¢**ï¼š
>    - æ ¸å¿ƒæ€æƒ³æ˜¯ **"æ§åˆ¶åè½¬"**ï¼ˆå¥½è±ååŸåˆ™ï¼‰
>    - çˆ¶ç±»æ§åˆ¶ç®—æ³•æµç¨‹ï¼Œå­ç±»åªæä¾›å…·ä½“å®ç°
>    - ä¸æ™®é€šç»§æ‰¿çš„åŒºåˆ«ï¼šæ™®é€šç»§æ‰¿æ˜¯å­ç±»è°ƒç”¨çˆ¶ç±»ï¼Œæ¨¡æ¿æ–¹æ³•æ˜¯çˆ¶ç±»è°ƒç”¨å­ç±»
>
> 2. **ç»“æ„å±‚é¢**ï¼š
>    - **æ¨¡æ¿æ–¹æ³•**ï¼šå®šä¹‰ç®—æ³•éª¨æ¶çš„ public æ–¹æ³•
>    - **æŠ½è±¡æ–¹æ³•**ï¼šå­ç±»å¿…é¡»å®ç°çš„æ­¥éª¤
>    - **é’©å­æ–¹æ³•**ï¼šå­ç±»å¯é€‰è¦†ç›–çš„æ‰©å±•ç‚¹
>
> 3. **å®è·µå±‚é¢**ï¼š
>    - é€‚ç”¨åœºæ™¯ï¼šå¤šä¸ªç±»æœ‰ç›¸åŒçš„ç®—æ³•æµç¨‹ï¼Œä½†æŸäº›æ­¥éª¤ä¸åŒ
>    - å…¸å‹ä¾‹å­ï¼šLangChain çš„ `BaseChatModel.invoke()` è°ƒç”¨ `_generate()`
>    - å¥½å¤„ï¼šé¿å…ä»£ç é‡å¤ã€ä¿è¯æµç¨‹ä¸€è‡´ã€æ˜“äºæ‰©å±•
>
> **åœ¨ LangChain æºç ä¸­çš„åº”ç”¨**ï¼š
> ```python
> # BaseChatModel ä½¿ç”¨æ¨¡æ¿æ–¹æ³•
> class BaseChatModel(ABC):
>     def invoke(self, input):      # æ¨¡æ¿æ–¹æ³•
>         messages = self._convert(input)
>         result = self._generate(messages)  # è°ƒç”¨å­ç±»
>         return result.message
>
>     @abstractmethod
>     def _generate(self, messages):  # æŠ½è±¡æ–¹æ³•
>         pass
>
> # ChatOpenAI å®ç°å…·ä½“æ­¥éª¤
> class ChatOpenAI(BaseChatModel):
>     def _generate(self, messages):
>         return self.client.chat(messages)
> ```
>
> **ä¸ç­–ç•¥æ¨¡å¼çš„åŒºåˆ«**ï¼š
> - æ¨¡æ¿æ–¹æ³•ï¼šå›ºå®šéª¨æ¶ï¼Œå¯å˜æ­¥éª¤ï¼ˆç”¨ç»§æ‰¿ï¼‰
> - ç­–ç•¥æ¨¡å¼ï¼šæ•´ä¸ªç®—æ³•å¯æ›¿æ¢ï¼ˆç”¨ç»„åˆï¼‰
> - LangChain ä¸¤è€…éƒ½ç”¨ï¼Œå–å†³äºåœºæ™¯

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… å¤šå±‚æ¬¡è§£é‡Šï¼ˆè®¾è®¡/ç»“æ„/å®è·µï¼‰
2. âœ… å¼ºè°ƒæ ¸å¿ƒæ¦‚å¿µï¼ˆæ§åˆ¶åè½¬ï¼‰
3. âœ… ç”¨ LangChain çœŸå®ä»£ç ä¸¾ä¾‹
4. âœ… å¯¹æ¯”ç›¸å…³æ¨¡å¼ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰

---

### é—®é¢˜ï¼š"æ¨¡æ¿æ–¹æ³•å’Œç­–ç•¥æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸ªï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"æ¨¡æ¿æ–¹æ³•ç”¨ç»§æ‰¿ï¼Œç­–ç•¥æ¨¡å¼ç”¨ç»„åˆã€‚ä¸€èˆ¬ä¼˜å…ˆç”¨ç­–ç•¥æ¨¡å¼ï¼Œå› ä¸ºç»„åˆæ›´çµæ´»ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **ä¸¤è€…è§£å†³ä¸åŒçš„é—®é¢˜ï¼š**
>
> | å¯¹æ¯”ç»´åº¦ | æ¨¡æ¿æ–¹æ³• | ç­–ç•¥æ¨¡å¼ |
> |---------|---------|---------|
> | å¯å˜ç²’åº¦ | ç®—æ³•çš„æŸäº›**æ­¥éª¤**å¯å˜ | æ•´ä¸ª**ç®—æ³•**å¯æ›¿æ¢ |
> | å®ç°æ–¹å¼ | ç»§æ‰¿ | ç»„åˆ |
> | æ‰©å±•æ–¹å¼ | æ–°å»ºå­ç±» | æ–°å»ºç­–ç•¥ç±» + æ³¨å…¥ |
> | è¿è¡Œæ—¶åˆ‡æ¢ | ä¸æ”¯æŒ | æ”¯æŒ |
>
> **é€‰æ‹©æ ‡å‡†ï¼š**
> - **ç”¨æ¨¡æ¿æ–¹æ³•**ï¼šå½“ç®—æ³•éª¨æ¶å›ºå®šï¼Œåªæ˜¯æŸäº›æ­¥éª¤éœ€è¦ä¸åŒå®ç°
>   - ä¾‹ï¼šLangChain çš„ `BaseChatModel`ï¼ˆinvoke æµç¨‹å›ºå®šï¼Œ_generate å¯å˜ï¼‰
>
> - **ç”¨ç­–ç•¥æ¨¡å¼**ï¼šå½“éœ€è¦è¿è¡Œæ—¶åˆ‡æ¢æ•´ä¸ªç®—æ³•
>   - ä¾‹ï¼šæ’åºç®—æ³•é€‰æ‹©ï¼ˆå¿«æ’/å½’å¹¶/å †æ’ï¼‰
>
> **LangChain ä¸­çš„å®é™…åº”ç”¨**ï¼š
> ```python
> # æ¨¡æ¿æ–¹æ³•ï¼šBaseChatModel
> class BaseChatModel(ABC):
>     def invoke(self, input):  # å›ºå®šæµç¨‹
>         # ... è°ƒç”¨ _generate
>
>     @abstractmethod
>     def _generate(self): pass
>
> # ç­–ç•¥æ¨¡å¼ï¼šChain ä½¿ç”¨ä¸åŒçš„ LLM
> class Chain:
>     def __init__(self, llm: BaseChatModel):  # ç­–ç•¥æ³¨å…¥
>         self.llm = llm
>
>     def run(self, input):
>         return self.llm.invoke(input)
>
> # è¿è¡Œæ—¶åˆ‡æ¢
> chain = Chain(llm=ChatOpenAI())
> chain.llm = ChatAnthropic()  # åŠ¨æ€åˆ‡æ¢ï¼
> ```
>
> **ä¸¤è€…ç»å¸¸é…åˆä½¿ç”¨**ï¼š
> - `BaseChatModel` å†…éƒ¨ç”¨æ¨¡æ¿æ–¹æ³•å®šä¹‰ invoke æµç¨‹
> - `Chain` ç”¨ç­–ç•¥æ¨¡å¼ç»„åˆä¸åŒçš„ LLM

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šä»€ä¹ˆæ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼ ğŸ¯

**ä¸€å¥è¯ï¼š** åœ¨çˆ¶ç±»ä¸­å®šä¹‰ç®—æ³•éª¨æ¶ï¼Œå°†æŸäº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»å®ç°ã€‚

**ä¸¾ä¾‹ï¼š**
```python
class Chef(ABC):
    def cook(self):  # æ¨¡æ¿æ–¹æ³•ï¼šå›ºå®šæµç¨‹
        self.prepare()
        self.do_cook()  # å­ç±»å®ç°
        self.serve()

    @abstractmethod
    def do_cook(self): pass
```

**åº”ç”¨ï¼š** LangChain çš„ `BaseChatModel.invoke()` å°±æ˜¯æ¨¡æ¿æ–¹æ³•ã€‚

---

### å¡ç‰‡2ï¼šæ§åˆ¶åè½¬ï¼ˆå¥½è±ååŸåˆ™ï¼‰ ğŸ¬

**ä¸€å¥è¯ï¼š** "Don't call us, we'll call you" - çˆ¶ç±»è°ƒç”¨å­ç±»ï¼Œè€Œéç›¸åã€‚

**ä¸¾ä¾‹ï¼š**
```python
# æ™®é€šç»§æ‰¿ï¼šå­ç±»è°ƒç”¨çˆ¶ç±»
result = super().method()

# æ¨¡æ¿æ–¹æ³•ï¼šçˆ¶ç±»è°ƒç”¨å­ç±»
class Parent:
    def run(self):
        self._do_work()  # çˆ¶ç±»è°ƒç”¨å­ç±»çš„æ–¹æ³•ï¼
```

**åº”ç”¨ï¼š** LangChain æ¡†æ¶è°ƒç”¨ä½ å®ç°çš„ `_generate()` æ–¹æ³•ã€‚

---

### å¡ç‰‡3ï¼šæŠ½è±¡æ–¹æ³• ğŸ”’

**ä¸€å¥è¯ï¼š** å­ç±»**å¿…é¡»**å®ç°çš„æ–¹æ³•ï¼Œæ˜¯ç®—æ³•ä¸­çš„å¿…éœ€æ­¥éª¤ã€‚

**ä¸¾ä¾‹ï¼š**
```python
from abc import ABC, abstractmethod

class Model(ABC):
    @abstractmethod
    def _generate(self, input):
        """å­ç±»å¿…é¡»å®ç°ï¼"""
        pass
```

**åº”ç”¨ï¼š** `BaseChatModel._generate()` æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œæ¯ä¸ª LLM éƒ½è¦å®ç°ã€‚

---

### å¡ç‰‡4ï¼šé’©å­æ–¹æ³• ğŸ£

**ä¸€å¥è¯ï¼š** å­ç±»**å¯é€‰**è¦†ç›–çš„æ–¹æ³•ï¼Œæä¾›é»˜è®¤å®ç°ã€‚

**ä¸¾ä¾‹ï¼š**
```python
class Model(ABC):
    def _preprocess(self, input):
        """é’©å­ï¼šæœ‰é»˜è®¤å®ç°ï¼Œå­ç±»å¯é€‰è¦†ç›–"""
        return input.strip()

    def _on_error(self, error):
        """é’©å­ï¼šé»˜è®¤ä¸å¤„ç†"""
        pass
```

**åº”ç”¨ï¼š** LangChain Callback çš„ `on_llm_start()` ç­‰éƒ½æ˜¯é’©å­æ–¹æ³•ã€‚

---

### å¡ç‰‡5ï¼šæ¨¡æ¿æ–¹æ³• vs æŠ½è±¡æ–¹æ³• vs é’©å­æ–¹æ³• ğŸ“Š

**ä¸€å¥è¯ï¼š** ä¸‰ç§æ–¹æ³•å„æœ‰åˆ†å·¥ï¼Œå…±åŒæ„æˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‚

| ç±»å‹ | ä½œç”¨ | å¿…é¡»å®ç°ï¼Ÿ |
|------|------|----------|
| æ¨¡æ¿æ–¹æ³• | å®šä¹‰ç®—æ³•éª¨æ¶ | âŒ ä¸è¦†ç›– |
| æŠ½è±¡æ–¹æ³• | å¿…éœ€çš„å¯å˜æ­¥éª¤ | âœ… å¿…é¡» |
| é’©å­æ–¹æ³• | å¯é€‰çš„æ‰©å±•ç‚¹ | âŒ å¯é€‰ |

**åº”ç”¨ï¼š** ç†è§£è¿™ä¸‰è€…çš„åŒºåˆ«æ˜¯è¯»æ‡‚ LangChain æºç çš„å…³é”®ã€‚

---

### å¡ç‰‡6ï¼šæ¨¡æ¿æ–¹æ³•çš„ä»£ç ç»“æ„ ğŸ—ï¸

**ä¸€å¥è¯ï¼š** æ ‡å‡†ç»“æ„ï¼šæ¨¡æ¿æ–¹æ³• + å›ºå®šæ­¥éª¤ + æŠ½è±¡æ–¹æ³• + é’©å­æ–¹æ³•ã€‚

**ä¸¾ä¾‹ï¼š**
```python
class Base(ABC):
    def invoke(self, input):      # æ¨¡æ¿æ–¹æ³•
        self._validate(input)      # å›ºå®šæ­¥éª¤
        result = self._call(input) # æŠ½è±¡æ–¹æ³•
        return self._format(result) # é’©å­æ–¹æ³•

    def _validate(self, input):   # å›ºå®š
        if not input: raise ValueError()

    @abstractmethod
    def _call(self, input): pass  # æŠ½è±¡

    def _format(self, result):    # é’©å­
        return result
```

**åº”ç”¨ï¼š** LangChain çš„ Runnableã€ChatModelã€Loader éƒ½éµå¾ªè¿™ä¸ªç»“æ„ã€‚

---

### å¡ç‰‡7ï¼šæ¨¡æ¿æ–¹æ³• vs ç­–ç•¥æ¨¡å¼ âš”ï¸

**ä¸€å¥è¯ï¼š** æ¨¡æ¿æ–¹æ³•å›ºå®šéª¨æ¶ï¼ˆç»§æ‰¿ï¼‰ï¼Œç­–ç•¥æ¨¡å¼æ›¿æ¢ç®—æ³•ï¼ˆç»„åˆï¼‰ã€‚

**ä¸¾ä¾‹ï¼š**
```python
# æ¨¡æ¿æ–¹æ³•ï¼šéª¨æ¶å›ºå®šï¼Œæ­¥éª¤å¯å˜
class Model(ABC):
    def invoke(self):
        self._call()  # å­ç±»å®ç°

# ç­–ç•¥æ¨¡å¼ï¼šæ•´ä¸ªç®—æ³•å¯æ›¿æ¢
class Chain:
    def __init__(self, llm):
        self.llm = llm  # è¿è¡Œæ—¶å¯æ¢
```

**åº”ç”¨ï¼š** LangChain å†…éƒ¨ç”¨æ¨¡æ¿æ–¹æ³•ï¼ŒChain ç»„åˆç”¨ç­–ç•¥æ¨¡å¼ã€‚

---

### å¡ç‰‡8ï¼šLangChain ä¸­çš„æ¨¡æ¿æ–¹æ³• ğŸ¦œ

**ä¸€å¥è¯ï¼š** LangChain æ ¸å¿ƒç»„ä»¶éƒ½ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‚

**ä¸¾ä¾‹ï¼š**
```python
# BaseChatModel
invoke() â†’ _generate()

# BaseRetriever
invoke() â†’ _get_relevant_documents()

# BaseLoader
load() â†’ lazy_load()

# BaseCallbackHandler
on_llm_start(), on_llm_end()  # å…¨æ˜¯é’©å­
```

**åº”ç”¨ï¼š** æ‰©å±• LangChain åªéœ€ç»§æ‰¿åŸºç±»ï¼Œå®ç°æŠ½è±¡æ–¹æ³•ã€‚

---

### å¡ç‰‡9ï¼šå®ç°è‡ªå®šä¹‰ LangChain ç»„ä»¶ ğŸ”§

**ä¸€å¥è¯ï¼š** ç»§æ‰¿åŸºç±» â†’ å®ç°æŠ½è±¡æ–¹æ³• â†’ å¯é€‰è¦†ç›–é’©å­ã€‚

**ä¸¾ä¾‹ï¼š**
```python
from langchain_core.language_models import BaseChatModel

class MyChatModel(BaseChatModel):
    def _generate(self, messages, **kwargs):
        # å®ç°è¿™ä¸€ä¸ªæ–¹æ³•å³å¯ï¼
        return ChatResult(...)

    def _preprocess(self, input):
        # å¯é€‰ï¼šè¦†ç›–é’©å­
        return input.upper()
```

**åº”ç”¨ï¼š** åˆ›å»ºè‡ªå®šä¹‰ LLMã€Retrieverã€Loader éƒ½æ˜¯è¿™ä¸ªå¥—è·¯ã€‚

---

### å¡ç‰‡10ï¼šæ¨¡æ¿æ–¹æ³•æ¨¡å¼æ€»ç»“ â­

**ä¸€å¥è¯ï¼š** å›ºå®šéª¨æ¶ + å¯å˜æ­¥éª¤ = ä¸€è‡´æ€§ + çµæ´»æ€§ã€‚

**æ ¸å¿ƒè¦ç‚¹ï¼š**
1. æ¨¡æ¿æ–¹æ³•å®šä¹‰ç®—æ³•éª¨æ¶
2. æŠ½è±¡æ–¹æ³•æ˜¯å¿…é¡»å®ç°çš„æ­¥éª¤
3. é’©å­æ–¹æ³•æ˜¯å¯é€‰çš„æ‰©å±•ç‚¹
4. æ§åˆ¶åè½¬ï¼šçˆ¶ç±»è°ƒç”¨å­ç±»
5. LangChain æ ¸å¿ƒç»„ä»¶éƒ½ç”¨è¿™ä¸ªæ¨¡å¼

**è®°ä½ï¼š** çœ‹åˆ° `invoke() â†’ _call()/_generate()` çš„ç»“æ„ï¼Œå°±æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**æ¨¡æ¿æ–¹æ³•æ¨¡å¼é€šè¿‡åœ¨æŠ½è±¡ç±»ä¸­å®šä¹‰ç®—æ³•éª¨æ¶ã€å°†å…·ä½“æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»å®ç°ï¼Œå®ç°äº†"æ§åˆ¶åè½¬"ï¼Œæ˜¯ LangChain ä¸­ BaseChatModelã€BaseRetrieverã€BaseLoader ç­‰æ ¸å¿ƒç»„ä»¶çš„æ¶æ„åŸºç¡€ï¼Œä½¿å¾—æ¡†æ¶èƒ½å¤Ÿç»Ÿä¸€ç®¡ç†ä¸åŒ LLM çš„è°ƒç”¨æµç¨‹ã€‚**

---

## ğŸ“š å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³ï¼ˆæ§åˆ¶åè½¬ï¼‰
- [ ] èƒ½åŒºåˆ†æ¨¡æ¿æ–¹æ³•ã€æŠ½è±¡æ–¹æ³•ã€é’©å­æ–¹æ³•
- [ ] èƒ½å¤Ÿå®šä¹‰åŒ…å«æ¨¡æ¿æ–¹æ³•çš„æŠ½è±¡åŸºç±»
- [ ] èƒ½å¤Ÿå®ç°å…·ä½“å­ç±»ï¼Œæ­£ç¡®è¦†ç›–æŠ½è±¡æ–¹æ³•
- [ ] ç†è§£é’©å­æ–¹æ³•çš„ä½œç”¨å’Œä½¿ç”¨åœºæ™¯
- [ ] èƒ½å¤Ÿè¯†åˆ« LangChain æºç ä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼
- [ ] ç†è§£æ¨¡æ¿æ–¹æ³• vs ç­–ç•¥æ¨¡å¼çš„åŒºåˆ«
- [ ] èƒ½å¤Ÿä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼åˆ›å»ºè‡ªå®šä¹‰ LangChain ç»„ä»¶

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- **ç­–ç•¥æ¨¡å¼**ï¼šæ•´ä¸ªç®—æ³•å¯æ›¿æ¢çš„è®¾è®¡æ¨¡å¼
- **è´£ä»»é“¾æ¨¡å¼**ï¼šè¯·æ±‚å¤„ç†çš„é“¾å¼ä¼ é€’
- **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šLangChain Callback ç³»ç»Ÿçš„åŸºç¡€
- **æŠ½è±¡ç±»ä¸æ¥å£ï¼ˆABCæ¨¡å—ï¼‰**ï¼šPython å®ç°æ¨¡æ¿æ–¹æ³•çš„åŸºç¡€

---

**ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2025-12-12
