# ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

> åŸå­åŒ–çŸ¥è¯†ç‚¹ | è½¯ä»¶å·¥ç¨‹åŸºç¡€ | LangChain æºç å­¦ä¹ å‰ç½®çŸ¥è¯†

---

## 1. ã€30å­—æ ¸å¿ƒã€‘

**ç­–ç•¥æ¨¡å¼å°†ç®—æ³•å°è£…æˆç‹¬ç«‹çš„ç­–ç•¥ç±»ï¼Œé€šè¿‡ç»„åˆå®ç°è¿è¡Œæ—¶å¯åˆ‡æ¢ï¼Œæ˜¯ LangChain ä¸­ Chain ç»„åˆä¸åŒ LLM çš„æ ¸å¿ƒæœºåˆ¶ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### ç­–ç•¥æ¨¡å¼çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**ç­–ç•¥æ¨¡å¼ = ç®—æ³•å°è£… + è¿è¡Œæ—¶åˆ‡æ¢**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

- **ç®—æ³•å°è£…**ï¼šæŠŠæ¯ä¸ªç®—æ³•ç‹¬ç«‹å°è£…æˆä¸€ä¸ªç±»
- **è¿è¡Œæ—¶åˆ‡æ¢**ï¼šå¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€æ›´æ¢ç®—æ³•
- **ç»„åˆä¼˜äºç»§æ‰¿**ï¼šé€šè¿‡æŒæœ‰ç­–ç•¥å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç»§æ‰¿

#### 2. ä¸ºä»€ä¹ˆéœ€è¦ç­–ç•¥æ¨¡å¼ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•è®©ç®—æ³•å¯ä»¥è‡ªç”±æ›¿æ¢ï¼Œè€Œä¸å½±å“ä½¿ç”¨å®ƒçš„ä»£ç ï¼Ÿ**

```python
# æ²¡æœ‰ç­–ç•¥æ¨¡å¼ï¼šç”¨ if-else é€‰æ‹©ç®—æ³•
class TextProcessor:
    def process(self, text: str, format_type: str) -> str:
        if format_type == "uppercase":
            return text.upper()
        elif format_type == "lowercase":
            return text.lower()
        elif format_type == "capitalize":
            return text.capitalize()
        elif format_type == "reverse":
            return text[::-1]
        else:
            raise ValueError(f"Unknown format: {format_type}")

# é—®é¢˜ï¼š
# 1. æ¯æ¬¡æ–°å¢æ ¼å¼ï¼Œéƒ½è¦ä¿®æ”¹è¿™ä¸ªç±»
# 2. if-else è¶Šæ¥è¶Šé•¿ï¼Œéš¾ä»¥ç»´æŠ¤
# 3. è¿åå¼€é—­åŸåˆ™ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰
# 4. ç®—æ³•é€»è¾‘å’Œé€‰æ‹©é€»è¾‘æ··åœ¨ä¸€èµ·
```

```python
# ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼šç®—æ³•ç‹¬ç«‹ï¼Œå¯è‡ªç”±åˆ‡æ¢
from abc import ABC, abstractmethod

# ç­–ç•¥æ¥å£
class FormatStrategy(ABC):
    @abstractmethod
    def format(self, text: str) -> str:
        pass

# å…·ä½“ç­–ç•¥
class UppercaseStrategy(FormatStrategy):
    def format(self, text: str) -> str:
        return text.upper()

class LowercaseStrategy(FormatStrategy):
    def format(self, text: str) -> str:
        return text.lower()

class ReverseStrategy(FormatStrategy):
    def format(self, text: str) -> str:
        return text[::-1]

# ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨ç­–ç•¥çš„ç±»ï¼‰
class TextProcessor:
    def __init__(self, strategy: FormatStrategy):
        self._strategy = strategy

    @property
    def strategy(self) -> FormatStrategy:
        return self._strategy

    @strategy.setter
    def strategy(self, strategy: FormatStrategy):
        self._strategy = strategy  # è¿è¡Œæ—¶åˆ‡æ¢ï¼

    def process(self, text: str) -> str:
        return self._strategy.format(text)  # å§”æ‰˜ç»™ç­–ç•¥

# ä½¿ç”¨
processor = TextProcessor(UppercaseStrategy())
print(processor.process("hello"))  # HELLO

processor.strategy = LowercaseStrategy()  # è¿è¡Œæ—¶åˆ‡æ¢
print(processor.process("HELLO"))  # hello

# ä¼˜åŠ¿ï¼š
# 1. æ–°å¢ç®—æ³•åªéœ€æ–°å¢ç­–ç•¥ç±»ï¼Œä¸æ”¹å·²æœ‰ä»£ç 
# 2. ç®—æ³•å¯ä»¥ç‹¬ç«‹æµ‹è¯•
# 3. ç®—æ³•å¯ä»¥è¿è¡Œæ—¶åˆ‡æ¢
# 4. éµå¾ªå¼€é—­åŸåˆ™
```

#### 3. ç­–ç•¥æ¨¡å¼çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šè§£è€¦ - ç®—æ³•ä¸ä½¿ç”¨è€…åˆ†ç¦»

```python
# ä½¿ç”¨è€…ä¸å…³å¿ƒå…·ä½“ç”¨å“ªä¸ªç®—æ³•
# åªå…³å¿ƒ"æœ‰ä¸€ä¸ªå¯ä»¥å¤„ç†çš„ç­–ç•¥"
def process_batch(texts: list, strategy: FormatStrategy) -> list:
    return [strategy.format(text) for text in texts]

# å¯ä»¥ä¼ å…¥ä»»ä½•ç­–ç•¥
process_batch(["a", "b"], UppercaseStrategy())
process_batch(["a", "b"], LowercaseStrategy())
```

##### ä»·å€¼2ï¼šçµæ´»æ€§ - è¿è¡Œæ—¶åˆ‡æ¢ç®—æ³•

```python
# æ ¹æ®é…ç½®åŠ¨æ€é€‰æ‹©ç­–ç•¥
config = {"format": "uppercase"}
strategies = {
    "uppercase": UppercaseStrategy(),
    "lowercase": LowercaseStrategy(),
}
current_strategy = strategies[config["format"]]

# å¯ä»¥éšæ—¶åˆ‡æ¢
config["format"] = "lowercase"
current_strategy = strategies[config["format"]]
```

##### ä»·å€¼3ï¼šæ‰©å±•æ€§ - æ–°å¢ç®—æ³•ä¸æ”¹å·²æœ‰ä»£ç 

```python
# æ–°å¢ä¸€ä¸ªç­–ç•¥ï¼Œå®Œå…¨ä¸å½±å“ TextProcessor
class TitleCaseStrategy(FormatStrategy):
    def format(self, text: str) -> str:
        return text.title()

# ç›´æ¥ä½¿ç”¨
processor.strategy = TitleCaseStrategy()
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ LangChain æºç åº”ç”¨

**æ¨ç†é“¾ï¼š**

```
1. LLM åº”ç”¨æ¡†æ¶éœ€è¦æ”¯æŒå¤šç§æ¨¡å‹ï¼ˆOpenAIã€Anthropicã€æœ¬åœ°æ¨¡å‹...ï¼‰
   â†“
2. ä¸åŒæ¨¡å‹å°±æ˜¯ä¸åŒçš„"ç®—æ³•"ï¼ˆä¸åŒçš„ API è°ƒç”¨æ–¹å¼ï¼‰
   â†“
3. ç”¨æˆ·å¸Œæœ›å¯ä»¥è‡ªç”±åˆ‡æ¢æ¨¡å‹ï¼Œç”šè‡³åœ¨è¿è¡Œæ—¶åˆ‡æ¢
   â†“
4. ç­–ç•¥æ¨¡å¼å®Œç¾åŒ¹é…è¿™ä¸ªéœ€æ±‚
   â†“
5. å®šä¹‰ç»Ÿä¸€çš„ Runnable æ¥å£ï¼ˆç­–ç•¥æ¥å£ï¼‰
   â†“
6. æ¯ä¸ª LLM å®ç° Runnable æ¥å£ï¼ˆå…·ä½“ç­–ç•¥ï¼‰
   â†“
7. Chain æŒæœ‰ LLM å¼•ç”¨ï¼ˆä¸Šä¸‹æ–‡ï¼‰
   â†“
8. ç”¨æˆ·å¯ä»¥ä¼ å…¥ä¸åŒçš„ LLMï¼Œæˆ–è¿è¡Œæ—¶åˆ‡æ¢
```

```python
# LangChain ä¸­çš„ç­–ç•¥æ¨¡å¼åº”ç”¨
from langchain_core.runnables import Runnable

# ç­–ç•¥æ¥å£
class Runnable(ABC):
    @abstractmethod
    def invoke(self, input): pass

# å…·ä½“ç­–ç•¥ï¼šä¸åŒçš„ LLM
class ChatOpenAI(Runnable):
    def invoke(self, input):
        return self.client.chat(input)

class ChatAnthropic(Runnable):
    def invoke(self, input):
        return self.client.messages(input)

# ä¸Šä¸‹æ–‡ï¼šChain ä½¿ç”¨ç­–ç•¥
class Chain:
    def __init__(self, llm: Runnable):
        self.llm = llm  # æŒæœ‰ç­–ç•¥

    def run(self, input):
        return self.llm.invoke(input)  # å§”æ‰˜ç»™ç­–ç•¥

# è¿è¡Œæ—¶åˆ‡æ¢
chain = Chain(llm=ChatOpenAI())
chain.llm = ChatAnthropic()  # æ¢ä¸€ä¸ªç­–ç•¥ï¼
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**ç­–ç•¥æ¨¡å¼é€šè¿‡"å°è£…ç®—æ³•+ç»„åˆä½¿ç”¨"çš„æ–¹å¼ï¼Œå®ç°äº†ç®—æ³•çš„è¿è¡Œæ—¶å¯åˆ‡æ¢ï¼Œæ˜¯ LangChain å®ç° LLM å¯æ’æ‹”æ¶æ„çš„æ ¸å¿ƒè®¾è®¡ã€‚**

---

## 3. ã€æ ¸å¿ƒæ¦‚å¿µï¼ˆå…¨é¢è¦†ç›–ï¼‰ã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šStrategy ç­–ç•¥æ¥å£ ğŸ“‹

**ç­–ç•¥æ¥å£å®šä¹‰äº†ç®—æ³•æ—çš„å…¬å…±å¥‘çº¦ï¼Œæ‰€æœ‰å…·ä½“ç­–ç•¥éƒ½å¿…é¡»å®ç°è¿™ä¸ªæ¥å£**

```python
from abc import ABC, abstractmethod
from typing import Any, Dict, List

# ===== ç­–ç•¥æ¥å£ï¼šå®šä¹‰ç®—æ³•å¥‘çº¦ =====
class LLMStrategy(ABC):
    """
    LLM ç­–ç•¥æ¥å£ - ç±»ä¼¼ LangChain çš„ Runnable

    å®šä¹‰äº†æ‰€æœ‰ LLM å¿…é¡»å®ç°çš„æ–¹æ³•
    """

    @abstractmethod
    def invoke(self, prompt: str) -> str:
        """åŒæ­¥è°ƒç”¨"""
        pass

    @abstractmethod
    def stream(self, prompt: str):
        """æµå¼è°ƒç”¨"""
        pass

    @property
    @abstractmethod
    def model_name(self) -> str:
        """æ¨¡å‹åç§°"""
        pass

# ===== å¦ä¸€ä¸ªç­–ç•¥æ¥å£ï¼šè¾“å‡ºè§£æå™¨ =====
class OutputParserStrategy(ABC):
    """
    è¾“å‡ºè§£æç­–ç•¥æ¥å£ - ç±»ä¼¼ LangChain çš„ BaseOutputParser
    """

    @abstractmethod
    def parse(self, text: str) -> Any:
        """è§£æ LLM è¾“å‡º"""
        pass

    @abstractmethod
    def get_format_instructions(self) -> str:
        """è¿”å›æ ¼å¼è¯´æ˜"""
        pass

# ===== æ£€ç´¢ç­–ç•¥æ¥å£ =====
class RetrieverStrategy(ABC):
    """
    æ£€ç´¢ç­–ç•¥æ¥å£ - ç±»ä¼¼ LangChain çš„ BaseRetriever
    """

    @abstractmethod
    def retrieve(self, query: str) -> List[Dict[str, Any]]:
        """æ£€ç´¢ç›¸å…³æ–‡æ¡£"""
        pass
```

**ç­–ç•¥æ¥å£çš„è®¾è®¡åŸåˆ™ï¼š**

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| å•ä¸€èŒè´£ | æ¥å£åªå®šä¹‰ä¸€ç±»ç®—æ³• | `LLMStrategy` åªå¤„ç† LLM è°ƒç”¨ |
| æœ€å°æ¥å£ | åªåŒ…å«å¿…éœ€çš„æ–¹æ³• | `invoke()` æ˜¯æ ¸å¿ƒï¼Œå…¶ä»–å¯é€‰ |
| æŠ½è±¡ç¨³å®š | æ¥å£ä¸€æ—¦å®šä¹‰ï¼Œå°½é‡ä¸æ”¹ | æ–°å¢æ–¹æ³•ç”¨æ–°æ¥å£æˆ–é»˜è®¤å®ç° |

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# langchain_core/runnables/base.py ç®€åŒ–ç‰ˆ
class Runnable(ABC):
    """æ‰€æœ‰å¯è¿è¡Œç»„ä»¶çš„ç­–ç•¥æ¥å£"""

    @abstractmethod
    def invoke(self, input: Any, config: Optional[RunnableConfig] = None) -> Any:
        """æ ¸å¿ƒæ–¹æ³•ï¼šåŒæ­¥è°ƒç”¨"""
        pass

    def stream(self, input: Any, config: Optional[RunnableConfig] = None):
        """å¯é€‰æ–¹æ³•ï¼šæµå¼è°ƒç”¨ï¼ˆæœ‰é»˜è®¤å®ç°ï¼‰"""
        yield self.invoke(input, config)

    def batch(self, inputs: List[Any], config: Optional[RunnableConfig] = None) -> List[Any]:
        """å¯é€‰æ–¹æ³•ï¼šæ‰¹é‡è°ƒç”¨ï¼ˆæœ‰é»˜è®¤å®ç°ï¼‰"""
        return [self.invoke(input, config) for input in inputs]
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šConcrete Strategy å…·ä½“ç­–ç•¥ ğŸ”§

**å…·ä½“ç­–ç•¥å®ç°ç­–ç•¥æ¥å£ï¼Œå°è£…å…·ä½“çš„ç®—æ³•å®ç°**

```python
from typing import Generator
import time

# ===== å…·ä½“ç­–ç•¥1ï¼šOpenAI LLM =====
class OpenAIStrategy(LLMStrategy):
    """OpenAI ç­–ç•¥å®ç°"""

    def __init__(self, model: str = "gpt-4", temperature: float = 0.7):
        self._model = model
        self.temperature = temperature

    @property
    def model_name(self) -> str:
        return self._model

    def invoke(self, prompt: str) -> str:
        # æ¨¡æ‹Ÿ API è°ƒç”¨
        time.sleep(0.1)
        return f"[OpenAI {self._model}] Response to: {prompt}"

    def stream(self, prompt: str) -> Generator[str, None, None]:
        response = f"[OpenAI {self._model}] Streaming: {prompt}"
        for char in response:
            time.sleep(0.01)
            yield char

# ===== å…·ä½“ç­–ç•¥2ï¼šAnthropic LLM =====
class AnthropicStrategy(LLMStrategy):
    """Anthropic Claude ç­–ç•¥å®ç°"""

    def __init__(self, model: str = "claude-3-opus"):
        self._model = model

    @property
    def model_name(self) -> str:
        return self._model

    def invoke(self, prompt: str) -> str:
        time.sleep(0.1)
        return f"[Claude {self._model}] Response to: {prompt}"

    def stream(self, prompt: str) -> Generator[str, None, None]:
        response = f"[Claude {self._model}] Streaming: {prompt}"
        for word in response.split():
            time.sleep(0.02)
            yield word + " "

# ===== å…·ä½“ç­–ç•¥3ï¼šæœ¬åœ° LLM =====
class LocalLLMStrategy(LLMStrategy):
    """æœ¬åœ°æ¨¡å‹ç­–ç•¥å®ç°"""

    def __init__(self, model_path: str = "/models/llama"):
        self._model_path = model_path
        self._model = model_path.split("/")[-1]

    @property
    def model_name(self) -> str:
        return f"local:{self._model}"

    def invoke(self, prompt: str) -> str:
        # æœ¬åœ°æ¨ç†ï¼ˆæ¨¡æ‹Ÿï¼‰
        return f"[Local {self._model}] Response to: {prompt}"

    def stream(self, prompt: str) -> Generator[str, None, None]:
        response = f"[Local {self._model}] {prompt}"
        for char in response:
            yield char

# ===== è¾“å‡ºè§£æå™¨çš„å…·ä½“ç­–ç•¥ =====
import json
from typing import Dict

class JSONOutputParser(OutputParserStrategy):
    """JSON è¾“å‡ºè§£æç­–ç•¥"""

    def parse(self, text: str) -> Dict:
        # å°è¯•æå– JSON
        try:
            # æŸ¥æ‰¾ JSON å—
            start = text.find("{")
            end = text.rfind("}") + 1
            if start != -1 and end > start:
                return json.loads(text[start:end])
        except json.JSONDecodeError:
            pass
        return {"raw": text}

    def get_format_instructions(self) -> str:
        return "Please respond with valid JSON format."

class ListOutputParser(OutputParserStrategy):
    """åˆ—è¡¨è¾“å‡ºè§£æç­–ç•¥"""

    def parse(self, text: str) -> List[str]:
        # æŒ‰è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤ç©ºè¡Œ
        lines = [line.strip() for line in text.split("\n")]
        return [line for line in lines if line]

    def get_format_instructions(self) -> str:
        return "Please respond with a list, one item per line."
```

**å…·ä½“ç­–ç•¥çš„ç‰¹ç‚¹ï¼š**

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| å°è£…ç‹¬ç«‹ | æ¯ä¸ªç­–ç•¥æ˜¯ç‹¬ç«‹çš„ç±»ï¼Œå¯å•ç‹¬æµ‹è¯• |
| å®ç°æ¥å£ | å¿…é¡»å®ç°ç­–ç•¥æ¥å£çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³• |
| å¯æ›¿æ¢ | ä»»ä½•å®ç°äº†æ¥å£çš„ç±»éƒ½å¯ä»¥ä½œä¸ºç­–ç•¥ä½¿ç”¨ |
| æ— çŠ¶æ€æˆ–æœ‰çŠ¶æ€ | ç­–ç•¥å¯ä»¥æœ‰è‡ªå·±çš„é…ç½®å’ŒçŠ¶æ€ |

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# langchain_openai/chat_models.py ç®€åŒ–ç‰ˆ
class ChatOpenAI(BaseChatModel):  # BaseChatModel å®ç°äº† Runnable
    """OpenAI å…·ä½“ç­–ç•¥"""

    model_name: str = "gpt-3.5-turbo"
    temperature: float = 0.7

    def _generate(self, messages, **kwargs):
        # è°ƒç”¨ OpenAI API
        response = self.client.chat.completions.create(
            model=self.model_name,
            messages=[m.to_dict() for m in messages],
        )
        return response

# langchain_anthropic/chat_models.py ç®€åŒ–ç‰ˆ
class ChatAnthropic(BaseChatModel):
    """Anthropic å…·ä½“ç­–ç•¥"""

    model: str = "claude-3-opus"

    def _generate(self, messages, **kwargs):
        # è°ƒç”¨ Anthropic API
        response = self.client.messages.create(
            model=self.model,
            messages=messages,
        )
        return response
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šContext ä¸Šä¸‹æ–‡ ğŸ®

**ä¸Šä¸‹æ–‡ç±»æŒæœ‰ç­–ç•¥çš„å¼•ç”¨ï¼Œå°†å·¥ä½œå§”æ‰˜ç»™ç­–ç•¥å¯¹è±¡æ‰§è¡Œ**

```python
from typing import Optional, List, Any

class ChatBot:
    """
    èŠå¤©æœºå™¨äºº - ä¸Šä¸‹æ–‡ç±»

    æŒæœ‰ LLM ç­–ç•¥çš„å¼•ç”¨ï¼Œå¯ä»¥è¿è¡Œæ—¶åˆ‡æ¢
    """

    def __init__(self, llm: LLMStrategy, parser: Optional[OutputParserStrategy] = None):
        self._llm = llm
        self._parser = parser
        self._history: List[str] = []

    # ===== ç­–ç•¥çš„ getter/setter =====

    @property
    def llm(self) -> LLMStrategy:
        """å½“å‰ä½¿ç”¨çš„ LLM ç­–ç•¥"""
        return self._llm

    @llm.setter
    def llm(self, strategy: LLMStrategy):
        """è¿è¡Œæ—¶åˆ‡æ¢ LLM ç­–ç•¥"""
        print(f"Switching LLM from {self._llm.model_name} to {strategy.model_name}")
        self._llm = strategy

    @property
    def parser(self) -> Optional[OutputParserStrategy]:
        return self._parser

    @parser.setter
    def parser(self, strategy: OutputParserStrategy):
        self._parser = strategy

    # ===== ä¸šåŠ¡æ–¹æ³•ï¼šå§”æ‰˜ç»™ç­–ç•¥ =====

    def chat(self, message: str) -> str:
        """
        èŠå¤©æ–¹æ³•

        å°†å®é™…çš„ LLM è°ƒç”¨å§”æ‰˜ç»™ç­–ç•¥
        """
        # 1. æ„å»º promptï¼ˆä¸Šä¸‹æ–‡çš„èŒè´£ï¼‰
        prompt = self._build_prompt(message)

        # 2. è°ƒç”¨ LLMï¼ˆå§”æ‰˜ç»™ç­–ç•¥ï¼‰
        response = self._llm.invoke(prompt)

        # 3. è§£æè¾“å‡ºï¼ˆå¦‚æœæœ‰è§£æå™¨ç­–ç•¥ï¼‰
        if self._parser:
            response = str(self._parser.parse(response))

        # 4. æ›´æ–°å†å²ï¼ˆä¸Šä¸‹æ–‡çš„èŒè´£ï¼‰
        self._history.append(f"User: {message}")
        self._history.append(f"Assistant: {response}")

        return response

    def stream_chat(self, message: str):
        """æµå¼èŠå¤©"""
        prompt = self._build_prompt(message)
        for chunk in self._llm.stream(prompt):
            yield chunk

    def _build_prompt(self, message: str) -> str:
        """æ„å»º promptï¼ˆåŒ…å«å†å²ï¼‰"""
        history_text = "\n".join(self._history[-10:])  # ä¿ç•™æœ€è¿‘10æ¡
        return f"{history_text}\nUser: {message}\nAssistant:"

    def clear_history(self):
        """æ¸…é™¤å¯¹è¯å†å²"""
        self._history = []

# ===== ä½¿ç”¨ä¸Šä¸‹æ–‡ =====
print("=== åˆ›å»º ChatBot ===")
bot = ChatBot(llm=OpenAIStrategy())
print(bot.chat("Hello!"))

print("\n=== åˆ‡æ¢åˆ° Claude ===")
bot.llm = AnthropicStrategy()  # è¿è¡Œæ—¶åˆ‡æ¢ï¼
print(bot.chat("Hello again!"))

print("\n=== æ·»åŠ  JSON è§£æå™¨ ===")
bot.parser = JSONOutputParser()
print(bot.chat("Give me JSON"))
```

**ä¸Šä¸‹æ–‡çš„èŒè´£ï¼š**

| èŒè´£ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| æŒæœ‰ç­–ç•¥ | ä¿å­˜å½“å‰ä½¿ç”¨çš„ç­–ç•¥å¼•ç”¨ | `self._llm` |
| å§”æ‰˜è°ƒç”¨ | å°†å…·ä½“å·¥ä½œäº¤ç»™ç­–ç•¥ | `self._llm.invoke(prompt)` |
| æä¾›åˆ‡æ¢ | å…è®¸è¿è¡Œæ—¶æ›´æ¢ç­–ç•¥ | `@llm.setter` |
| ä¸Šä¸‹æ–‡é€»è¾‘ | å¤„ç†ç­–ç•¥æ— å…³çš„ä¸šåŠ¡é€»è¾‘ | å†å²è®°å½•ã€prompt æ„å»º |

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# langchain_core/runnables/base.py ç®€åŒ–ç‰ˆ
class RunnableSequence(Runnable):
    """
    é“¾å¼ç»„åˆ - ä¸Šä¸‹æ–‡

    æŒæœ‰å¤šä¸ª Runnable ç­–ç•¥ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ
    """

    def __init__(self, first: Runnable, *middle: Runnable, last: Runnable):
        self.first = first      # ç­–ç•¥1
        self.middle = middle    # ç­–ç•¥2, 3, ...
        self.last = last        # æœ€åä¸€ä¸ªç­–ç•¥

    def invoke(self, input: Any) -> Any:
        # å§”æ‰˜ç»™å„ä¸ªç­–ç•¥
        result = self.first.invoke(input)
        for step in self.middle:
            result = step.invoke(result)
        return self.last.invoke(result)

# ä½¿ç”¨ LCEL æ„å»ºé“¾
chain = prompt | llm | parser  # ç»„åˆå¤šä¸ªç­–ç•¥
chain.invoke({"question": "Hello"})  # ä¾æ¬¡è°ƒç”¨
```

---

### æ‰©å±•æ¦‚å¿µ4ï¼šç­–ç•¥å·¥å‚ä¸æ³¨å†Œè¡¨ ğŸ­

**ç­–ç•¥å·¥å‚ç”¨äºæ ¹æ®é…ç½®åˆ›å»ºç­–ç•¥å®ä¾‹ï¼Œç­–ç•¥æ³¨å†Œè¡¨ç”¨äºç®¡ç†å¯ç”¨çš„ç­–ç•¥**

```python
from typing import Dict, Type, Callable

# ===== ç­–ç•¥æ³¨å†Œè¡¨ =====
class LLMRegistry:
    """
    LLM ç­–ç•¥æ³¨å†Œè¡¨

    ç®¡ç†æ‰€æœ‰å¯ç”¨çš„ LLM ç­–ç•¥
    """

    _strategies: Dict[str, Type[LLMStrategy]] = {}

    @classmethod
    def register(cls, name: str):
        """è£…é¥°å™¨ï¼šæ³¨å†Œç­–ç•¥"""
        def decorator(strategy_class: Type[LLMStrategy]):
            cls._strategies[name] = strategy_class
            return strategy_class
        return decorator

    @classmethod
    def get(cls, name: str) -> Type[LLMStrategy]:
        """è·å–ç­–ç•¥ç±»"""
        if name not in cls._strategies:
            raise ValueError(f"Unknown LLM: {name}. Available: {list(cls._strategies.keys())}")
        return cls._strategies[name]

    @classmethod
    def create(cls, name: str, **kwargs) -> LLMStrategy:
        """åˆ›å»ºç­–ç•¥å®ä¾‹"""
        strategy_class = cls.get(name)
        return strategy_class(**kwargs)

    @classmethod
    def list_available(cls) -> List[str]:
        """åˆ—å‡ºæ‰€æœ‰å¯ç”¨ç­–ç•¥"""
        return list(cls._strategies.keys())

# ===== ä½¿ç”¨è£…é¥°å™¨æ³¨å†Œç­–ç•¥ =====
@LLMRegistry.register("openai")
class RegisteredOpenAI(OpenAIStrategy):
    pass

@LLMRegistry.register("anthropic")
class RegisteredAnthropic(AnthropicStrategy):
    pass

@LLMRegistry.register("local")
class RegisteredLocal(LocalLLMStrategy):
    pass

# ===== ç­–ç•¥å·¥å‚ =====
class LLMFactory:
    """
    LLM ç­–ç•¥å·¥å‚

    æ ¹æ®é…ç½®åˆ›å»ºåˆé€‚çš„ç­–ç•¥
    """

    @staticmethod
    def create_from_config(config: Dict[str, Any]) -> LLMStrategy:
        """æ ¹æ®é…ç½®åˆ›å»º LLM"""
        provider = config.get("provider", "openai")
        model = config.get("model")
        temperature = config.get("temperature", 0.7)

        if provider == "openai":
            return OpenAIStrategy(model=model or "gpt-4", temperature=temperature)
        elif provider == "anthropic":
            return AnthropicStrategy(model=model or "claude-3-opus")
        elif provider == "local":
            return LocalLLMStrategy(model_path=config.get("model_path", "/models/llama"))
        else:
            # å°è¯•ä»æ³¨å†Œè¡¨è·å–
            return LLMRegistry.create(provider, **(config.get("params", {})))

    @staticmethod
    def create_from_env() -> LLMStrategy:
        """ä»ç¯å¢ƒå˜é‡åˆ›å»º LLM"""
        import os
        provider = os.getenv("LLM_PROVIDER", "openai")
        model = os.getenv("LLM_MODEL")
        return LLMFactory.create_from_config({
            "provider": provider,
            "model": model,
        })

# ===== ä½¿ç”¨å·¥å‚å’Œæ³¨å†Œè¡¨ =====
print("=== ä½¿ç”¨æ³¨å†Œè¡¨ ===")
print(f"å¯ç”¨ç­–ç•¥: {LLMRegistry.list_available()}")

llm1 = LLMRegistry.create("openai", model="gpt-4")
print(f"åˆ›å»º: {llm1.model_name}")

print("\n=== ä½¿ç”¨å·¥å‚ ===")
config = {
    "provider": "anthropic",
    "model": "claude-3-sonnet"
}
llm2 = LLMFactory.create_from_config(config)
print(f"åˆ›å»º: {llm2.model_name}")
```

**åœ¨ LangChain æºç ä¸­çš„åº”ç”¨ï¼š**

```python
# langchain/llms/__init__.py ç®€åŒ–ç‰ˆ
def get_llm(llm_name: str, **kwargs) -> BaseLLM:
    """æ ¹æ®åç§°è·å– LLM"""
    if llm_name == "openai":
        from langchain_openai import ChatOpenAI
        return ChatOpenAI(**kwargs)
    elif llm_name == "anthropic":
        from langchain_anthropic import ChatAnthropic
        return ChatAnthropic(**kwargs)
    # ... æ›´å¤š LLM
```

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½ç†è§£å’Œä½¿ç”¨ LangChain ä¸­çš„ç­–ç•¥æ¨¡å¼ï¼š

### 4.1 å®šä¹‰ç­–ç•¥æ¥å£

```python
from abc import ABC, abstractmethod

class Strategy(ABC):
    """ç­–ç•¥æ¥å£ï¼šå®šä¹‰ç®—æ³•çš„å…¬å…±æ–¹æ³•"""

    @abstractmethod
    def execute(self, data):
        """æ‰§è¡Œç®—æ³•"""
        pass
```

### 4.2 å®ç°å…·ä½“ç­–ç•¥

```python
class ConcreteStrategyA(Strategy):
    """å…·ä½“ç­–ç•¥A"""
    def execute(self, data):
        return f"ç­–ç•¥Aå¤„ç†: {data}"

class ConcreteStrategyB(Strategy):
    """å…·ä½“ç­–ç•¥B"""
    def execute(self, data):
        return f"ç­–ç•¥Bå¤„ç†: {data}"
```

### 4.3 åˆ›å»ºä¸Šä¸‹æ–‡ç±»

```python
class Context:
    """ä¸Šä¸‹æ–‡ï¼šä½¿ç”¨ç­–ç•¥"""

    def __init__(self, strategy: Strategy):
        self._strategy = strategy

    @property
    def strategy(self) -> Strategy:
        return self._strategy

    @strategy.setter
    def strategy(self, strategy: Strategy):
        self._strategy = strategy  # å…è®¸è¿è¡Œæ—¶åˆ‡æ¢

    def do_work(self, data):
        return self._strategy.execute(data)  # å§”æ‰˜ç»™ç­–ç•¥
```

### 4.4 è¿è¡Œæ—¶åˆ‡æ¢ç­–ç•¥

```python
# åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œåˆå§‹ä½¿ç”¨ç­–ç•¥A
context = Context(ConcreteStrategyA())
print(context.do_work("test"))  # ç­–ç•¥Aå¤„ç†: test

# è¿è¡Œæ—¶åˆ‡æ¢åˆ°ç­–ç•¥B
context.strategy = ConcreteStrategyB()
print(context.do_work("test"))  # ç­–ç•¥Bå¤„ç†: test
```

### 4.5 åœ¨ LangChain ä¸­çš„åº”ç”¨

```python
# LangChain çš„ Chain å°±æ˜¯ä¸Šä¸‹æ–‡ï¼ŒLLM å°±æ˜¯ç­–ç•¥
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
from langchain_anthropic import ChatAnthropic

# åˆ›å»º promptï¼ˆå›ºå®šä¸å˜ï¼‰
prompt = ChatPromptTemplate.from_template("Tell me about {topic}")

# åˆ›å»ºä¸åŒçš„ LLM ç­–ç•¥
openai_llm = ChatOpenAI(model="gpt-4")
claude_llm = ChatAnthropic(model="claude-3-opus")

# ç»„åˆæˆ Chainï¼ˆä¸Šä¸‹æ–‡ï¼‰
chain_openai = prompt | openai_llm
chain_claude = prompt | claude_llm

# ä½¿ç”¨ä¸åŒçš„ç­–ç•¥
chain_openai.invoke({"topic": "Python"})
chain_claude.invoke({"topic": "Python"})

# ä¹Ÿå¯ä»¥åŠ¨æ€åˆ‡æ¢
def create_chain(llm):
    return prompt | llm

chain = create_chain(openai_llm)
chain = create_chain(claude_llm)  # åˆ‡æ¢ç­–ç•¥
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£ LangChain ä¸­ Runnable ä½œä¸ºç­–ç•¥æ¥å£çš„è®¾è®¡
- ç†è§£ Chain å¦‚ä½•ç»„åˆä¸åŒçš„ LLM
- åˆ›å»ºè‡ªå®šä¹‰çš„ç­–ç•¥å¹¶åœ¨ Chain ä¸­ä½¿ç”¨
- å®ç°è¿è¡Œæ—¶åˆ‡æ¢ LLM çš„åŠŸèƒ½

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘ï¼ˆåŒè½¨åˆ¶ï¼‰

### ç±»æ¯”1ï¼šç­–ç•¥ = å¯æ›¿æ¢çš„ç®—æ³•

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šè¡¨å•éªŒè¯ç­–ç•¥

ç­–ç•¥æ¨¡å¼å°±åƒå‰ç«¯çš„è¡¨å•éªŒè¯å™¨ï¼Œå¯ä»¥æ ¹æ®éœ€è¦åˆ‡æ¢ä¸åŒçš„éªŒè¯è§„åˆ™ã€‚

```typescript
// ç­–ç•¥æ¥å£
interface ValidationStrategy {
  validate(value: string): boolean;
  getErrorMessage(): string;
}

// å…·ä½“ç­–ç•¥ï¼šé‚®ç®±éªŒè¯
class EmailValidation implements ValidationStrategy {
  validate(value: string): boolean {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  }
  getErrorMessage(): string {
    return "è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€";
  }
}

// å…·ä½“ç­–ç•¥ï¼šæ‰‹æœºå·éªŒè¯
class PhoneValidation implements ValidationStrategy {
  validate(value: string): boolean {
    return /^1[3-9]\d{9}$/.test(value);
  }
  getErrorMessage(): string {
    return "è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·";
  }
}

// ä¸Šä¸‹æ–‡ï¼šè¡¨å•å­—æ®µ
class FormField {
  private strategy: ValidationStrategy;

  constructor(strategy: ValidationStrategy) {
    this.strategy = strategy;
  }

  setValidation(strategy: ValidationStrategy) {
    this.strategy = strategy;  // è¿è¡Œæ—¶åˆ‡æ¢
  }

  validate(value: string): { valid: boolean; error?: string } {
    const valid = this.strategy.validate(value);
    return valid ? { valid } : { valid, error: this.strategy.getErrorMessage() };
  }
}

// ä½¿ç”¨
const field = new FormField(new EmailValidation());
field.validate("test@example.com");  // { valid: true }

field.setValidation(new PhoneValidation());  // åˆ‡æ¢ç­–ç•¥
field.validate("13800138000");  // { valid: true }
```

```python
# Python å¯¹åº”ï¼šLangChain çš„ OutputParser
from abc import ABC, abstractmethod

class OutputParser(ABC):
    @abstractmethod
    def parse(self, text: str): pass

class JSONParser(OutputParser):
    def parse(self, text: str):
        return json.loads(text)

class ListParser(OutputParser):
    def parse(self, text: str):
        return text.split("\n")

# ä½¿ç”¨
chain = prompt | llm | JSONParser()  # ä½¿ç”¨ JSON è§£æ
chain = prompt | llm | ListParser()  # åˆ‡æ¢ä¸ºåˆ—è¡¨è§£æ
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šå»å­¦æ ¡çš„äº¤é€šæ–¹å¼

ç­–ç•¥æ¨¡å¼å°±åƒä½ å»å­¦æ ¡å¯ä»¥é€‰æ‹©ä¸åŒçš„äº¤é€šæ–¹å¼ã€‚

**ç”Ÿæ´»ä¾‹å­ï¼š**
```
å»å­¦æ ¡ï¼ˆç›®æ ‡æ˜¯ä¸€æ ·çš„ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº¤é€šç­–ç•¥1ï¼šèµ°è·¯ ğŸš¶               â”‚
â”‚ - ç‰¹ç‚¹ï¼šæ…¢ä½†é”»ç‚¼èº«ä½“             â”‚
â”‚ - é€‚åˆï¼šå¤©æ°”å¥½ã€ä¸èµ¶æ—¶é—´         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº¤é€šç­–ç•¥2ï¼šéª‘è‡ªè¡Œè½¦ ğŸš²           â”‚
â”‚ - ç‰¹ç‚¹ï¼šå¿«ä¸€äº›ï¼Œæœ‰ç‚¹ç´¯           â”‚
â”‚ - é€‚åˆï¼šä¸­ç­‰è·ç¦»                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº¤é€šç­–ç•¥3ï¼šåå…¬äº¤è½¦ ğŸšŒ           â”‚
â”‚ - ç‰¹ç‚¹ï¼šä¸ç´¯ä½†è¦ç­‰è½¦             â”‚
â”‚ - é€‚åˆï¼šè·ç¦»è¿œã€ä¸‹é›¨å¤©           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº¤é€šç­–ç•¥4ï¼šçˆ¸å¦ˆå¼€è½¦é€ ğŸš—         â”‚
â”‚ - ç‰¹ç‚¹ï¼šæœ€å¿«æœ€èˆ’æœ               â”‚
â”‚ - é€‚åˆï¼šè¦è¿Ÿåˆ°äº†ï¼               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½ ï¼ˆä¸Šä¸‹æ–‡ï¼‰å¯ä»¥æ ¹æ®æƒ…å†µé€‰æ‹©ä¸åŒçš„ç­–ç•¥ï¼š
- ä»Šå¤©å¤©æ°”å¥½ â†’ é€‰æ‹©"èµ°è·¯"ç­–ç•¥
- å¿«è¿Ÿåˆ°äº† â†’ åˆ‡æ¢åˆ°"å¼€è½¦"ç­–ç•¥
- ä¸‹é›¨äº† â†’ åˆ‡æ¢åˆ°"å…¬äº¤"ç­–ç•¥

ç›®çš„åœ°ï¼ˆå»å­¦æ ¡ï¼‰ä¸å˜ï¼Œä½†äº¤é€šæ–¹å¼ï¼ˆç­–ç•¥ï¼‰å¯ä»¥è‡ªç”±åˆ‡æ¢ï¼
```

---

### ç±»æ¯”2ï¼šä¸Šä¸‹æ–‡ = ä½¿ç”¨ç­–ç•¥çš„äºº

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šReact çŠ¶æ€ç®¡ç†

ä¸Šä¸‹æ–‡å°±åƒ React ç»„ä»¶ï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„çŠ¶æ€ç®¡ç†ç­–ç•¥ã€‚

```typescript
// ç­–ç•¥æ¥å£
interface StateStrategy<T> {
  getState(): T;
  setState(newState: T): void;
  subscribe(listener: () => void): () => void;
}

// ç­–ç•¥1ï¼šuseState é£æ ¼
class LocalStateStrategy<T> implements StateStrategy<T> {
  private state: T;
  private listeners: Set<() => void> = new Set();

  constructor(initial: T) {
    this.state = initial;
  }

  getState() { return this.state; }

  setState(newState: T) {
    this.state = newState;
    this.listeners.forEach(l => l());
  }

  subscribe(listener: () => void) {
    this.listeners.add(listener);
    return () => this.listeners.delete(listener);
  }
}

// ç­–ç•¥2ï¼šRedux é£æ ¼
class ReduxStateStrategy<T> implements StateStrategy<T> {
  // ... ä½¿ç”¨ Redux store
}

// ç»„ä»¶ï¼ˆä¸Šä¸‹æ–‡ï¼‰
function MyComponent() {
  // å¯ä»¥åˆ‡æ¢çŠ¶æ€ç®¡ç†ç­–ç•¥
  const stateStrategy = useContext(StateContext);
  const state = stateStrategy.getState();
  // ...
}
```

```python
# Python å¯¹åº”ï¼šLangChain çš„ Memory
class ConversationMemory(ABC):
    @abstractmethod
    def load(self) -> List[Message]: pass

    @abstractmethod
    def save(self, message: Message): pass

class BufferMemory(ConversationMemory):
    """ä¿å­˜æ‰€æœ‰å¯¹è¯"""
    pass

class WindowMemory(ConversationMemory):
    """åªä¿å­˜æœ€è¿‘ N æ¡"""
    pass

class SummaryMemory(ConversationMemory):
    """ä¿å­˜å¯¹è¯æ‘˜è¦"""
    pass

# Chain å¯ä»¥ä½¿ç”¨ä¸åŒçš„ Memory ç­–ç•¥
chain = ConversationChain(memory=BufferMemory())
chain = ConversationChain(memory=SummaryMemory())  # åˆ‡æ¢
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šç”»ç”»çš„å·¥å…·

ä¸Šä¸‹æ–‡å°±åƒä½ ï¼ˆç”»ç”»çš„äººï¼‰ï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„ç”»ç”»å·¥å…·ï¼ˆç­–ç•¥ï¼‰ã€‚

**ç”Ÿæ´»ä¾‹å­ï¼š**
```
ç”»ä¸€å¹…ç”»ï¼ˆä½ æ˜¯ä¸Šä¸‹æ–‡ï¼‰

ä½ å¯ä»¥é€‰æ‹©ä¸åŒçš„å·¥å…·ï¼ˆç­–ç•¥ï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ–ï¸ èœ¡ç¬”ç­–ç•¥                      â”‚
â”‚ - é¢œè‰²é²œè‰³                       â”‚
â”‚ - é€‚åˆç”»å¡é€š                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¨ æ°´å½©ç­–ç•¥                      â”‚
â”‚ - å¯ä»¥è°ƒè‰²                       â”‚
â”‚ - é€‚åˆç”»é£æ™¯                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœï¸ é“…ç¬”ç­–ç•¥                      â”‚
â”‚ - å¯ä»¥æ“¦é™¤                       â”‚
â”‚ - é€‚åˆç”»ç´ æ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”»ç”»æ­¥éª¤ï¼ˆå›ºå®šæµç¨‹ï¼‰ï¼š
1. æƒ³å¥½ç”»ä»€ä¹ˆ â† ä½ çš„å·¥ä½œ
2. ç”¨å·¥å…·ç”»   â† å§”æ‰˜ç»™ç­–ç•¥
3. å®Œæˆä½œå“   â† ä½ çš„å·¥ä½œ

ä½ ï¼ˆä¸Šä¸‹æ–‡ï¼‰è´Ÿè´£å†³å®šç”»ä»€ä¹ˆ
å·¥å…·ï¼ˆç­–ç•¥ï¼‰è´Ÿè´£å…·ä½“æ€ä¹ˆç”»

æ¢ä¸ªå·¥å…·ï¼Œç”»æ³•å°±å˜äº†ï¼Œä½†ä½ è¿˜æ˜¯ä½ ï¼
```

---

### ç±»æ¯”3ï¼šç­–ç•¥ vs æ¨¡æ¿æ–¹æ³•

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šç»„åˆ vs ç»§æ‰¿

```typescript
// æ¨¡æ¿æ–¹æ³•ï¼šç»§æ‰¿ - å­ç±»å®ç°éƒ¨åˆ†æ­¥éª¤
class Component extends React.Component {
  render() {
    return this.renderContent();  // å­ç±»å®ç°
  }
  abstract renderContent(): JSX.Element;
}

// ç­–ç•¥æ¨¡å¼ï¼šç»„åˆ - å¯æ›¿æ¢çš„æ¸²æŸ“å™¨
interface Renderer {
  render(data: any): JSX.Element;
}

class ComponentWithStrategy {
  constructor(private renderer: Renderer) {}

  render(data: any) {
    return this.renderer.render(data);  // å§”æ‰˜
  }

  setRenderer(renderer: Renderer) {
    this.renderer = renderer;  // è¿è¡Œæ—¶åˆ‡æ¢ï¼
  }
}
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šç»§æ‰¿ vs å¸®æ‰‹

**ç”Ÿæ´»ä¾‹å­ï¼š**
```
æ¨¡æ¿æ–¹æ³•ï¼ˆç»§æ‰¿ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çˆ¸çˆ¸ï¼ˆæŠ½è±¡ç±»ï¼‰                   â”‚
â”‚ åšæ—©é¤æµç¨‹ï¼š                     â”‚
â”‚ 1. èµ·åºŠ âœ…                       â”‚
â”‚ 2. åšã€___ã€‘â† å­ç±»å†³å®š           â”‚
â”‚ 3. åƒé¥­ âœ…                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å„¿å­ç»§æ‰¿çˆ¸çˆ¸ï¼Œåªèƒ½åšä¸€ç§æ—©é¤      â”‚
â”‚ ä¸€æ—¦æ˜¯"ç…è›‹æ´¾"ï¼Œå°±ä¸èƒ½å˜æˆ"é¢åŒ…æ´¾"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç­–ç•¥æ¨¡å¼ï¼ˆç»„åˆï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½ ï¼ˆä¸Šä¸‹æ–‡ï¼‰                     â”‚
â”‚ åšæ—©é¤æµç¨‹ï¼š                     â”‚
â”‚ 1. èµ·åºŠ âœ…                       â”‚
â”‚ 2. è®©å¸®æ‰‹åšæ—©é¤ â† å¯ä»¥æ¢å¸®æ‰‹ï¼   â”‚
â”‚ 3. åƒé¥­ âœ…                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¸®æ‰‹1ï¼šç…è›‹æœºå™¨äºº                â”‚
â”‚ å¸®æ‰‹2ï¼šé¢åŒ…æœºå™¨äºº                â”‚
â”‚ å¸®æ‰‹3ï¼šä¸‰æ˜æ²»æœºå™¨äºº              â”‚
â”‚                                 â”‚
â”‚ ä»Šå¤©æƒ³åƒå•¥ï¼Ÿæ¢ä¸ªå¸®æ‰‹å°±è¡Œï¼       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¨¡æ¿æ–¹æ³•ï¼šä½ æ˜¯ä»€ä¹ˆäººï¼Œå°±åªèƒ½åšä»€ä¹ˆï¼ˆç»§æ‰¿å›ºå®šï¼‰
ç­–ç•¥æ¨¡å¼ï¼šä½ æ‰¾ä»€ä¹ˆå¸®æ‰‹ï¼Œå°±åšä»€ä¹ˆï¼ˆå¯ä»¥æ¢ï¼‰
```

---

### ç±»æ¯”4ï¼šè¿è¡Œæ—¶åˆ‡æ¢

#### ğŸ¨ å‰ç«¯è§†è§’ï¼šä¸»é¢˜åˆ‡æ¢

```typescript
// ä¸»é¢˜ç­–ç•¥
interface ThemeStrategy {
  primary: string;
  background: string;
  text: string;
}

const lightTheme: ThemeStrategy = {
  primary: "#007bff",
  background: "#ffffff",
  text: "#000000",
};

const darkTheme: ThemeStrategy = {
  primary: "#0d6efd",
  background: "#1a1a1a",
  text: "#ffffff",
};

// ä¸Šä¸‹æ–‡ï¼šApp
function App() {
  const [theme, setTheme] = useState<ThemeStrategy>(lightTheme);

  const toggleTheme = () => {
    setTheme(prev => prev === lightTheme ? darkTheme : lightTheme);
  };

  return (
    <div style={{ background: theme.background, color: theme.text }}>
      <button onClick={toggleTheme}>åˆ‡æ¢ä¸»é¢˜</button>
    </div>
  );
}
```

```python
# Python å¯¹åº”ï¼šLangChain è¿è¡Œæ—¶åˆ‡æ¢ LLM
class ChatService:
    def __init__(self, llm: LLMStrategy):
        self.llm = llm

    def chat(self, message: str) -> str:
        return self.llm.invoke(message)

    def switch_to_fast(self):
        self.llm = OpenAIStrategy(model="gpt-3.5-turbo")

    def switch_to_smart(self):
        self.llm = AnthropicStrategy(model="claude-3-opus")

# ä½¿ç”¨
service = ChatService(OpenAIStrategy())
service.chat("ç®€å•é—®é¢˜")  # ç”¨ OpenAI

service.switch_to_smart()  # åˆ‡æ¢ï¼
service.chat("å¤æ‚é—®é¢˜")  # ç”¨ Claude
```

#### ğŸ§’ å°æœ‹å‹è§†è§’ï¼šæ¸¸æˆéš¾åº¦

**ç”Ÿæ´»ä¾‹å­ï¼š**
```
ç©æ¸¸æˆï¼ˆä½ æ˜¯ç©å®¶/ä¸Šä¸‹æ–‡ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ® éš¾åº¦ç­–ç•¥å¯ä»¥éšæ—¶åˆ‡æ¢ï¼š        â”‚
â”‚                                 â”‚
â”‚ ç®€å•æ¨¡å¼ ğŸ˜Š                      â”‚
â”‚ - æ•Œäººå°‘                        â”‚
â”‚ - ä¼¤å®³ä½                        â”‚
â”‚ - è¡€é‡å¤š                        â”‚
â”‚                                 â”‚
â”‚ æ™®é€šæ¨¡å¼ ğŸ˜                      â”‚
â”‚ - æ ‡å‡†è®¾ç½®                      â”‚
â”‚                                 â”‚
â”‚ å›°éš¾æ¨¡å¼ ğŸ˜°                      â”‚
â”‚ - æ•Œäººå¤š                        â”‚
â”‚ - ä¼¤å®³é«˜                        â”‚
â”‚ - è¡€é‡å°‘                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç©ç€ç©ç€è§‰å¾—å¤ªéš¾äº†ï¼Ÿ
â†’ æš‚åœæ¸¸æˆ
â†’ åˆ‡æ¢åˆ°ç®€å•æ¨¡å¼
â†’ ç»§ç»­ç©

æ¸¸æˆè¿˜æ˜¯é‚£ä¸ªæ¸¸æˆï¼Œä½†ç­–ç•¥å˜äº†ï¼
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| ç­–ç•¥æ¨¡å¼æ¦‚å¿µ | å‰ç«¯ç±»æ¯” | å°æœ‹å‹ç±»æ¯” |
|-------------|---------|-----------|
| ç­–ç•¥æ¥å£ | ValidationStrategy / Renderer | äº¤é€šæ–¹å¼çš„å…±åŒç‰¹ç‚¹ï¼ˆèƒ½åˆ°å­¦æ ¡ï¼‰|
| å…·ä½“ç­–ç•¥ | EmailValidation / JSONParser | èµ°è·¯ / éª‘è½¦ / åå…¬äº¤ |
| ä¸Šä¸‹æ–‡ | FormField / Component | ä½ ï¼ˆé€‰æ‹©äº¤é€šæ–¹å¼çš„äººï¼‰|
| è¿è¡Œæ—¶åˆ‡æ¢ | setValidation() / setTheme() | ä»Šå¤©èµ°è·¯ï¼Œæ˜å¤©éª‘è½¦ |
| ç­–ç•¥ vs æ¨¡æ¿æ–¹æ³• | ç»„åˆ vs ç»§æ‰¿ | æ¢å¸®æ‰‹ vs ä½ è‡ªå·±å˜ |
| å§”æ‰˜æ‰§è¡Œ | strategy.validate(value) | è®©å¸®æ‰‹åšäº‹ |
| ç­–ç•¥å·¥å‚ | createValidator(type) | äº¤é€šå·¥å…·ç§Ÿèµåº— |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸€æ ·çš„ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- **æ¨¡æ¿æ–¹æ³•**ï¼šç”¨**ç»§æ‰¿**ï¼Œéª¨æ¶å›ºå®šï¼Œå­ç±»å®ç°**éƒ¨åˆ†æ­¥éª¤**
- **ç­–ç•¥æ¨¡å¼**ï¼šç”¨**ç»„åˆ**ï¼Œ**æ•´ä¸ªç®—æ³•**å¯æ›¿æ¢
- ä¸€ä¸ªæ˜¯"æˆ‘æ¥æ§åˆ¶æµç¨‹ï¼Œä½ å®ç°ç»†èŠ‚"
- ä¸€ä¸ªæ˜¯"æˆ‘å§”æ‰˜ç»™ä½ ï¼Œä½ å…¨æƒè´Ÿè´£"

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
ä¸¤è€…éƒ½æ¶‰åŠ"å¯å˜çš„è¡Œä¸º"ï¼Œéƒ½ä½¿ç”¨äº†å¤šæ€ã€‚ä½†æœ¬è´¨åŒºåˆ«åœ¨äºï¼šæ¨¡æ¿æ–¹æ³•æ˜¯"ç™½ç›’å¤ç”¨"ï¼ˆå­ç±»çŸ¥é“çˆ¶ç±»çš„æµç¨‹ï¼‰ï¼Œç­–ç•¥æ¨¡å¼æ˜¯"é»‘ç›’å¤ç”¨"ï¼ˆä¸Šä¸‹æ–‡ä¸å…³å¿ƒç­–ç•¥æ€ä¹ˆå®ç°ï¼‰ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```python
# æ¨¡æ¿æ–¹æ³•ï¼šç»§æ‰¿ï¼Œéª¨æ¶å›ºå®š
class BaseChatModel(ABC):
    def invoke(self, input):
        # éª¨æ¶å›ºå®šï¼Œå­ç±»æ— æ³•æ”¹å˜è¿™ä¸ªæµç¨‹
        self._validate(input)
        result = self._generate(input)  # åªæœ‰è¿™ä¸€æ­¥å¯å˜
        return self._format(result)

    @abstractmethod
    def _generate(self, input): pass  # å­ç±»å®ç°éƒ¨åˆ†æ­¥éª¤

# ç­–ç•¥æ¨¡å¼ï¼šç»„åˆï¼Œæ•´ä¸ªç®—æ³•å¯æ›¿æ¢
class Chain:
    def __init__(self, llm: Runnable):
        self.llm = llm  # æŒæœ‰ç­–ç•¥

    def run(self, input):
        return self.llm.invoke(input)  # æ•´ä¸ªè°ƒç”¨å§”æ‰˜ç»™ç­–ç•¥

    def swap_llm(self, new_llm: Runnable):
        self.llm = new_llm  # è¿è¡Œæ—¶æ¢æ‰æ•´ä¸ªç­–ç•¥ï¼

# å…³é”®åŒºåˆ«ï¼š
# æ¨¡æ¿æ–¹æ³•ï¼šChatOpenAI ç»§æ‰¿ BaseChatModelï¼Œåªèƒ½è¦†ç›– _generate
# ç­–ç•¥æ¨¡å¼ï¼šChain å¯ä»¥æ¢æ‰æ•´ä¸ª llmï¼Œä¸ä»…æ˜¯æŸä¸ªæ–¹æ³•

# LangChain ä¸¤è€…éƒ½ç”¨ï¼š
# - BaseChatModel å†…éƒ¨ç”¨æ¨¡æ¿æ–¹æ³•ï¼ˆinvoke æµç¨‹å›ºå®šï¼‰
# - Chain ç”¨ç­–ç•¥æ¨¡å¼ç»„åˆ LLMï¼ˆLLM å¯æ•´ä½“æ›¿æ¢ï¼‰
```

---

### è¯¯åŒº2ï¼šç­–ç•¥æ¨¡å¼éœ€è¦å¾ˆå¤š if-else æ¥é€‰æ‹©ç­–ç•¥ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- ç­–ç•¥æ¨¡å¼çš„ç›®çš„å°±æ˜¯**æ¶ˆé™¤** if-else
- if-else åªåœ¨**åˆ›å»ºç­–ç•¥æ—¶**å‡ºç°ä¸€æ¬¡ï¼Œä¹‹åå°±æ˜¯å¤šæ€è°ƒç”¨
- å¯ä»¥ç”¨å·¥å‚æˆ–æ³¨å†Œè¡¨è¿›ä¸€æ­¥æ¶ˆé™¤åˆ›å»ºæ—¶çš„ if-else

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
å› ä¸ºæ€»è¦åœ¨æŸä¸ªåœ°æ–¹å†³å®šç”¨å“ªä¸ªç­–ç•¥ï¼Œä»¥ä¸ºè¿™å°±éœ€è¦ if-elseã€‚ä½†è¿™ä¸ªå†³å®šå¯ä»¥ï¼š
1. ä»é…ç½®è¯»å–
2. ä»ç”¨æˆ·è¾“å…¥è·å–
3. ç”¨å·¥å‚/æ³¨å†Œè¡¨æ˜ å°„

**æ­£ç¡®ç†è§£ï¼š**

```python
# âŒ é”™è¯¯ï¼šä¸šåŠ¡ä»£ç é‡Œç”¨ if-else
def process(data, strategy_name):
    if strategy_name == "a":
        strategy = StrategyA()
    elif strategy_name == "b":
        strategy = StrategyB()
    elif strategy_name == "c":
        strategy = StrategyC()
    return strategy.execute(data)

# âœ… æ­£ç¡®ï¼šç”¨æ³¨å†Œè¡¨æ¶ˆé™¤ if-else
class StrategyRegistry:
    _strategies = {
        "a": StrategyA,
        "b": StrategyB,
        "c": StrategyC,
    }

    @classmethod
    def get(cls, name: str) -> Strategy:
        return cls._strategies[name]()

def process(data, strategy_name):
    strategy = StrategyRegistry.get(strategy_name)  # æ—  if-else
    return strategy.execute(data)

# âœ… æ›´å¥½ï¼šç›´æ¥æ³¨å…¥ç­–ç•¥
def process(data, strategy: Strategy):  # ä¸å…³å¿ƒæ˜¯å“ªä¸ªç­–ç•¥
    return strategy.execute(data)

# åœ¨ç¨‹åºå…¥å£æˆ–é…ç½®å±‚å†³å®šç”¨å“ªä¸ªç­–ç•¥
config = load_config()
strategy = StrategyRegistry.get(config["strategy"])
process(data, strategy)  # ä¸šåŠ¡ä»£ç å®Œå…¨ä¸çŸ¥é“å…·ä½“ç­–ç•¥
```

---

### è¯¯åŒº3ï¼šç­–ç•¥æ¨¡å¼åªèƒ½ç”¨äº"ç®—æ³•" âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**
- "ç­–ç•¥"ä¸ä»…æŒ‡æ’åºã€æœç´¢ç­‰ä¼ ç»Ÿç®—æ³•
- ä»»ä½•"å¯æ›¿æ¢çš„è¡Œä¸º"éƒ½å¯ä»¥ç”¨ç­–ç•¥æ¨¡å¼
- æ•°æ®åº“è®¿é—®ã€æ—¥å¿—è®°å½•ã€ç¼“å­˜ã€éªŒè¯...éƒ½å¯ä»¥æ˜¯ç­–ç•¥

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**
å› ä¸ºç­–ç•¥æ¨¡å¼æœ€åˆçš„ä¾‹å­éƒ½æ˜¯æ’åºç®—æ³•ã€‚ä½†"ç­–ç•¥"æ˜¯ä¸€ä¸ªå¹¿ä¹‰çš„æ¦‚å¿µï¼Œä»»ä½•éœ€è¦"å¯æ’æ‹”"çš„è¡Œä¸ºéƒ½é€‚ç”¨ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```python
# ç­–ç•¥ä¸ä»…æ˜¯"ç®—æ³•"ï¼Œè€Œæ˜¯"å¯æ›¿æ¢çš„è¡Œä¸º"

# 1. æ—¥å¿—ç­–ç•¥
class LogStrategy(ABC):
    @abstractmethod
    def log(self, message: str): pass

class ConsoleLog(LogStrategy):
    def log(self, message): print(message)

class FileLog(LogStrategy):
    def log(self, message):
        with open("app.log", "a") as f:
            f.write(message + "\n")

# 2. ç¼“å­˜ç­–ç•¥
class CacheStrategy(ABC):
    @abstractmethod
    def get(self, key: str): pass

    @abstractmethod
    def set(self, key: str, value): pass

class MemoryCache(CacheStrategy): ...
class RedisCache(CacheStrategy): ...
class NoCache(CacheStrategy): ...

# 3. è®¤è¯ç­–ç•¥
class AuthStrategy(ABC):
    @abstractmethod
    def authenticate(self, credentials): pass

class JWTAuth(AuthStrategy): ...
class OAuth2Auth(AuthStrategy): ...
class APIKeyAuth(AuthStrategy): ...

# 4. LangChain ä¸­çš„å„ç§"ç­–ç•¥"
# - LLM: OpenAI, Anthropic, Local (éƒ½æ˜¯è°ƒç”¨ç­–ç•¥)
# - Memory: Buffer, Window, Summary (éƒ½æ˜¯å­˜å‚¨ç­–ç•¥)
# - Retriever: Vector, Keyword, Hybrid (éƒ½æ˜¯æ£€ç´¢ç­–ç•¥)
# - Parser: JSON, List, Pydantic (éƒ½æ˜¯è§£æç­–ç•¥)
```

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

```python
"""
ç¤ºä¾‹ï¼šæ„å»º LangChain é£æ ¼çš„ç­–ç•¥æ¨¡å¼ç³»ç»Ÿ
æ¼”ç¤ºç­–ç•¥æ¨¡å¼åœ¨ LLM åº”ç”¨æ¡†æ¶ä¸­çš„æ ¸å¿ƒç”¨æ³•
"""

from abc import ABC, abstractmethod
from typing import Any, Dict, List, Optional, Generator, Callable
from dataclasses import dataclass
import time
import json

# ===== 1. å®šä¹‰ç­–ç•¥æ¥å£ =====
print("=== 1. å®šä¹‰ç­–ç•¥æ¥å£ ===")

class LLMStrategy(ABC):
    """
    LLM ç­–ç•¥æ¥å£ - ç±»ä¼¼ LangChain çš„ Runnable

    å®šä¹‰äº†æ‰€æœ‰ LLM å¿…é¡»å®ç°çš„æ–¹æ³•
    """

    @property
    @abstractmethod
    def model_name(self) -> str:
        """æ¨¡å‹åç§°"""
        pass

    @abstractmethod
    def invoke(self, prompt: str) -> str:
        """åŒæ­¥è°ƒç”¨"""
        pass

    @abstractmethod
    def stream(self, prompt: str) -> Generator[str, None, None]:
        """æµå¼è°ƒç”¨"""
        pass

class OutputParserStrategy(ABC):
    """è¾“å‡ºè§£æç­–ç•¥æ¥å£"""

    @abstractmethod
    def parse(self, text: str) -> Any:
        pass

class RetrieverStrategy(ABC):
    """æ£€ç´¢ç­–ç•¥æ¥å£"""

    @abstractmethod
    def retrieve(self, query: str, top_k: int = 3) -> List[Dict]:
        pass

# ===== 2. å®ç°å…·ä½“ç­–ç•¥ =====
print("\n=== 2. å®ç°å…·ä½“ç­–ç•¥ ===")

class FakeOpenAI(LLMStrategy):
    """æ¨¡æ‹Ÿ OpenAI ç­–ç•¥"""

    def __init__(self, model: str = "gpt-4", temperature: float = 0.7):
        self._model = model
        self.temperature = temperature

    @property
    def model_name(self) -> str:
        return f"openai:{self._model}"

    def invoke(self, prompt: str) -> str:
        time.sleep(0.05)  # æ¨¡æ‹Ÿå»¶è¿Ÿ
        return f"[{self._model}] I'm a helpful AI assistant. Your question: {prompt}"

    def stream(self, prompt: str) -> Generator[str, None, None]:
        response = self.invoke(prompt)
        for word in response.split():
            time.sleep(0.02)
            yield word + " "

class FakeAnthropic(LLMStrategy):
    """æ¨¡æ‹Ÿ Anthropic Claude ç­–ç•¥"""

    def __init__(self, model: str = "claude-3-opus"):
        self._model = model

    @property
    def model_name(self) -> str:
        return f"anthropic:{self._model}"

    def invoke(self, prompt: str) -> str:
        time.sleep(0.05)
        return f"[{self._model}] Let me think about this carefully. Question: {prompt}"

    def stream(self, prompt: str) -> Generator[str, None, None]:
        response = self.invoke(prompt)
        for char in response:
            time.sleep(0.005)
            yield char

class FakeLocalLLM(LLMStrategy):
    """æ¨¡æ‹Ÿæœ¬åœ° LLM ç­–ç•¥"""

    def __init__(self, model_path: str = "llama-7b"):
        self._model = model_path

    @property
    def model_name(self) -> str:
        return f"local:{self._model}"

    def invoke(self, prompt: str) -> str:
        return f"[Local {self._model}] Processing: {prompt[:50]}..."

    def stream(self, prompt: str) -> Generator[str, None, None]:
        yield self.invoke(prompt)

# è¾“å‡ºè§£æå™¨ç­–ç•¥
class JSONParser(OutputParserStrategy):
    """JSON è§£æç­–ç•¥"""

    def parse(self, text: str) -> Dict:
        try:
            start = text.find("{")
            end = text.rfind("}") + 1
            if start != -1 and end > start:
                return json.loads(text[start:end])
        except:
            pass
        return {"raw": text, "parsed": False}

class ListParser(OutputParserStrategy):
    """åˆ—è¡¨è§£æç­–ç•¥"""

    def parse(self, text: str) -> List[str]:
        lines = [line.strip() for line in text.split("\n")]
        return [line for line in lines if line and not line.startswith("[")]

# æ£€ç´¢ç­–ç•¥
class KeywordRetriever(RetrieverStrategy):
    """å…³é”®è¯æ£€ç´¢ç­–ç•¥"""

    def __init__(self, documents: List[str]):
        self.documents = documents

    def retrieve(self, query: str, top_k: int = 3) -> List[Dict]:
        query_lower = query.lower()
        results = []
        for i, doc in enumerate(self.documents):
            if query_lower in doc.lower():
                results.append({"id": i, "content": doc, "score": 1.0})
        return results[:top_k]

class VectorRetriever(RetrieverStrategy):
    """å‘é‡æ£€ç´¢ç­–ç•¥ï¼ˆæ¨¡æ‹Ÿï¼‰"""

    def __init__(self, documents: List[str]):
        self.documents = documents

    def retrieve(self, query: str, top_k: int = 3) -> List[Dict]:
        # æ¨¡æ‹Ÿå‘é‡ç›¸ä¼¼åº¦ï¼ˆå®é™…ç”¨ embeddingï¼‰
        results = []
        for i, doc in enumerate(self.documents):
            # ç®€å•æ¨¡æ‹Ÿï¼šå­—ç¬¦é‡å ç‡ä½œä¸ºç›¸ä¼¼åº¦
            overlap = len(set(query.lower()) & set(doc.lower()))
            score = overlap / max(len(set(query)), 1)
            results.append({"id": i, "content": doc, "score": score})
        results.sort(key=lambda x: x["score"], reverse=True)
        return results[:top_k]

print("å…·ä½“ç­–ç•¥å·²å®šä¹‰ï¼šFakeOpenAI, FakeAnthropic, FakeLocalLLM")
print("è§£æå™¨ç­–ç•¥ï¼šJSONParser, ListParser")
print("æ£€ç´¢ç­–ç•¥ï¼šKeywordRetriever, VectorRetriever")

# ===== 3. ç­–ç•¥æ³¨å†Œè¡¨ =====
print("\n=== 3. ç­–ç•¥æ³¨å†Œè¡¨ ===")

class LLMRegistry:
    """LLM ç­–ç•¥æ³¨å†Œè¡¨"""

    _strategies: Dict[str, type] = {}

    @classmethod
    def register(cls, name: str):
        """è£…é¥°å™¨ï¼šæ³¨å†Œç­–ç•¥"""
        def decorator(strategy_class):
            cls._strategies[name] = strategy_class
            return strategy_class
        return decorator

    @classmethod
    def create(cls, name: str, **kwargs) -> LLMStrategy:
        """åˆ›å»ºç­–ç•¥å®ä¾‹"""
        if name not in cls._strategies:
            raise ValueError(f"Unknown LLM: {name}")
        return cls._strategies[name](**kwargs)

    @classmethod
    def list_available(cls) -> List[str]:
        return list(cls._strategies.keys())

# æ³¨å†Œç­–ç•¥
LLMRegistry._strategies = {
    "openai": FakeOpenAI,
    "anthropic": FakeAnthropic,
    "local": FakeLocalLLM,
}

print(f"å·²æ³¨å†Œçš„ LLM: {LLMRegistry.list_available()}")

# ===== 4. ä¸Šä¸‹æ–‡ç±»ï¼šChatBot =====
print("\n=== 4. ä¸Šä¸‹æ–‡ç±»ï¼šChatBot ===")

class ChatBot:
    """
    èŠå¤©æœºå™¨äºº - ä¸Šä¸‹æ–‡ç±»

    æŒæœ‰ LLM ç­–ç•¥ï¼Œå¯è¿è¡Œæ—¶åˆ‡æ¢
    """

    def __init__(
        self,
        llm: LLMStrategy,
        parser: Optional[OutputParserStrategy] = None,
        retriever: Optional[RetrieverStrategy] = None
    ):
        self._llm = llm
        self._parser = parser
        self._retriever = retriever
        self._history: List[str] = []

    # ç­–ç•¥çš„ getter/setter
    @property
    def llm(self) -> LLMStrategy:
        return self._llm

    @llm.setter
    def llm(self, strategy: LLMStrategy):
        print(f"  [åˆ‡æ¢ LLM] {self._llm.model_name} â†’ {strategy.model_name}")
        self._llm = strategy

    @property
    def parser(self) -> Optional[OutputParserStrategy]:
        return self._parser

    @parser.setter
    def parser(self, strategy: OutputParserStrategy):
        self._parser = strategy

    @property
    def retriever(self) -> Optional[RetrieverStrategy]:
        return self._retriever

    @retriever.setter
    def retriever(self, strategy: RetrieverStrategy):
        self._retriever = strategy

    # ä¸šåŠ¡æ–¹æ³•
    def chat(self, message: str) -> str:
        """èŠå¤©ï¼ˆå§”æ‰˜ç»™ LLM ç­–ç•¥ï¼‰"""
        # å¦‚æœæœ‰æ£€ç´¢å™¨ï¼Œå…ˆæ£€ç´¢
        context = ""
        if self._retriever:
            docs = self._retriever.retrieve(message)
            if docs:
                context = "Context:\n" + "\n".join(d["content"] for d in docs) + "\n\n"

        # æ„å»º prompt
        prompt = f"{context}User: {message}\nAssistant:"

        # è°ƒç”¨ LLMï¼ˆå§”æ‰˜ï¼‰
        response = self._llm.invoke(prompt)

        # è§£æè¾“å‡ºï¼ˆå¦‚æœæœ‰è§£æå™¨ï¼‰
        if self._parser:
            response = str(self._parser.parse(response))

        self._history.append(f"User: {message}")
        self._history.append(f"Assistant: {response}")

        return response

    def stream_chat(self, message: str) -> Generator[str, None, None]:
        """æµå¼èŠå¤©"""
        prompt = f"User: {message}\nAssistant:"
        for chunk in self._llm.stream(prompt):
            yield chunk

    def get_model_info(self) -> str:
        return f"å½“å‰æ¨¡å‹: {self._llm.model_name}"

# ===== 5. æ¼”ç¤ºç­–ç•¥æ¨¡å¼ =====
print("\n=== 5. æ¼”ç¤ºç­–ç•¥æ¨¡å¼ ===")

# åˆ›å»º ChatBotï¼Œåˆå§‹ä½¿ç”¨ OpenAI
bot = ChatBot(llm=FakeOpenAI())
print(f"åˆå§‹çŠ¶æ€: {bot.get_model_info()}")
print(f"å›å¤: {bot.chat('Hello!')}\n")

# è¿è¡Œæ—¶åˆ‡æ¢åˆ° Claude
bot.llm = FakeAnthropic()
print(f"å›å¤: {bot.chat('Hello again!')}\n")

# å†åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å‹
bot.llm = FakeLocalLLM()
print(f"å›å¤: {bot.chat('One more time!')}\n")

# ===== 6. ä½¿ç”¨æ³¨å†Œè¡¨åˆ›å»ºç­–ç•¥ =====
print("=== 6. ä½¿ç”¨æ³¨å†Œè¡¨åˆ›å»ºç­–ç•¥ ===")

config = {"provider": "openai", "model": "gpt-4-turbo"}
llm = LLMRegistry.create(config["provider"], model=config.get("model", "gpt-4"))
print(f"ä»é…ç½®åˆ›å»º: {llm.model_name}")
print(f"å›å¤: {llm.invoke('Test')}\n")

# ===== 7. ç»„åˆå¤šä¸ªç­–ç•¥ =====
print("=== 7. ç»„åˆå¤šä¸ªç­–ç•¥ ===")

# å‡†å¤‡æ–‡æ¡£
documents = [
    "Python is a programming language created by Guido van Rossum.",
    "LangChain is a framework for building LLM applications.",
    "Strategy pattern allows runtime algorithm switching.",
]

# åˆ›å»ºå¸¦æœ‰å¤šä¸ªç­–ç•¥çš„ ChatBot
bot = ChatBot(
    llm=FakeOpenAI(),
    parser=JSONParser(),
    retriever=KeywordRetriever(documents)
)

print("ChatBot é…ç½®:")
print(f"  - LLM: {bot.llm.model_name}")
print(f"  - Parser: {type(bot.parser).__name__}")
print(f"  - Retriever: {type(bot.retriever).__name__}")
print()

# æŸ¥è¯¢ï¼ˆä¼šå…ˆæ£€ç´¢ï¼Œå†è°ƒç”¨ LLMï¼‰
result = bot.chat("Tell me about LangChain")
print(f"å›å¤: {result}\n")

# åˆ‡æ¢æ£€ç´¢ç­–ç•¥
bot.retriever = VectorRetriever(documents)
print(f"åˆ‡æ¢æ£€ç´¢å™¨: {type(bot.retriever).__name__}")
result = bot.chat("Python programming")
print(f"å›å¤: {result}\n")

# ===== 8. æµå¼è¾“å‡º =====
print("=== 8. æµå¼è¾“å‡º ===")

bot = ChatBot(llm=FakeAnthropic())
print("æµå¼è¾“å‡º: ", end="")
for chunk in bot.stream_chat("Stream test"):
    print(chunk, end="", flush=True)
print("\n")

# ===== 9. ç­–ç•¥å·¥å‚ =====
print("=== 9. ç­–ç•¥å·¥å‚ ===")

class LLMFactory:
    """LLM ç­–ç•¥å·¥å‚"""

    @staticmethod
    def create_for_task(task: str) -> LLMStrategy:
        """æ ¹æ®ä»»åŠ¡ç±»å‹åˆ›å»ºåˆé€‚çš„ LLM"""
        task_mapping = {
            "chat": FakeOpenAI(model="gpt-4"),
            "code": FakeAnthropic(model="claude-3-opus"),
            "fast": FakeOpenAI(model="gpt-3.5-turbo"),
            "local": FakeLocalLLM(),
        }
        return task_mapping.get(task, FakeOpenAI())

    @staticmethod
    def create_cheapest() -> LLMStrategy:
        """åˆ›å»ºæœ€ä¾¿å®œçš„ LLM"""
        return FakeLocalLLM()

    @staticmethod
    def create_best() -> LLMStrategy:
        """åˆ›å»ºæœ€å¼ºçš„ LLM"""
        return FakeAnthropic(model="claude-3-opus")

# ä½¿ç”¨å·¥å‚
print("æ ¹æ®ä»»åŠ¡é€‰æ‹© LLM:")
for task in ["chat", "code", "fast", "local"]:
    llm = LLMFactory.create_for_task(task)
    print(f"  ä»»åŠ¡ '{task}' â†’ {llm.model_name}")

# ===== 10. ä¸æ¨¡æ¿æ–¹æ³•çš„å¯¹æ¯” =====
print("\n=== 10. ç­–ç•¥æ¨¡å¼ vs æ¨¡æ¿æ–¹æ³•æ¨¡å¼ ===")

print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç‰¹æ€§        â”‚     æ¨¡æ¿æ–¹æ³•æ¨¡å¼      â”‚     ç­–ç•¥æ¨¡å¼         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯å˜ç²’åº¦        â”‚ ç®—æ³•çš„éƒ¨åˆ†æ­¥éª¤       â”‚ æ•´ä¸ªç®—æ³•             â”‚
â”‚ å®ç°æ–¹å¼        â”‚ ç»§æ‰¿                â”‚ ç»„åˆ                 â”‚
â”‚ è¿è¡Œæ—¶åˆ‡æ¢      â”‚ ä¸æ”¯æŒ              â”‚ æ”¯æŒ                 â”‚
â”‚ ä»£ç å¤ç”¨        â”‚ é€šè¿‡ç»§æ‰¿            â”‚ é€šè¿‡å§”æ‰˜             â”‚
â”‚ å…¸å‹ç»“æ„        â”‚ çˆ¶ç±».invoke()       â”‚ ä¸Šä¸‹æ–‡.strategy      â”‚
â”‚                â”‚   â†’ å­ç±»._call()    â”‚   â†’ ç­–ç•¥.execute()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœ¨ LangChain ä¸­ï¼š
- æ¨¡æ¿æ–¹æ³•ï¼šBaseChatModel.invoke() â†’ _generate()
- ç­–ç•¥æ¨¡å¼ï¼šChain æŒæœ‰ LLMï¼Œå¯ä»¥åˆ‡æ¢

ä¸¤è€…ç»å¸¸é…åˆä½¿ç”¨ï¼š
- BaseChatModel å†…éƒ¨ç”¨æ¨¡æ¿æ–¹æ³•ï¼ˆå®šä¹‰ invoke æµç¨‹ï¼‰
- Chain ç”¨ç­–ç•¥æ¨¡å¼ç»„åˆä¸åŒçš„ BaseChatModel
""")

print("\n=== å®Œæˆ ===")
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**
```
=== 1. å®šä¹‰ç­–ç•¥æ¥å£ ===

=== 2. å®ç°å…·ä½“ç­–ç•¥ ===
å…·ä½“ç­–ç•¥å·²å®šä¹‰ï¼šFakeOpenAI, FakeAnthropic, FakeLocalLLM
è§£æå™¨ç­–ç•¥ï¼šJSONParser, ListParser
æ£€ç´¢ç­–ç•¥ï¼šKeywordRetriever, VectorRetriever

=== 3. ç­–ç•¥æ³¨å†Œè¡¨ ===
å·²æ³¨å†Œçš„ LLM: ['openai', 'anthropic', 'local']

=== 4. ä¸Šä¸‹æ–‡ç±»ï¼šChatBot ===

=== 5. æ¼”ç¤ºç­–ç•¥æ¨¡å¼ ===
åˆå§‹çŠ¶æ€: å½“å‰æ¨¡å‹: openai:gpt-4
å›å¤: [gpt-4] I'm a helpful AI assistant. Your question: User: Hello!
Assistant:

  [åˆ‡æ¢ LLM] openai:gpt-4 â†’ anthropic:claude-3-opus
å›å¤: [claude-3-opus] Let me think about this carefully. Question: User: Hello again!
Assistant:

  [åˆ‡æ¢ LLM] anthropic:claude-3-opus â†’ local:llama-7b
å›å¤: [Local llama-7b] Processing: User: One more time!
Assistant:...

=== 6. ä½¿ç”¨æ³¨å†Œè¡¨åˆ›å»ºç­–ç•¥ ===
ä»é…ç½®åˆ›å»º: openai:gpt-4-turbo
å›å¤: [gpt-4-turbo] I'm a helpful AI assistant. Your question: Test

=== 7. ç»„åˆå¤šä¸ªç­–ç•¥ ===
ChatBot é…ç½®:
  - LLM: openai:gpt-4
  - Parser: JSONParser
  - Retriever: KeywordRetriever

å›å¤: {'raw': '[gpt-4] I\'m a helpful AI assistant...', 'parsed': False}

åˆ‡æ¢æ£€ç´¢å™¨: VectorRetriever
å›å¤: {'raw': '[gpt-4] I\'m a helpful AI assistant...', 'parsed': False}

=== 8. æµå¼è¾“å‡º ===
æµå¼è¾“å‡º: [claude-3-opus] Let me think about this carefully...

=== 9. ç­–ç•¥å·¥å‚ ===
æ ¹æ®ä»»åŠ¡é€‰æ‹© LLM:
  ä»»åŠ¡ 'chat' â†’ openai:gpt-4
  ä»»åŠ¡ 'code' â†’ anthropic:claude-3-opus
  ä»»åŠ¡ 'fast' â†’ openai:gpt-3.5-turbo
  ä»»åŠ¡ 'local' â†’ local:llama-7b

=== 10. ç­–ç•¥æ¨¡å¼ vs æ¨¡æ¿æ–¹æ³•æ¨¡å¼ ===
...

=== å®Œæˆ ===
```

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"ä»€ä¹ˆæ˜¯ç­–ç•¥æ¨¡å¼ï¼Ÿä»€ä¹ˆæ—¶å€™åº”è¯¥ç”¨ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"ç­–ç•¥æ¨¡å¼å°±æ˜¯æŠŠç®—æ³•å°è£…æˆä¸åŒçš„ç±»ï¼Œå¯ä»¥äº’ç›¸æ›¿æ¢ã€‚å½“æœ‰å¤šä¸ªç®—æ³•çš„æ—¶å€™å°±ç”¨ç­–ç•¥æ¨¡å¼ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **ç­–ç•¥æ¨¡å¼æœ‰ä¸‰å±‚ç†è§£ï¼š**
>
> 1. **å®šä¹‰å±‚é¢**ï¼š
>    - ç­–ç•¥æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªç®—æ³•æ—ï¼Œå°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥äº’ç›¸æ›¿æ¢
>    - æ ¸å¿ƒæ˜¯"å°è£…å˜åŒ–"â€”â€”æŠŠå˜åŒ–çš„éƒ¨åˆ†ï¼ˆç®—æ³•ï¼‰æŠ½å‡ºæ¥
>
> 2. **ç»“æ„å±‚é¢**ï¼š
>    - **ç­–ç•¥æ¥å£**ï¼šå®šä¹‰ç®—æ³•çš„å…¬å…±å¥‘çº¦
>    - **å…·ä½“ç­–ç•¥**ï¼šå®ç°ä¸åŒçš„ç®—æ³•
>    - **ä¸Šä¸‹æ–‡**ï¼šæŒæœ‰ç­–ç•¥å¼•ç”¨ï¼Œå§”æ‰˜æ‰§è¡Œ
>
> 3. **ä½¿ç”¨åœºæ™¯**ï¼š
>    - å½“æœ‰å¤šä¸ªç›¸ä¼¼çš„ç®—æ³•ï¼Œéœ€è¦åŠ¨æ€é€‰æ‹©
>    - å½“éœ€è¦**è¿è¡Œæ—¶åˆ‡æ¢**ç®—æ³•ï¼ˆç­–ç•¥æ¨¡å¼ç‹¬æœ‰ä¼˜åŠ¿ï¼‰
>    - å½“æƒ³é¿å…å¤§é‡çš„ if-else æ¡ä»¶åˆ¤æ–­
>    - å½“ç®—æ³•éœ€è¦ç‹¬ç«‹äºä½¿ç”¨å®ƒçš„å®¢æˆ·ç«¯å˜åŒ–
>
> **åœ¨ LangChain ä¸­çš„å®é™…åº”ç”¨**ï¼š
> ```python
> # LLM å°±æ˜¯ç­–ç•¥
> class Chain:
>     def __init__(self, llm: Runnable):  # ç­–ç•¥æ³¨å…¥
>         self.llm = llm
>
>     def run(self, input):
>         return self.llm.invoke(input)  # å§”æ‰˜
>
> # è¿è¡Œæ—¶åˆ‡æ¢ LLM
> chain.llm = ChatOpenAI()
> chain.llm = ChatAnthropic()  # æ— éœ€æ”¹ä»£ç ï¼Œç›´æ¥æ¢ï¼
> ```
>
> **ä¸æ¨¡æ¿æ–¹æ³•çš„åŒºåˆ«**ï¼š
> - æ¨¡æ¿æ–¹æ³•ï¼šç»§æ‰¿ï¼Œéª¨æ¶å›ºå®šï¼Œéƒ¨åˆ†æ­¥éª¤å¯å˜
> - ç­–ç•¥æ¨¡å¼ï¼šç»„åˆï¼Œæ•´ä¸ªç®—æ³•å¯æ›¿æ¢ï¼Œæ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… å¤šå±‚æ¬¡è§£é‡Šï¼ˆå®šä¹‰/ç»“æ„/åœºæ™¯ï¼‰
2. âœ… ç”¨ LangChain çœŸå®ä»£ç ä¸¾ä¾‹
3. âœ… å¼ºè°ƒ"è¿è¡Œæ—¶åˆ‡æ¢"è¿™ä¸ªæ ¸å¿ƒä¼˜åŠ¿
4. âœ… å¯¹æ¯”ç›¸å…³æ¨¡å¼

---

### é—®é¢˜2ï¼š"ç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„åŒºåˆ«ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸ªï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**
"ç­–ç•¥æ¨¡å¼ç”¨ç»„åˆï¼Œæ¨¡æ¿æ–¹æ³•ç”¨ç»§æ‰¿ã€‚ä¸€èˆ¬ä¼˜å…ˆç”¨ç­–ç•¥æ¨¡å¼ï¼Œå› ä¸ºç»„åˆæ›´çµæ´»ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **ä¸¤è€…è§£å†³ä¸åŒçš„é—®é¢˜ï¼š**
>
> | å¯¹æ¯”ç»´åº¦ | æ¨¡æ¿æ–¹æ³• | ç­–ç•¥æ¨¡å¼ |
> |---------|---------|---------|
> | å¯å˜ç²’åº¦ | ç®—æ³•çš„**æŸäº›æ­¥éª¤**å¯å˜ | **æ•´ä¸ªç®—æ³•**å¯æ›¿æ¢ |
> | å®ç°æ–¹å¼ | ç»§æ‰¿ï¼ˆç™½ç›’å¤ç”¨ï¼‰ | ç»„åˆï¼ˆé»‘ç›’å¤ç”¨ï¼‰ |
> | è¿è¡Œæ—¶åˆ‡æ¢ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
> | è°ƒç”¨æ–¹å‘ | çˆ¶ç±»è°ƒç”¨å­ç±» | ä¸Šä¸‹æ–‡å§”æ‰˜ç»™ç­–ç•¥ |
>
> **é€‰æ‹©æ ‡å‡†ï¼š**
>
> **ç”¨æ¨¡æ¿æ–¹æ³•**ï¼š
> - å¤šä¸ªç±»æœ‰**ç›¸åŒçš„æµç¨‹**ï¼Œåªæ˜¯éƒ¨åˆ†æ­¥éª¤ä¸åŒ
> - éœ€è¦**æ§åˆ¶æµç¨‹**ä¸è¢«å­ç±»æ”¹å˜
> - ä¾‹ï¼š`BaseChatModel.invoke()` æµç¨‹å›ºå®šï¼Œ`_generate()` å¯å˜
>
> **ç”¨ç­–ç•¥æ¨¡å¼**ï¼š
> - éœ€è¦åœ¨**è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢**ç®—æ³•
> - ç®—æ³•å®Œå…¨ç‹¬ç«‹ï¼Œå¯ä»¥è‡ªç”±ç»„åˆ
> - ä¾‹ï¼š`Chain` å¯ä»¥éšæ—¶æ¢ `LLM`
>
> **LangChain ä¸­ä¸¤è€…é…åˆä½¿ç”¨**ï¼š
> ```python
> # æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰ invoke æµç¨‹
> class BaseChatModel(ABC):
>     def invoke(self, input):
>         # æµç¨‹å›ºå®š
>         self._validate(input)
>         return self._generate(input)  # å­ç±»å®ç°
>
> # ç­–ç•¥æ¨¡å¼ï¼šLLM å¯æ›¿æ¢
> class Chain:
>     def __init__(self, llm: BaseChatModel):
>         self.llm = llm  # å¯ä»¥æ˜¯ä»»ä½• BaseChatModel
>
>     def run(self, input):
>         return self.llm.invoke(input)
>
> # ä¸¤è€…åä½œï¼š
> # BaseChatModel å†…éƒ¨ç”¨æ¨¡æ¿æ–¹æ³•ä¿è¯ invoke æµç¨‹
> # Chain ç”¨ç­–ç•¥æ¨¡å¼å…è®¸åˆ‡æ¢ä¸åŒçš„ BaseChatModel
> ```
>
> **ç»éªŒæ³•åˆ™**ï¼š
> - å¦‚æœé—®"è¿™ä¸ªæµç¨‹çš„æŸä¸ªæ­¥éª¤æ€ä¹ˆåš" â†’ æ¨¡æ¿æ–¹æ³•
> - å¦‚æœé—®"è¿™ä¸ªä»»åŠ¡ç”¨ä»€ä¹ˆæ–¹å¼å®Œæˆ" â†’ ç­–ç•¥æ¨¡å¼

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šä»€ä¹ˆæ˜¯ç­–ç•¥æ¨¡å¼ ğŸ¯

**ä¸€å¥è¯ï¼š** æŠŠç®—æ³•å°è£…æˆç‹¬ç«‹çš„ç±»ï¼Œä½¿å®ƒä»¬å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚

**ä¸¾ä¾‹ï¼š**
```python
class Strategy(ABC):
    @abstractmethod
    def execute(self, data): pass

class StrategyA(Strategy):
    def execute(self, data): return data.upper()

class StrategyB(Strategy):
    def execute(self, data): return data.lower()
```

**åº”ç”¨ï¼š** LangChain çš„ä¸åŒ LLMï¼ˆOpenAIã€Claudeï¼‰å°±æ˜¯ä¸åŒçš„ç­–ç•¥ã€‚

---

### å¡ç‰‡2ï¼šç­–ç•¥æ¥å£ ğŸ“‹

**ä¸€å¥è¯ï¼š** ç­–ç•¥æ¥å£å®šä¹‰äº†ç®—æ³•æ—çš„å…¬å…±å¥‘çº¦ï¼Œæ‰€æœ‰å…·ä½“ç­–ç•¥éƒ½è¦å®ç°å®ƒã€‚

**ä¸¾ä¾‹ï¼š**
```python
class LLMStrategy(ABC):
    @abstractmethod
    def invoke(self, prompt: str) -> str:
        """æ‰€æœ‰ LLM éƒ½è¦å®ç°è¿™ä¸ªæ–¹æ³•"""
        pass
```

**åº”ç”¨ï¼š** LangChain çš„ `Runnable` å°±æ˜¯ç­–ç•¥æ¥å£ï¼Œå®šä¹‰äº† `invoke`ã€`stream`ã€`batch` æ–¹æ³•ã€‚

---

### å¡ç‰‡3ï¼šå…·ä½“ç­–ç•¥ ğŸ”§

**ä¸€å¥è¯ï¼š** å…·ä½“ç­–ç•¥å®ç°ç­–ç•¥æ¥å£ï¼Œå°è£…å…·ä½“çš„ç®—æ³•å®ç°ã€‚

**ä¸¾ä¾‹ï¼š**
```python
class OpenAIStrategy(LLMStrategy):
    def invoke(self, prompt):
        return self.client.chat(prompt)

class AnthropicStrategy(LLMStrategy):
    def invoke(self, prompt):
        return self.client.messages(prompt)
```

**åº”ç”¨ï¼š** `ChatOpenAI`ã€`ChatAnthropic`ã€`ChatOllama` éƒ½æ˜¯å…·ä½“ç­–ç•¥ã€‚

---

### å¡ç‰‡4ï¼šä¸Šä¸‹æ–‡ç±» ğŸ®

**ä¸€å¥è¯ï¼š** ä¸Šä¸‹æ–‡æŒæœ‰ç­–ç•¥çš„å¼•ç”¨ï¼Œå°†å·¥ä½œå§”æ‰˜ç»™ç­–ç•¥æ‰§è¡Œã€‚

**ä¸¾ä¾‹ï¼š**
```python
class Chain:
    def __init__(self, llm: LLMStrategy):
        self.llm = llm  # æŒæœ‰ç­–ç•¥

    def run(self, input):
        return self.llm.invoke(input)  # å§”æ‰˜
```

**åº”ç”¨ï¼š** LangChain çš„ `Chain`ã€`Agent` éƒ½æ˜¯ä¸Šä¸‹æ–‡ï¼ŒæŒæœ‰ `LLM` ç­–ç•¥ã€‚

---

### å¡ç‰‡5ï¼šè¿è¡Œæ—¶åˆ‡æ¢ ğŸ”„

**ä¸€å¥è¯ï¼š** ç­–ç•¥æ¨¡å¼çš„æ ¸å¿ƒä¼˜åŠ¿â€”â€”å¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€æ›´æ¢ç­–ç•¥ã€‚

**ä¸¾ä¾‹ï¼š**
```python
chain = Chain(llm=OpenAIStrategy())
chain.run("Hello")  # ç”¨ OpenAI

chain.llm = AnthropicStrategy()  # è¿è¡Œæ—¶åˆ‡æ¢ï¼
chain.run("Hello")  # ç”¨ Claude
```

**åº”ç”¨ï¼š** æ ¹æ®ç”¨æˆ·é€‰æ‹©ã€ä»»åŠ¡ç±»å‹ã€æˆæœ¬è€ƒè™‘åŠ¨æ€åˆ‡æ¢ LLMã€‚

---

### å¡ç‰‡6ï¼šç­–ç•¥ vs æ¨¡æ¿æ–¹æ³• âš”ï¸

**ä¸€å¥è¯ï¼š** æ¨¡æ¿æ–¹æ³•ç”¨ç»§æ‰¿å›ºå®šéª¨æ¶ï¼Œç­–ç•¥æ¨¡å¼ç”¨ç»„åˆæ›¿æ¢æ•´ä¸ªç®—æ³•ã€‚

| ç»´åº¦ | æ¨¡æ¿æ–¹æ³• | ç­–ç•¥æ¨¡å¼ |
|------|---------|---------|
| å®ç° | ç»§æ‰¿ | ç»„åˆ |
| å¯å˜ | éƒ¨åˆ†æ­¥éª¤ | æ•´ä¸ªç®—æ³• |
| åˆ‡æ¢ | ä¸æ”¯æŒ | è¿è¡Œæ—¶ |

**åº”ç”¨ï¼š** LangChain å†…éƒ¨ç”¨æ¨¡æ¿æ–¹æ³•ï¼ŒChain ç»„åˆç”¨ç­–ç•¥æ¨¡å¼ã€‚

---

### å¡ç‰‡7ï¼šç­–ç•¥å·¥å‚ ğŸ­

**ä¸€å¥è¯ï¼š** ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºç­–ç•¥ï¼Œé¿å… if-else æ•£è½åœ¨ä»£ç å„å¤„ã€‚

**ä¸¾ä¾‹ï¼š**
```python
class LLMFactory:
    @staticmethod
    def create(provider: str) -> LLMStrategy:
        registry = {
            "openai": OpenAIStrategy,
            "anthropic": AnthropicStrategy,
        }
        return registry[provider]()

llm = LLMFactory.create("openai")
```

**åº”ç”¨ï¼š** æ ¹æ®é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡åˆ›å»ºåˆé€‚çš„ LLMã€‚

---

### å¡ç‰‡8ï¼šLangChain ä¸­çš„ç­–ç•¥æ¨¡å¼ ğŸ¦œ

**ä¸€å¥è¯ï¼š** LangChain å¤§é‡ä½¿ç”¨ç­–ç•¥æ¨¡å¼å®ç°ç»„ä»¶çš„å¯æ’æ‹”ã€‚

**ä¸¾ä¾‹ï¼š**
```python
# ç­–ç•¥æ¨¡å¼çš„åº”ç”¨
LLM: OpenAI, Anthropic, Local  # è°ƒç”¨ç­–ç•¥
Memory: Buffer, Window, Summary  # å­˜å‚¨ç­–ç•¥
Retriever: Vector, Keyword, Hybrid  # æ£€ç´¢ç­–ç•¥
Parser: JSON, List, Pydantic  # è§£æç­–ç•¥
```

**åº”ç”¨ï¼š** ç†è§£è¿™äº›éƒ½æ˜¯ç­–ç•¥ï¼Œå°±ç†è§£äº† LangChain çš„å¯æ‰©å±•æ€§ã€‚

---

### å¡ç‰‡9ï¼šå®ç°è‡ªå®šä¹‰ç­–ç•¥ âœ¨

**ä¸€å¥è¯ï¼š** å®ç°ç­–ç•¥æ¥å£ï¼Œå°±å¯ä»¥æ— ç¼æ¥å…¥ LangChain ç”Ÿæ€ã€‚

**ä¸¾ä¾‹ï¼š**
```python
class MyCustomLLM(Runnable):
    def invoke(self, input):
        # å®ç°è‡ªå·±çš„é€»è¾‘
        return my_custom_api(input)

# æ— ç¼ä½¿ç”¨
chain = prompt | MyCustomLLM() | parser
chain.invoke({"question": "Hello"})
```

**åº”ç”¨ï¼š** åˆ›å»ºè‡ªå®šä¹‰ LLMã€Retrieverã€Parser éƒ½æ˜¯è¿™ä¸ªå¥—è·¯ã€‚

---

### å¡ç‰‡10ï¼šç­–ç•¥æ¨¡å¼æ€»ç»“ â­

**ä¸€å¥è¯ï¼š** å°è£…å˜åŒ–ï¼Œæ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢ï¼Œå®ç°ç®—æ³•çš„å¯æ’æ‹”ã€‚

**æ ¸å¿ƒè¦ç‚¹ï¼š**
1. ç­–ç•¥æ¥å£å®šä¹‰ç®—æ³•å¥‘çº¦
2. å…·ä½“ç­–ç•¥å®ç°ä¸åŒç®—æ³•
3. ä¸Šä¸‹æ–‡æŒæœ‰ç­–ç•¥å¹¶å§”æ‰˜æ‰§è¡Œ
4. æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢
5. ç”¨ç»„åˆä»£æ›¿ç»§æ‰¿

**è®°ä½ï¼š** çœ‹åˆ°"å¯ä»¥æ¢æˆå¦ä¸€ä¸ª"çš„åœºæ™¯ï¼Œå°±æ˜¯ç­–ç•¥æ¨¡å¼ï¼

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**ç­–ç•¥æ¨¡å¼é€šè¿‡å°†ç®—æ³•å°è£…æˆç‹¬ç«‹çš„å¯äº’æ¢ç­–ç•¥ç±»ï¼Œé…åˆä¸Šä¸‹æ–‡çš„å§”æ‰˜è°ƒç”¨ï¼Œå®ç°äº†ç®—æ³•çš„è¿è¡Œæ—¶å¯åˆ‡æ¢ï¼Œæ˜¯ LangChain ä¸­ Chain ç»„åˆä¸åŒ LLMã€Retrieverã€Parser ç­‰ç»„ä»¶çš„æ ¸å¿ƒè®¾è®¡æ¨¡å¼ï¼Œä½¿å¾—æ•´ä¸ªæ¡†æ¶å…·æœ‰é«˜åº¦çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚**

---

## ğŸ“š å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ç­–ç•¥æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³ï¼ˆå°è£…ç®—æ³•+è¿è¡Œæ—¶åˆ‡æ¢ï¼‰
- [ ] èƒ½åŒºåˆ†ç­–ç•¥æ¥å£ã€å…·ä½“ç­–ç•¥ã€ä¸Šä¸‹æ–‡ä¸‰ä¸ªè§’è‰²
- [ ] èƒ½å¤Ÿå®šä¹‰ç­–ç•¥æ¥å£å¹¶å®ç°å…·ä½“ç­–ç•¥
- [ ] èƒ½å¤Ÿåˆ›å»ºä¸Šä¸‹æ–‡ç±»ï¼Œæ­£ç¡®æŒæœ‰å’Œä½¿ç”¨ç­–ç•¥
- [ ] ç†è§£è¿è¡Œæ—¶åˆ‡æ¢ç­–ç•¥çš„å®ç°æ–¹å¼
- [ ] èƒ½å¤Ÿè¯†åˆ« LangChain æºç ä¸­çš„ç­–ç•¥æ¨¡å¼
- [ ] ç†è§£ç­–ç•¥æ¨¡å¼ vs æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„åŒºåˆ«
- [ ] èƒ½å¤Ÿä½¿ç”¨ç­–ç•¥æ¨¡å¼åˆ›å»ºè‡ªå®šä¹‰ LangChain ç»„ä»¶

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- **è´£ä»»é“¾æ¨¡å¼**ï¼šè¯·æ±‚å¤„ç†çš„é“¾å¼ä¼ é€’
- **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šLangChain Callback ç³»ç»Ÿçš„åŸºç¡€
- **å·¥å‚æ¨¡å¼**ï¼šç­–ç•¥çš„åˆ›å»ºå’Œç®¡ç†
- **ä¾èµ–æ³¨å…¥**ï¼šç­–ç•¥æ¨¡å¼çš„æœ€ä½³å®è·µ

---

**ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2025-12-12
